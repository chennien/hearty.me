"use strict";function hj_preview(c,b){var a=$(".hj_preview");null!=b&&a.find("iframe").attr("srcdoc",b),c?a.slideDown("fast"):a.fadeOut("fast")}function get_templates(a){return $.getJSON("templates.json?v"+new Date().toLocaleDateString("sv").replace(/-/g,""),function(b){return null==a?b:a in b&&b[a]})}function get_template(a){get_templates(a).then(function(b){if(b&&a in b){b=b[a];var c=$(".push_data");c.find("[data-sender]").val(b.sender.name),c.find("[data-subject]").val(b.subject),c.find("[data-body]").val(b.body),c.find("[data-tag]").val(b.tag)}})}function get_menu_templates(){get_templates().then(function(a){var c=$("select[data-templates]");for(var b in c.html($("<option>",{selected:""}).text("\u7121")),a)$("<option>",{value:b,text:a[b].name,disabled:parseInt(a[b].format)>0}).appendTo(c)})}function save_template(a){$("<a>",{href:"data:"+(a||"text/plain")+";charset=utf-8,"+encodeURIComponent(tinymce.activeEditor.getContent()||""),download:"\u4FE1\u4EF6\u6A21\u677F_"+new Date().toLocaleDateString("sv")+".html"}).get(0).click(),alertify.success('<i class="fas fa-arrow-to-bottom"></i> \u958B\u59CB\u4E0B\u8F09')}function editor_init(){$(".push_data textarea[data-body]").tinymce({base_url:"https://cdn.jsdelivr.net/npm/tinymce@5.10.5",placeholder:"Email \u5167\u6587",statusbar:!1,branding:!1,save_enablewhendirty:!1,skin:"oxide"+(window.matchMedia("(prefers-color-scheme: dark)").matches?"-dark":""),relative_urls:!1,remove_script_host:!1,height:300,menubar:!1,image_caption:!0,plugins:"autolink preview directionality code visualblocks visualchars fullscreen image link template codesample table charmap toc advlist wordcount imagetools textpattern noneditable charmap emoticons table paste save",toolbar:"code preview fullscreen | undo redo | formatselect bold underline alignjustify aligncenter alignright | forecolor backcolor removeformatk | table image link emoticons | fontsizeselect save",toolbar_drawer:"sliding",link_list:[{title:"\u6EAB\u5EA6\u65E5\u8A18 \u9996\u9801",value:"https://app.hearty.me/hj"},{title:"\u6EAB\u5EA6\u65E5\u8A18 \u7528\u6236\u9801",value:"https://hearty.app/{{username}}"}],image_list:[{title:"\u6EAB\u5EA6\u65E5\u8A18 Logo",value:"https://i.hearty.app/i/mailheader.png?o=1"},{title:"\u6EAB\u5EA6\u65E5\u8A18 Sheara",value:"https://i.hearty.app/e/sheara.640.jpg?o=1"}],color_map:["ffffff","\u6F54\u767D","ffd1a4","\u76AE\u819A","ffdcdc","\u6DE1\u7C89","ffbdbd","\u6DFA\u7C89","f16d6e","\u6DF1\u7D05","d78b7b","\u5361\u5176","d28064","\u5361\u5176","b4b4b4","\u6DFA\u7070","444444","\u6DF1\u7070","000000","\u7D14\u9ED1"],contextmenu:"link",language:"zh_TW",language_url:"//cdn.jsdelivr.net/npm/tinymce-all-in-one@4.9.5/langs/zh_TW.min.js",default_link_target:"_blank",link_default_protocol:"https",paste_retain_style_properties:"all",paste_word_valid_elements:"*[*]",paste_convert_word_fake_lists:!1,paste_webkit_styles:"all",paste_merge_formats:!0,paste_data_images:!0,automatic_uploads:!0,images_upload_url:"../api/mail.img.php",images_upload_credentials:!0,save_onsavecallback:function(){save_template()}})}function richformat(){editor_init(),$("[data-sender_domain]").val("notify.heartymail.com").find("[data-plaintext]").prop("disabled",!0),$("select[data-templates] option").prop("disabled",!1)}function hj_update__push(a){return $.ajax({url:location.href,type:"post",crossDomain:!0,dataType:"json",data:a,async:!0,xhrFields:{withCredentials:!0}})}function get_recipients(){var b=$(".recipients"),a=parseInt($("input[name='uid_selection']:checked").val()||0),c=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),d=$("textarea[data-uid_listed]").val().split(",").map(function(a){return parseInt(a.trim())||1}).sort();b.slideUp("fast"),$(".recipient_data .result").empty(),hj_update__push({action:"get_recipients",uid_interval:0==a?JSON.stringify(c):"",uid_listed:1==a?JSON.stringify(d):"",email_verified:+!$("input[name='email_unverified']").is(":checked"),newsletter_optin:+!$("input[name='newsletter_optout']").is(":checked"),lang:+$("input[name='chinese_only']:checked").length,birthmonth:+$("input[name='birthmonth']:checked").length}).then(function(a){switch(a.Status){case 1:b.html(a.Values.map(function(a){var b=parseInt(a.sent_today),c=parseInt(a.email_verified);return $("<li>",{onclick:b>0?"alertify.error('* \u7565\u904E\u5BC4\u9001 "+a.username+"')":"send_mail(false,$(this))",title:"\u2709\uFE0F "+a.nickname+" ("+a.username+") "+(c>0?"\u2714":""),"data-user_id":a.user_id,"data-username":a.username,"data-nickname":a.nickname,"data-email":a.email,"data-email_verified":c,"data-sent_today":b})})).slideDown("fast",function(){$(window).scrollTop(b.get(0).offsetTop-50)});break;case 2:b.show(),msg('<i class="far fa-exclamation-triangle"></i> \u6709\u8CC7\u6599\u6F0F\u586B');break;default:msg()}}).fail(function(a){msg('<i class="far fa-exclamation-triangle"></i> \u5594\u4E0D\uFF0C<br>'+JSON.stringify(a))})}function send_mail(e,c){if(e=e||!1,!(c=null==c?$(".recipients li[data-sent_today='0']:first"):c).length)return!1;var f=c.get(0).dataset,a=$(".push_data"),j=(f.user_id||"").trim(),b=(f.username||"").trim(),d=(f.nickname||b||"").trim(),i=(f.email||"").trim(),k=a.find("[data-sender_domain]").val()||"notify.heartymail.com",l=(a.find("[data-subject]").val()||"").trim(),g={sender:{name:(a.find("[data-sender]").val()||"\u6EAB\u5EA6\u65E5\u8A18").trim(),email:b+"@"+k,domain:k},recipient:{name:d,email:i,nickname:d,username:b},content:{subject:(a.find("[data-subject]").val()||"").trim(),body:(window.tinymce&&tinymce.activeEditor?tinymce.activeEditor.getContent():a.find("[data-body]").val()||"").trim(),tag:a.find("[data-tag]").val()||"",richformat:+a.find("input[name='format']").prop("checked")||0}},h=g.content;if(h.subject.length<4||h.body.length<6)return msg('<i class="far fa-exclamation-triangle"></i> \u6C92\u6709\u586B\u5BEB\u4FE1\u4EF6\u5167\u5BB9'),!1;g.content.subject=h.subject.replace(/\{{user_id}}/g,j).replace(/\{{username}}/g,b).replace(/\{{nickname}}/g,d).replace(/\{{email}}/g,i),g.content.body=h.body.replace(/\{{subject}}/g,l).replace(/\{{user_id}}/g,j).replace(/\{{username}}/g,b).replace(/\{{nickname}}/g,d).replace(/\{{email}}/g,i),e?send_mail_exec(g,e,c):(alertify.set({labels:{ok:"\u53D6\u6D88",cancel:'<i class="fas fa-inbox-out"></i> \u5BC4\u4FE1'},buttonReverse:!1}),alertify.confirm('<i class="fal fa-envelope-open-text"></i> \u5373\u5C07\u5BC4\u4FE1\u7D66\uFF1A'+d+" ("+b+")",function(a){a||send_mail_exec(g,e,c)}))}function send_mail_exec(a,b,c){var d=a.recipient.username,e=a.recipient.nickname;hj_update__push({action:"send_mail",mail:JSON.stringify(a)}).then(function(f){switch(f.Status){case 1:send_mail_log(a,"1FAIpQLSdn8CZP3i0xD5jL2SQ8Zj6d8h7yk9V-ReRKho54mPRuRX_g0g"),console.log(JSON.stringify(f));break;case 3:send_mail_log(a,"1FAIpQLSd1ktd9NEKxFAJBb8bG2HJwaOcs4VT6L0xUWEg7XGYmMMiW0A"),alertify.error('<i class="far fa-exclamation-triangle"></i> \u7565\u904E\u91CD\u8907\u5BC4\u767C\uFF1A'+e+" ("+d+")");break;default:alertify.error('<i class="far fa-exclamation-triangle"></i> \u767C\u4FE1\u5931\u6557\uFF1A<br><b>'+d.substr(0,20)+"</b>")}b&&0==c.next().length&&msg('<i class="fal fa-envelope-open"></i> \u6279\u6B21\u5BC4\u9001\u5B8C\u6210',"\u597D\u8036",function(){$(window).scrollTop(0)}),c.remove(),$("<ol>",{title:e,onclick:"hj_preview(true,$(this).data('html'))","data-username":d,"data-success":+(1==f.Status),html:$("<li>",{"data-device":""}).text(d).add($("<li>",{text:a.content.subject})).add($("<li>",{html:a.content.body}))}).data({html:a.content.body}).prependTo(".result").fadeIn()}).fail(function(a){alertify.error('<i class="far fa-exclamation-triangle"></i> \u7CDF\u4E86\uFF0C<br>'+JSON.stringify(a).substr(0,20))})}function send_mail_bulk(){if(window.send_bulk){msg('<i class="fal fa-sync-alt"></i> \u6392\u7A0B\u9032\u884C\u4E2D\uFF0C\u4E00\u6B21\u53EA\u80FD\u8DD1\u4E00\u7D44\u6392\u7A0B');return}var a=$(".recipients li[data-sent_today='0']").length;a>0?(alertify.set({labels:{ok:"\u53D6\u6D88",cancel:'<i class="fas fa-inbox-out"></i> \u78BA\u5B9A\u7FA4\u767C'},buttonReverse:!1}),alertify.confirm('<i class="fal fa-envelope-open-text"></i> \u5373\u5C07\u5BC4\u9001\u81F3 '+a+"\u7D44 Emails",function(a){a||(window.send_bulk=setInterval(function(){var a=$(".recipients li[data-sent_today='0']");a.length,a.length>0?send_mail(!0,a.eq(0).attr("data-sent_today",1)):(clearInterval(send_bulk),window.send_bulk=null)},2e3))})):msg('<i class="far fa-exclamation-triangle"></i> \u6C92\u6709\u53EF\u767C\u4FE1\u7684 Email\uFF0C\u8ACB\u5148\u884C\u67E5\u8A62')}function send_mail_log(a,b){return hj_update({action:"gform_post",uri:b,data:$.param({emailAddress:a.recipient.email||"guest@hearty.me","entry.1244275016":a.recipient.username||"n/a","entry.912693507":a.recipient.nickname||"n/a","entry.1367122498":a.content.tag||"n/a","entry.2026927390":a.content.subject||"n/a","entry.1350707169":a.content.body||"n/a","entry.50475957":a.sender.domain||"n/a","entry.605239846":new Date().toISOString().split("T")[0]})})}function filter_finished(b){var a=$(".recipients");b?a.addClass("unfinished"):a.removeClass("unfinished")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_recipients(a){$(".recipients li[data-email_verified="+a+"]").slideUp("fast",function(){$(this).remove()})}function filter_all(a){var b=$(".user_data [data-uid_interval]");b.filter(":eq(0)").val(1).attr({max:a}),b.filter(":eq(1)").val(a).attr({max:a})}function uid_toggle(a,b){$(".user_data tr").attr("data-off","").filter(".uid_"+a).removeAttr("data-off"),alertify.success('<i class="fas fa-filter"></i> '+b+"\u6A21\u5F0F")}$(function(){get_menu_templates(),window.onbeforeunload=function(){return!1},$(document).scroll(function(){var a=$(".notify .page_up");$(this).scrollTop()>200?a.stop().fadeIn("slow"):a.stop().fadeOut("slow")})})