"use strict";function bd_loading(t){var e=$("body");t?e.addClass("loading"):e.removeClass("loading")}function bd_update(t){return $.ajax({url:location.origin+"/bd/update.php",type:"post",crossDomain:!0,dataType:"json",data:t,async:!0,xhrFields:{withCredentials:!0}})}function get_vouchers(){bd_update({action:"get_vouchers"}).then(function(t){switch(t.Status){case 1:$(".vouchers tbody[data-empty] tr").remove(),list_vouchers(t.Values);break;default:msg()}}).fail(function(){msg()})}function list_vouchers(t){var e=$(".vouchers tbody").hide();t.forEach(function(t){var a=$("[data-sample] tr").clone().removeAttr("data-sample");if(a.find("[data-voucher]").attr({title:t.voucher}),a.find("[data-expiration]").attr({"data-expiration":t.expiration[0],title:t.expiration[1]}),"email"in t&&a.find("[data-email]").attr({title:t.email,"data-emails_sent":t.emails_sent}),"remark"in t&&a.find("[data-remark]").attr({title:t.remark}),"redemption"in t){var i=parseInt(t.expired)>0,n=parseInt(t.redemption)>0;a.find("[data-status]").attr({"data-status":n?2:+!i,title:n?"已兌換":i?"逾期":"有效"})}a.prependTo(e)}),e.fadeIn()}function voucher_remark(t){if(t){var e=t.siblings("[data-voucher]").attr("title")||"",a=t.attr("title")||"";alertify.set({labels:{ok:"<i class='fas fa-plus'></i> 貼上",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-edit'></i> 新增備註：",function(a,i){a&&bd_update({action:"voucher_remark",voucher:e,remark:i=i||""}).then(function(e){1==e.Status&&t.attr({title:i})}).fail(function(){msg()})},a),alertify_input_custom({type:"text",minlength:1,max:20,placeholder:"eg. 領取者姓名、檔期名稱、其他資訊"},{"letter-spacing":"1px"})}}function create_vouchers(){alertify.set({labels:{ok:"<i class='fas fa-shopping-bag'></i> 取號",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-gift'></i> 您需要幾張序號呢？",function(t,e){t&&bd_update({action:"create_vouchers",num:e=Math.min(e||1,20)}).then(function(t){switch(t.Status){case 1:list_vouchers(t.Values);break;default:msg()}}).fail(function(){msg()})},"1"),alertify_input_custom({type:"number",min:1,max:20,step:1,placeholder:"10"},{"letter-spacing":"3px"})}function hide_voucher(t){var e=t.siblings("[data-voucher]").attr("title")||"";1!=(t.siblings("[data-status]").attr("data-status")||1)?(alertify.set({labels:{ok:"取消",cancel:"對，不想再看到它惹"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-eye-slash'></i> 隱藏序號「"+e+"」嗎？",function(a){a||bd_update({action:"hide_voucher",voucher:e}).then(function(a){switch(a.Status){case 1:alertify.error("<i class='fas fa-minus-circle'></i> 隱藏了 "+e),t.parent().slideUp("slow",function(){$(this).remove()});break;default:msg()}}).fail(function(){msg()})})):msg("<i class='fal fa-ban'></i> 僅能隱藏逾期或已兌換的序號")}function collect_email(t){if(t){var e=t.siblings("[data-voucher]").attr("title")||"",a=t.attr("title")||"",i=t.siblings("[data-expiration]").attr("data-expiration");alertify.set({labels:{ok:"<i class='fas fa-chevron-right'></i> 下一步，設定 Email",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-envelope'></i> 收件人 Email：",function(n,r){n&&(r=(r||"").trim(),a==r?email_composer(!0,e,a,i):r.length>5?(email_composer(!0,e,r,i),bd_update({action:"voucher_email",voucher:e,email:r}).then(function(e){switch(e.Status){case 1:return void t.attr({title:r});case 3:msg("<i class='fal fa-info-circle'></i> Email 有誤，或格式不正確"),collect_email(t);break;default:msg()}email_composer(!1)}).fail(function(){msg(),email_composer(!1)})):(alertify_input_shake(),collect_email("")))},a),alertify_input_custom({type:"email",min:5,max:64,placeholder:"someone@gmail.com"},{"letter-spacing":"1px"})}}function email_composer(t,e,a,i){var n=$(".email"),r=n.find(".variables"),c=$("#Smallchat");if(t){n.removeAttr("data-hidden").fadeTo("fast",1).find("input[type='email']").val(a),r.find("[data-voucher-email]").attr("data-voucher-email",a),r.find("[data-voucher-timer]").attr("data-voucher-timer",i);var l="https://hearty.gift/"+e+"/"+a;r.find("[data-voucher]").attr({href:l,"data-voucher":e}),r.find("[data-voucher-link]").attr({href:l,"data-voucher-link":l}),hj_tinymce_init(),c.fadeOut()}else n.fadeOut(),c.fadeIn();$("body").css({overflow:t?"hidden":"auto"})}function send_voucher_email(){var t=hj_template_field("voucher-email"),e=$("[data-emails_sent][title='"+t+"']"),a=parseInt(e.attr("data-emails_sent"))||0;t.length<5||t.indexOf("@")<0?msg("<i class='fal fa-info-circle'></i> Email 格式不正確"):a>4?msg("<i class='fal fa-exclamation-triangle'></i> 超出發信上限 (5封/單一收件人)，請聯絡溫度團隊"):(alertify.set({labels:{ok:"確認寄出",cancel:"取消"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-eye-slash'></i> 即將發送序號通知信到「"+t+"」",function(i){if(i){var n=$("<i>",{html:tinymce.activeEditor.getContent({format:"raw"})||""});n.find("[data-voucher]").text(n.find("[data-voucher]").attr("data-voucher")).removeAttr("data-voucher"),n.find("[data-voucher-email]").text(n.find("[data-voucher-email]").attr("data-voucher-email")).removeAttr("data-voucher-email"),n.find("[data-voucher-link]").text(n.find("[data-voucher-link]").attr("data-voucher-link")).removeAttr("data-voucher-link"),n.add($("<img>",{src:"https://www.google-analytics.com/collect?v=1&t=event&tid=UA-26998803-8&cid=b0ed2542-fa8f-4054-82c2-924e6b97cf7d&ec=voucher_email&ea=open&dt=voucher_email&cn=voucher_email&cm="+t+"&cs=voucher_email",width:1,height:1})),bd_update({action:"send_voucher_email",voucher:hj_template_field("voucher"),email:t,cc_me:+$("input[name='cc_me']").prop("checked"),subject:$("textarea[name='subject']").val().trim(),body:n.html()}).then(function(i){switch(i.Status){case 1:msg("<i class='fas fa-check-circle'></i> 通知信已寄至："+t+"<br><br><img src='//i.hearty.app/w/hearty.me/bd/images/cute_envelope.gif'>"),tinymce.activeEditor.windowManager.close(),email_composer(!1),e.attr({"data-emails_sent":a+1});break;case 3:msg("<i class='fal fa-info-circle'></i> Email 有誤，或格式不正確");break;default:msg("<i class='fal fa-info-circle'></i> 糟了，醜一："+JSON.stringify(i.Values))}}).fail(function(){msg()})}}),tinymce.activeEditor.execCommand("mcePreview"))}function sender_info(){alertify.set({labels:{ok:"好的",cancel:"<i class='fas fa-edit'></i> 我要修改"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-mailbox'></i> Email 前綴 = 溫度 ID；顯示名稱 = 溫度暱稱",function(t){t||hj_href("account")})}function get_link(t){if(t){var e=t.siblings("[data-voucher]").attr("title")||"",a=t.siblings("[data-email]").attr("title")||null,i="https://hearty.gift/"+e+(null==a?"":"/"+a);alertify.set({labels:{ok:"否",cancel:"<i class='fas fa-copy'></i> 複製"},buttonReverse:!0}),alertify.prompt("<i class='fal fa-link'></i> 獨立邀請連結",function(t){t||(hj_copy($("#alertify .alertify-text")),"share"in navigator&&navigator.share({url:i}).catch(t=>{}))},i),alertify_input_custom({type:"url",placeholder:i,onclick:"hj_copy($(this))"},{cursor:"copy"}),hj_copy_text(i)}}function hj_tinymce_init(){window.tinymce?hj_tinymce_template():(hj_getScript("//cdn.jsdelivr.net/combine/npm/tinymce@5/tinymce.min.min.js,npm/tinymce@5/jquery.tinymce.min.min.js").then(function(){var t=$("textarea[data-editor]");t.val(linkify(t.val())).tinymce({base_url:"https://cdn.jsdelivr.net/npm/tinymce@5",placeholder:"Email 信件內文",content_css:"https://cdn.jsdelivr.net/gh/chennien/hearty.me@7e06e6c558cbcb6040798b5e5ec9cbd030994082/public/plugins/vouchers.tinymce.min.css",content_css_cors:!0,statusbar:!1,branding:!1,relative_urls:!1,remove_script_host:!1,height:300,menubar:!1,image_caption:!0,save_enablewhendirty:!1,plugins:"autolink preview directionality code visualblocks visualchars fullscreen image link codesample table charmap toc advlist imagetools textpattern noneditable charmap emoticons table paste save",toolbar:"reset-to-default save code preview fullscreen | image table link | undo redo | bold underline alignjustify aligncenter alignright | forecolor backcolor formatselect removeformatk | emoticons | fontsizeselect",toolbar_drawer:"sliding",link_list:[{title:"溫度日記 首頁",value:"https://app.hearty.me/hj"},{title:"溫度日記 用戶頁",value:"https://hearty.app/{{username}}"}],image_list:[{title:"溫度日記 信頭圖片",value:"https://i.hearty.app/i/mailheader.png"},{title:"溫度日記 Logo PNG",value:"https://i.hearty.app/i/logo.png"},{title:"溫度日記 Logo JPG",value:"https://i.hearty.app/i/logo.jpg"},{title:"溫度日記 Sheara",value:"https://i.hearty.app/i/illustrations/sheara.jpg"}],color_map:["ffffff","潔白","ffd1a4","皮膚","ffdcdc","淡粉","ffbdbd","淺粉","f16d6e","深紅","d78b7b","卡其","d28064","卡其","b4b4b4","淺灰","444444","深灰","000000","純黑"],contextmenu:"link",language:"zh_TW",language_url:"//cdn.jsdelivr.net/npm/tinymce-all-in-one@4.9.5/langs/zh_TW.min.js",default_link_target:"_blank",link_default_protocol:"https",paste_retain_style_properties:"all",paste_word_valid_elements:"*[*]",paste_convert_word_fake_lists:!1,paste_webkit_styles:"all",paste_merge_formats:!0,paste_data_images:!0,automatic_uploads:!0,images_upload_url:"../libs/mail.img.php",images_upload_credentials:!0,save_onsavecallback:hj_tinymce_template_save,setup:function(t){t.on("init",function(){hj_tinymce_template(),bd_update({action:"get_uploaded_images"}).then(function(e){1==e.Status&&(t.settings.image_list=t.settings.image_list.concat(e.Values))})}),t.ui.registry.addButton("reset-to-default",{icon:"restore-draft",tooltip:"重置為預設格式",onAction:function(){hj_tinymce_template_reset()}})}})}),window.onbeforeunload=function(){return!1})}function hj_tinymce_template(){bd_update({action:"voucher_email_template"}).then(function(t){if(1==t.Status){var e=t.Values;e.subject.length||e.template.length?hj_tinymce_template_rendering(e.subject,e.template):hj_tinymce_template_reset(!0)}})}function hj_tinymce_template_rendering(t,e){var a=hj_template_field("voucher"),i=hj_template_field("voucher-email"),n="https://hearty.gift/"+a+"/"+i,r=hj_template_field("voucher-timer"),c=$("<i>",{html:e});$("textarea[name='subject']").val(t),c.find("[data-voucher]").attr({href:n,"data-voucher":a}),c.find("[data-voucher-link]").attr({href:n,"data-voucher-link":n}),c.find("[data-voucher-email]").attr({"data-voucher-email":i}),c.find("[data-voucher-timer]").replaceWith(hj_timer_dom_convert(r)),c.find("[data-nickname]").text($(".vouchers .user").attr("title")||""),c.find("[data-date]").text((new Date).toISOString().split("T")[0].replace(/-/g,"/")),tinymce.activeEditor.setContent(c.html(),{format:"raw"})}function hj_timer_dom_convert(t){return(t=parseInt(t)||0)<Math.floor((new Date).getTime()/1e3)&&(t=0),$("<img>",{src:"https://i.hearty.app/t/"+t,"data-voucher-timer":t,alt:"期限倒數",title:"期限倒數",width:300,height:75})}function hj_tinymce_template_reset(t){t?$.ajax({url:"email.template.html?v="+(new Date).toISOString().split("T")[0].replace(/-/g,""),dataType:"text",success:function(t){hj_tinymce_template_rendering("您獨享的溫度日記 VIP 免費兌換券",t)}}):(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-truck-plow'></i> 清掉它"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-history'></i> 要清除內容，並回到預設格式嗎？",function(t){t||hj_tinymce_template_reset(!0)}))}function hj_tinymce_template_save(){var t=tinymce.activeEditor.getContent({format:"raw"})||"";bd_update({action:"voucher_email_template",subject:$("textarea[name='subject']").val(),template:t}).then(function(t){1==t.Status&&alertify.success("<i class='fal fa-save'></i> 已存為預設範本")})}function hj_template_field(t){return $(".email [data-"+t+"]").attr("data-"+t)}function hj_tinymce_variable(t){tinymce.activeEditor.insertContent(" "+t.prop({contenteditable:!1}).prop("outerHTML")+" ",""),alertify.success("<i class='fal fa-plus'></i> 插入 "+t.attr("title")||"")}function linkify(t){return(t||"").replace(/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,'<a target="_blank" href="$&">$&</a>').replace(/(^|[^\/])(www\.[\S]+(\b|$))/gim,'$1<a target="_blank" href="https://$2">$2</a>')}function hj_export(){var t=$(".vouchers table").clone();t.find("th[title],td[title]").each(function(){$(this).text($(this).attr("title")||"")}),t.find("[data-link]").remove(),exportTableToCSV(t,($(".vouchers .user").attr("title")||"")+"_"+(new Date).toISOString().split("T")[0].replace(/-/g,"")+".csv")}function exportTableToCSV(t,e){var a=t.find("tr:has(th)"),i=t.find("tr:has(td)"),n=String.fromCharCode(11),r=String.fromCharCode(0),c='","',l='"\r\n"',o='"';o+=u(a.map(d)),o+=l,o+=u(i.map(d))+'"';var s="data:application/csv;charset=utf-8,"+encodeURIComponent(o);function u(t){return t.get().join(r).split(r).join(l).split(n).join(c)}function d(t,e){var a=$(e),i=a.find("td");return i.length||(i=a.find("th")),i.map(f).get().join(n)}function f(t,e){return $(e).text().replace('"','""')}$("<a>",{href:s,download:e}).get(0).click()}function hj_preview(t){var e=$("body"),a=$(".hj_preview"),i=a.find("iframe");t?(i.attr("src")||i.attr({src:i.attr("data-url")}),a.fadeIn(),e.css({"overflow-y":"hidden","touch-action":"none"})):(a.fadeOut(),e.css({"overflow-y":"auto","touch-action":"auto"}))}$(function(){$(document).on("click",".vouchers [data-copy]",function(){hj_copy_text(this.title)}).on("click",".vouchers td[data-link]",function(){get_link($(this))}).on("click",".vouchers td[data-email]",function(){collect_email($(this))}).on("click",".vouchers td[data-remark]",function(){voucher_remark($(this))}).on("click",".vouchers td[data-hide]",function(){hide_voucher($(this))}),$(".user").on("click",function(){hj_href("account")}),$("header [data-menu]").on("click",function(){nav_toggle($(".menu"),!0)}),$(".email").on("click",function(){email_composer(!1)}).children("div").on("click",function(t){t.stopPropagation()}).find("input[type='email']").on("click",function(){hj_copy($(this))}),$(".email .variables").on("click",function(t){t.preventDefault()}).find("a").on("click",function(){$(this).is("[data-voucher-timer]")?hj_tinymce_variable(hj_timer_dom_convert($(this).attr("data-voucher-timer")).add($("<br>"))):hj_tinymce_variable($(this))}),$(".email [data-sender]").on("click",sender_info).find("address").on("click",function(){hj_copy_text(this.innerText)}),$(".help_btn").on("click",function(){hj_preview(!0)}),$(".hj_preview").on("click",function(){hj_preview(!1)}),$("[data-notavailable]").on("click",function(){msg("<i class='fal fa-box-full'></i> 功能即將推出，好了再讓你知道")}),get_vouchers(),$(".toast_signin_reminder").delay(5e3).queue(function(){$(this).fadeOut().dequeue()})});