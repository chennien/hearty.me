"use strict";function bd_loading(e){var t=$("body");e?t.addClass("loading"):t.removeClass("loading")}function bd_update(e){return $.ajax({url:location.origin+"/bd/update.php",type:"post",crossDomain:!0,dataType:"json",data:e,async:!0,xhrFields:{withCredentials:!0}})}function get_vouchers(){bd_update({action:"get_vouchers"}).then(function(e){switch(e.Status){case 1:$(".vouchers tbody[data-empty] tr").remove(),list_vouchers(e.Values);break;default:msg()}}).fail(function(){msg()})}function list_vouchers(e){var t=$(".vouchers tbody").hide();e.forEach(function(e){var a=$("[data-sample] tr").clone().removeAttr("data-sample");if(a.find("[data-voucher]").attr({title:e.voucher}),a.find("[data-expiration]").attr({"data-expiration":e.expiration[0],title:e.expiration[1]}),"email"in e&&a.find("[data-email]").attr({title:e.email,"data-emails_sent":e.emails_sent}),"remark"in e&&a.find("[data-remark]").attr({title:e.remark}),"redemption"in e){var i=parseInt(e.expired)>0,n=parseInt(e.redemption)>0;a.find("[data-status]").attr({"data-status":n?2:+!i,title:n?"已兌換":i?"逾期":"有效"})}a.prependTo(t)}),t.fadeIn()}function voucher_remark(e){if(e){var t=e.siblings("[data-voucher]").attr("title")||"",a=e.attr("title")||"";alertify.set({labels:{ok:"<i class='fas fa-plus'></i> 貼上",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-edit'></i> 備註一下：",function(a,i){a&&bd_update({action:"voucher_remark",voucher:t,remark:i=i||""}).then(function(t){1==t.Status&&e.attr({title:i})}).fail(function(){msg()})},a),alertify_input_custom({minlength:1,max:20,placeholder:"eg. 領取者姓名、檔期名稱、其他資訊"},{"letter-spacing":"1px"})}}function create_vouchers(){alertify.set({labels:{ok:"<i class='fas fa-shopping-bag'></i> 取號",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-gift'></i> 需要幾張序號呢？<br><small>序號需於 7日內兌換完畢，請索取所需數量即可</small>",function(e,t){e&&bd_update({action:"create_vouchers",num:t=Math.min(t||1,20)}).then(function(e){switch(e.Status){case 1:list_vouchers(e.Values);break;default:msg()}}).fail(function(){msg()})},"1"),alertify_input_custom({type:"number",min:1,max:20,step:1,maxlength:3,placeholder:10},{"letter-spacing":"3px"})}function hide_voucher(e){var t=e.siblings("[data-voucher]").attr("title")||"",a=1==e.siblings("[data-status]").attr("data-status");alertify.set({labels:{ok:"否",cancel:"<i class='fas fa-trash-alt'></i> 刪掉它"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-exclamation-circle'></i> "+(a?"序號未被兌換，不再需要":"刪除用過的")+"「"+t+"」嗎？",function(a){a||bd_update({action:"hide_voucher",voucher:t}).then(function(a){switch(a.Status){case 1:alertify.error("<i class='fas fa-trash-alt'></i> 刪除了 "+t),e.parent().slideUp("slow",function(){$(this).remove()}),hj_vibrate(30);break;default:msg()}}).fail(function(){msg()})})}function collect_email(e){if(e){var t=e.siblings("[data-voucher]").attr("title")||"",a=(e.attr("title")||"").toLowerCase(),i=e.attr("data-emails_sent")||0,n=e.siblings("[data-expiration]").attr("data-expiration");i<0?msg('<i class="fal fa-ban"></i> '+a+" 已退訂通知信，別再寄給他惹"):0==i?(alertify.set({labels:{ok:"<i class='fas fa-chevron-right'></i> 下一步，設定 Email",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-envelope'></i> 收件人 Email：<br><small><i class='far fa-shield-alt'></i> 基於個資保護，於此登錄之民眾 Email，將加以保密，<br>僅由貴店的您用於本次通知，不會也無法移作其他用途</small>",function(i,r){i&&(r=(r||"").trim(),a==r?email_composer(!0,t,a,n):r.length>5?(email_composer(!0,t,r,n),bd_update({action:"voucher_email",voucher:t,email:r}).then(function(t){switch(t.Status){case 1:return void e.attr({title:r});case 3:msg('<i class="fal fa-times"></i> Email 有誤，或格式不正確'),collect_email(e);break;case 4:msg('<i class="fal fa-ban"></i> '+r+" 已退訂通知信，別再寄給他惹"),collect_email(e);break;default:msg()}email_composer(!1)}).fail(function(){msg(),email_composer(!1)})):(alertify_input_shake(),collect_email("")))},a),alertify_input_custom({type:"email",min:5,max:64,placeholder:"someone@gmail.com"},{"letter-spacing":"1px"})):email_composer(!0,t,a,n)}}function email_composer(e,t,a,i){var n=$(".email"),r=n.find(".variables"),o=$("#Smallchat");if(e){n.removeAttr("data-hidden").fadeTo("fast",1).find("input[type='email']").val(a),r.find("[data-voucher-email]").attr("data-voucher-email",a),r.find("[data-voucher-timer]").attr("data-voucher-timer",i);var l="https://hearty.gift/"+t+"/"+a;r.find("[data-voucher]").attr({href:l,"data-voucher":t,rel:"noopener"}),r.find("[data-voucher-link]").attr({href:l,"data-voucher-link":l,rel:"noopener"}),hj_tinymce_init(),o.fadeOut()}else n.fadeOut(),o.fadeIn();$("body").css({overflow:e?"hidden":"auto"})}function send_voucher_email(){var e=hj_template_field("voucher"),t=hj_template_field("voucher-email"),a=$("[data-emails_sent][title='"+t+"']"),i=parseInt(a.attr("data-emails_sent"))||0;t.length<5||t.indexOf("@")<0?msg('<i class="fal fa-info-circle"></i> Email 格式不正確'):i>4?msg('<i class="fal fa-exclamation-triangle"></i> 超出發信上限 (5封/單一收件人)，請聯絡溫度團隊'):(alertify.set({labels:{ok:"確認寄出",cancel:"取消"},buttonReverse:!1}),alertify.confirm('<i class="fal fa-eye-slash"></i> 即將發送序號通知信到「'+t+"」",function(n){if(n){bd_loading(!0);var r=$("<i>",{html:tinymce.activeEditor.getContent({format:"raw"})||""});r.find("[data-voucher]").text(r.find("[data-voucher]").attr("data-voucher")).removeAttr("data-voucher"),r.find("[data-voucher-email]").text(r.find("[data-voucher-email]").attr("data-voucher-email")).removeAttr("data-voucher-email"),r.find("[data-voucher-link]").text(r.find("[data-voucher-link]").attr("data-voucher-link")).removeAttr("data-voucher-link"),r.append($("<hr>").add($("<span>",{text:"您參加了品牌活動，才會收到此封通知("+t+")。如不想再收到，請 ",style:"font-size:x-small"})).add($("<a>",{target:"_blank",href:"https://hearty.gift/u/"+t+"/"+e,text:"[取消訂閱 Unsubscribe :( ]",rel:"noopener",style:"text-decoration:none;font-size:x-small"})).add($("<img>",{src:"https://www.google-analytics.com/collect?v=1&t=event&tid=UA-26998803-8&cid=b0ed2542-fa8f-4054-82c2-924e6b97cf7d&ec=voucher_email&ea=open&dt=voucher_email&cn=voucher_email&cm="+t+"&cs=voucher_email",width:1,height:1}))).find("a[href*='https://']").each(function(){$(this).attr({href:$(this).attr("href").replace(/https:\/\/(?!c.heartymail)/gi,"https://c.heartymail.com/voucher/"+t+"/"+e+"/")})});var o=r.html(),l=$("textarea[name='subject']").val().trim();bd_update({action:"send_voucher_email",voucher:e,email:t,cc_me:+$("input[name='cc_me']").prop("checked"),subject:l,body:o}).then(function(e){switch(e.Status){case 1:msg('<i class="fas fa-check-circle"></i> 通知信已寄至：'+t+"<br><br><img src='//i.hearty.app/w/hearty.me/bd/images/cute_envelope.gif' style='filter:hue-rotate(145deg)saturate(.9)'>"),tinymce.activeEditor.windowManager.close(),email_composer(!1),a.attr({"data-emails_sent":i+1}),hj_update({action:"gform_post",uri:"1FAIpQLScJfg6TYfg_8NwI5d8yGP6H2Az29K9LA3osLnUcKj9YwUJb6Q",data:$.param({emailAddress:t,"entry.768310548":"[hj_user_id]","entry.2003480077":"[hj_username]","entry.1845355844":l,"entry.2038456161":o,"entry.1240071619":(new Date).toISOString().split("T")[0],"entry.390259802":check_browser()+", "+check_OS()})});break;case 3:msg('<i class="fal fa-info-circle"></i> Email 有誤，或格式不正確');break;default:msg('<i class="fal fa-info-circle"></i> 糟了，醜一：'+JSON.stringify(e.Values))}bd_loading(!1)}).fail(function(){msg(),bd_loading(!1)})}}),tinymce.activeEditor.execCommand("mcePreview"))}function sender_info(){alertify.set({labels:{ok:"好的",cancel:"<i class='fas fa-edit'></i> 我要修改"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-mailbox'></i> Email 前綴 = 溫度 ID；顯示名稱 = 溫度暱稱",function(e){e||hj_href("account")})}function get_link(e){if(e){var t=e.siblings("[data-voucher]").attr("title")||"",a=e.siblings("[data-email]").attr("title")||null,i="https://hearty.gift/"+t+(null==a?"":"/"+a);alertify.set({labels:{ok:"下載 <i class='fas fa-qrcode'></i>",cancel:"<i class='fas fa-copy'></i> 複製連結"},buttonReverse:!0}),alertify.prompt('<i class="fal fa-link"></i> 專屬邀請連結及 QRcode<br><br><a class="qrcode"></a>',function(e){e?$("#alertify .qrcode").get(0).click():(hj_copy($("#alertify .alertify-text")),"share"in navigator&&navigator.share({url:i}).catch(e=>{}))},i),alertify_input_custom({type:"url",placeholder:i,onclick:"hj_copy($(this))"},{cursor:"copy"}),hj_copy_text(i),get_qrcode($("#alertify .qrcode"),i,t)}}function hj_tinymce_init(){window.tinymce?hj_tinymce_template():(hj_getScript("//cdn.jsdelivr.net/combine/npm/tinymce@5/tinymce.min.min.js,npm/tinymce@5/jquery.tinymce.min.min.js").then(function(){var e=$("textarea[data-editor]");e.val(linkify(e.val())).tinymce({base_url:"https://cdn.jsdelivr.net/npm/tinymce@5",placeholder:"Email 信件內文",content_css:"https://cdn.jsdelivr.net/gh/chennien/hearty.me@1.0.39/public/plugins/vouchers.tinymce.min.css",content_css_cors:!0,statusbar:!1,branding:!1,relative_urls:!1,remove_script_host:!1,height:300,menubar:!1,image_caption:!0,save_enablewhendirty:!1,plugins:"autolink preview directionality code visualblocks visualchars fullscreen image link codesample table charmap toc advlist imagetools textpattern noneditable charmap emoticons table paste save",toolbar:"reset-to-default save code preview fullscreen | image table link | undo redo | bold underline alignjustify aligncenter alignright | forecolor backcolor formatselect removeformatk | emoticons | fontsizeselect",toolbar_drawer:"sliding",link_list:[{title:"溫度日記",value:"https://go.hearty.me/hj"}],image_list:[{title:"溫度日記 信頭圖片",value:"https://i.hearty.app/i/mailheader.png?o=1"},{title:"溫度日記 Logo PNG",value:"https://i.hearty.app/i/logo.png?o=1"},{title:"溫度日記 Logo JPG",value:"https://i.hearty.app/i/logo.jpg?o=1"},{title:"溫度日記 Sheara",value:"https://i.hearty.app/i/illustrations/sheara.jpg?o=1"}],color_map:["ffffff","潔白","ffd1a4","膚色","ffdcdc","淡粉","ffbdbd","淺粉","f16d6e","深紅","d78b7b","卡其","d28064","卡其","b4b4b4","淺灰","444444","深灰","000000","純黑"],contextmenu:"link",language:"zh_TW",language_url:"//cdn.jsdelivr.net/npm/tinymce-all-in-one@4.9.5/langs/zh_TW.min.js",default_link_target:"_blank",link_default_protocol:"https",paste_retain_style_properties:"all",paste_word_valid_elements:"*[*]",paste_convert_word_fake_lists:!1,paste_webkit_styles:"all",paste_merge_formats:!0,paste_data_images:!0,automatic_uploads:!0,images_upload_url:"../api/mail.img.php",images_upload_credentials:!0,save_onsavecallback:hj_tinymce_template_save,setup:function(e){e.on("init",function(){hj_tinymce_template(),bd_update({action:"get_uploaded_images"}).then(function(t){1==t.Status&&(e.settings.image_list=e.settings.image_list.concat(t.Values))})}),e.ui.registry.addButton("reset-to-default",{icon:"restore-draft",tooltip:"重置為預設格式",onAction:function(){hj_tinymce_template_reset()}})}})}),window.onbeforeunload=function(){return!1})}function hj_tinymce_template(){bd_update({action:"voucher_email_template"}).then(function(e){if(1==e.Status){var t=e.Values;t.subject.length||t.template.length?hj_tinymce_template_rendering(t.subject,t.template):hj_tinymce_template_reset(!0)}})}function hj_tinymce_template_rendering(e,t){var a=hj_template_field("voucher"),i=hj_template_field("voucher-email"),n="https://hearty.gift/"+a+"/"+i,r=hj_template_field("voucher-timer"),o=$("<i>",{html:t});$("textarea[name='subject']").val(e),o.find("[data-voucher]").attr({href:n,"data-voucher":a}),o.find("[data-voucher-link]").attr({href:n,"data-voucher-link":n}),o.find("[data-voucher-email]").attr({"data-voucher-email":i}),o.find("[data-voucher-timer]").replaceWith(hj_timer_dom_convert(r)),o.find("[data-nickname]").text($("header .user").attr("title")||""),o.find("[data-date]").text((new Date).toISOString().split("T")[0].replace(/-/g,"/")),tinymce.activeEditor.setContent(o.html(),{format:"raw"})}function hj_timer_dom_convert(e){return(e=parseInt(e)||0)<Math.floor((new Date).getTime()/1e3)&&(e=0),$("<img>",{src:"https://i.hearty.app/t/"+e,"data-voucher-timer":e,alt:"期限倒數",title:"期限倒數",width:300,height:75}).css({"border-radius":".5px"})}function hj_tinymce_template_reset(e){e?$.ajax({url:"email.template.html?v="+(new Date).toISOString().split("T")[0].replace(/-/g,""),dataType:"text",success:function(e){hj_tinymce_template_rendering("您獨享的「溫度日記 VIP 30日兌換券」",e)}}):(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-truck-plow'></i> 清掉它"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-history'></i> 要清除內容，並回到預設格式嗎？",function(e){e||hj_tinymce_template_reset(!0)}))}function hj_tinymce_template_save(){var e=tinymce.activeEditor.getContent({format:"raw"})||"";bd_update({action:"voucher_email_template",subject:$("textarea[name='subject']").val(),template:e}).then(function(e){1==e.Status&&alertify.success("<i class='fal fa-save'></i> 已存為預設範本")})}function hj_template_field(e){return $(".email [data-"+e+"]").attr("data-"+e)}function hj_tinymce_variable(e){tinymce.activeEditor.insertContent(" "+e.prop({contenteditable:!1}).prop("outerHTML")+" ",""),alertify.success("<i class='fal fa-plus'></i> 插入 "+e.attr("title")||"")}function linkify(e){return(e||"").replace(/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim,'<a target="_blank" href="$&">$&</a>').replace(/(^|[^\/])(www\.[\S]+(\b|$))/gim,'$1<a target="_blank" href="https://$2">$2</a>')}function hj_export(){var e=$(".vouchers table").clone();e.find("th[title],td[title]").each(function(){$(this).text($(this).attr("title")||"")}),e.find("[data-link]").remove(),exportTableToCSV(e,($("header .user").attr("title")||"溫度序號")+"_"+(new Date).toISOString().split("T")[0].replace(/-/g,"")+".csv")}function exportTableToCSV(e,t){var a=e.find("tr:has(th)"),i=e.find("tr:has(td)"),n=String.fromCharCode(11),r=String.fromCharCode(0),o='","',l='"\r\n"',c='"';c+=d(a.map(u)),c+=l,c+=d(i.map(u))+'"';var s="data:application/csv;charset=utf-8,"+encodeURIComponent(c);function d(e){return e.get().join(r).split(r).join(l).split(n).join(o)}function u(e,t){var a=$(t),i=a.find("td");return i.length||(i=a.find("th")),i.map(m).get().join(n)}function m(e,t){return $(t).text().replace('"','""')}$("<a>",{href:s,download:t}).get(0).click()}function bd_contract(){bd_update({action:"bd_contract"}).then(function(e){(e.Values||"").length>0&&hj_preview(!0,"//drive.google.com/file/d/"+e.Values+"/preview")})}function hj_preview(e,t){var a=$("body"),i=$(".hj_preview"),n=i.find("iframe");e?(n.attr({src:t||n.attr("data-url")||"//docs.google.com/document/d/e/2PACX-1vRmTICp7EIOPI_Lis2JTsVtb5tqoz3wulkTZzh2OUJKrzn_97RSpFmK9NtjXFnW4c5fBK374akpK0f8/pub?embedded=true"}).addClass("loading"),i.fadeIn(),a.css({"overflow-y":"hidden","touch-action":"none"})):(i.fadeOut(),a.css({"overflow-y":"auto","touch-action":"auto"}),n.attr({src:""}))}function generate_tutorial(){if("introJs"in window){var e=$(".vouchers");introJs().setOptions({showBullets:!1,prevLabel:"上一步",nextLabel:"繼續",doneLabel:"朕知道了",steps:[{element:e.find("[data-create]").get(0),intro:"👉　點「取號」，獲得序號",position:"left"},{element:e.find("table").get(0),intro:"🎁　序號會列於表中",position:"top"},{element:e.find("table th:nth-child(5)").get(0),intro:"✉️　可寄發序號 Email",position:"top"},{element:$("#Smallchat iframe").get(0),intro:"💬　如有問題，隨時私訊我們",position:"top"}]}).start().oncomplete(function(){hj_preview(!0)}).onexit(function(){hj_preview(!0)}),setcookie("hearty_voucher_tutorial",1,3)}else hj_getScript_npm("intro.js@3.2.1/intro.min.js",generate_tutorial)}function redeem_tutorial(e){var t=$(".redeem_tutorial"),a={1:"一、手動輸入序號",2:"二、點選兌換連結"};if(e)if(t.length>0)t.fadeIn();else{var i=["//i.hearty.app/b/videos/voucher_redeem",check_OS("iOS")?"#t=0.001":""];$("<section>",{class:"redeem_tutorial",html:Object.keys(a).map(function(e){return $("<div>",{title:a[e],html:$("<video>",{controls:"",controlsList:"nodownload",muted:"",preload:"",html:$("<source>",{src:i[0]+e+".webm"+i[1],type:"video/webm"}).add($("<source>",{src:i[0]+e+".mp4"+i[1],type:"video/mp4"}))}).on("play",function(){this.requestFullscreen&&this.requestFullscreen()}).on("click",function(e){e.stopPropagation()})})})}).on("click",function(){redeem_tutorial(!1)}).appendTo("body")}else t.fadeOut()}$(function(){$(document).on("click",".vouchers [data-copy]",function(){hj_copy_text(this.title)}).on("click",".vouchers td[data-link]",function(){get_link($(this))}).on("click",".vouchers td[data-email]",function(){collect_email($(this))}).on("click",".vouchers td[data-remark]",function(){voucher_remark($(this))}).on("click",".vouchers td[data-hide]",function(){hide_voucher($(this))}),$(".user").on("click",function(){hj_href("account")}),$("header [data-menu]").on("click",function(){nav_toggle($(".menu"),!0)}),$(".email").on("click",function(){confirm("要離開編輯視窗嗎？")&&email_composer(!1)}).children("div").on("click",function(e){e.stopPropagation()}).find("input[type='email']").on("click",function(){hj_copy($(this))}),$(".email .variables").on("click",function(e){e.preventDefault()}).find("a").on("click",function(){$(this).is("[data-voucher-timer]")?hj_tinymce_variable(hj_timer_dom_convert($(this).attr("data-voucher-timer")).add($("<br>"))):hj_tinymce_variable($(this))}),$(".email [data-send]").on("click",send_voucher_email),$(".email [data-sender]").on("click",sender_info).find("address").on("click",function(){hj_copy_text(this.innerText)}),$("[data-export]").on("click",hj_export),$("[data-create]").on("click",create_vouchers),$(".contract").on("click",bd_contract),$(".help_btn").on("click",function(){getcookie("hearty_voucher_tutorial")?hj_preview(!0):generate_tutorial()}),$(".hj_preview").on("click",function(){hj_preview(!1)}).find("iframe").on("load",function(){$(this).removeClass("loading")}),$("[data-redeem]").on("click",function(){redeem_tutorial(!0)}),$("[data-kit]").on("click",function(){hj_preview(!0,"//docs.google.com/embeddedfolderview?id=0B27GP5aLuObncVg1enJRcFlsSHM#grid")}),$("[data-tm]").on("click",function(){hj_preview(!0,"//mozilla.github.io/pdf.js/web/viewer.html?file=https://cdn.jsdelivr.net/gh/chennien/d.hearty.app@1/trademarks.pdf")}),$("[data-notavailable]").on("click",function(){msg('<i class="fal fa-box-full"></i> 功能即將推出，好了再讓你知道')}),get_vouchers(),$(".toast_signin_reminder").delay(5e3).queue(function(){$(this).fadeOut().dequeue()}),hj_localize_cn()});