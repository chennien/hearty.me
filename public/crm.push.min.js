"use strict";function hj_update__push(e){return $.ajax({url:location.href,type:"post",crossDomain:!0,dataType:"json",data:e,async:!0,xhrFields:{withCredentials:!0}})}function get_recipients(){var e=$(".recipients"),t=parseInt($("input[name='uid_selection']:checked").val()||0),a=["iPhone","iPad","Android","æ‰‹æ©Ÿç¶²é ","é›»è…¦ç‰ˆ","Line"],i=$("input[name='device']:checked").map(function(){return parseInt(this.value)}).get().sort(),n=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),r=$("textarea[data-uid_listed]").val().split(",").map(function(e){return parseInt(e.trim())||1}).sort();e.slideUp("fast"),$(".recipient_data .result").empty(),hj_update__push({action:"get_recipients",uid_interval:0==t?JSON.stringify(n):"",uid_listed:1==t?JSON.stringify(r):"",device:JSON.stringify(i)}).then(function(t){switch(t.Status){case 1:for(var i in t=t.Values,e.empty(),t){var n=t[i];for(var r in n.tokens){var s=a[parseInt(n.tokens[r].device)],l=parseInt(n.tokens[r].fcm_id),c=parseInt(n.tokens[r].sent_today);$("<li>",{onclick:c>0?"alertify.error('* ç•¥éå¯„é€ #"+l+"')":"send_push(false, $(this));",title:n.username+" - "+s+" # "+l,"data-username":n.username,"data-nickname":n.nickname,"data-fcm_id":l,"data-fcmtoken":n.tokens[r].fcmtoken,"data-device":n.tokens[r].device,"data-sent_today":c}).appendTo(e)}}e.slideDown("fast",function(){$(window).scrollTop(e.get(0).offsetTop-50)});break;case 2:e.show(),msg("<i class='far fa-exclamation-triangle'></i> æœ‰è³‡æ–™æ¼å¡«ï¼Œæˆ–æœªé¸æ“‡ä»»ä½•è£ç½®")}}).fail(function(e){msg("<i class='far fa-exclamation-triangle'></i> ç™¼ç”Ÿç•°å¸¸ï¼š<br>"+JSON.stringify(e))})}function send_push(e,t){if(e=e||!1,!(t=null==t?$(".recipients li[data-sent_today='0']:first"):t).length)return!1;var a=t.get(0).dataset,i=$(".push_data"),n={title:(i.find("[data-title]").val()||"").trim(),body:(i.find("[data-body]").val()||"").trim(),url:(i.find("[data-url]").val()||"https://hearty.me").trim(),tag:(i.find("[data-tag]").val()||"hj-default").trim(),device:Number(a.device||0),fcm_id:Number(a.fcm_id||0),fcmtoken:(a.fcmtoken||"").trim(),username:(a.username||"").trim(),nickname:(a.nickname||"").trim()};if(n.title.length<2||n.body.length<4)return msg("<i class='far fa-exclamation-triangle'></i> æ²’æœ‰å¡«å¯«æ¨æ’­è¨Šæ¯"),!1;n.title=n.title.replace(/\{{username}}/g,n.username).replace(/\{{nickname}}/g,n.nickname),n.body=n.body.replace(/\{{username}}/g,n.username).replace(/\{{nickname}}/g,n.nickname),n.url=n.url.replace(/\{{username}}/g,n.username),e?send_push_exec(n,e,t):(alertify.set({labels:{ok:"å–æ¶ˆ",cancel:"<i class='fas fa-inbox-out'></i> ç™¼é€"},buttonReverse:!1}),alertify.confirm("<i class='far fa-comment-lines'></i> å³å°‡æ¨æ’­äºˆï¼š"+n.nickname+" ("+n.username+"ï¼Œ# "+numberWithCommas(n.fcm_id)+")",function(a){a||send_push_exec(n,e,t)}))}function send_push_exec(e,t,a){hj_update__push({action:"send_push",push:JSON.stringify(e)}).then(function(i){var n=i.Values;switch(i.Status){case 1:console.log(JSON.stringify(i));break;case 3:alertify.alert("<i class='far fa-exclamation-triangle'></i> ç•¥éé‡è¤‡å¯„ç™¼ï¼š"+e.username+" (# "+numberWithCommas(e.fcm_id)+")");break;default:"error"in n.results[0]&&"NotRegistered"==n.results[0].error?hj_update__push({action:"revoke_fcmtoken",fcmtoken:e.fcmtoken}).then(function(t){1==t.Status?alertify.success("<i class='far fa-comment-alt-times'></i> è¨»éŠ·äº†ç„¡æ•ˆ tokenï¼š# "+numberWithCommas(e.fcm_id)):alertify.error("<i class='far fa-exclamation-circle'></i> ä¸èƒ½è¨»éŠ·ç„¡æ•ˆ tokenï¼š# "+numberWithCommas(e.fcm_id))}):msg("<i class='far fa-exclamation-triangle'></i> æ¨æ’­å¤±æ•—<br>ï¼š"+JSON.stringify(i))}if(t){var r=a.nextAll("[data-bulk='"+a.attr("data-bulk")+"']").eq(0);r.length>0?send_push(t,r):$(".recipients li[data-sent_today='0']").length||msg("<i class='far fa-comments-alt'></i> æ‰¹æ¬¡æ¨æ’­å®Œæˆ","å¥½è€¶",function(){$(window).scrollTop(0)})}a.remove(),$("<ol>",{title:e.nickname,onclick:"$(this).fadeOut('fast');","data-username":e.username,"data-success":+(1==i.Status),html:$("<li>",{"data-device":e.device,text:e.username+" (#"+numberWithCommas(e.fcm_id)+")"}).add($("<li>",{text:e.title})).add($("<li>",{text:e.body})).add($("<li>",{title:e.url,text:"ğŸŒ "+e.url})).add($("<li>",{title:e.tag,text:"ğŸ”– "+e.tag}))}).prependTo(".result").fadeIn()}).fail(function(e){msg("<i class='far fa-exclamation-triangle'></i> ç™¼ç”Ÿç•°å¸¸ï¼š<br>"+JSON.stringify(e))})}function send_push_bulk(){var e=$(".recipients li[data-sent_today='0']"),t=e.length;t>0?(alertify.set({labels:{ok:"å–æ¶ˆ",cancel:"<i class='fas fa-inbox-out'></i> ç¢ºå®šç¾¤ç™¼"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-comments-alt'></i> å³å°‡æ¨æ’­è‡³ "+t+"éƒ¨ç”¨æˆ¶è£ç½®",function(t){t||(send_push(!0,e.odd().attr({"data-bulk":"odd"}).eq(0)),send_push(!0,e.even().attr({"data-bulk":"even"}).eq(0)))})):msg("<i class='far fa-exclamation-triangle'></i> æ²’æœ‰å¯ç™¼é€çš„è£ç½®ï¼Œè«‹å…ˆè¡ŒæŸ¥è©¢")}function filter_finished(e){var t=$(".recipients li[data-sent_today='1']");e?t.slideUp():t.slideDown()}function template_prefill(e){switch(e){case"greeting":hj_update({action:"alice_greeting"}).then(function(e){"greeting_title"in(e=e.Values)&&template_prefilling({title:"{{nickname}}æ™šå®‰",body:"è¦ªæ„›çš„ï¼Œ"+e.greeting_title.split("ï¼Ÿ").join("ï¼Ÿ\n").trim(),url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/3I8Kc7x",tag:"hj-greeting"})});break;case"vip_7":template_prefilling({title:"å“ˆå›‰{{nickname}}",body:"è¬è¬ä½ å¡«å¯«çŸ¥å¿ƒå°èª¿æŸ¥ï¼Œ7æ—¥ VIP å·²é€é”ä½ çš„æº«åº¦æ—¥è¨˜åš•~",url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/33GVqRW",tag:"hj-billing"});break;case"response":template_prefilling({title:"å—¨{{nickname}}",body:"å·²é€é Email å›è¦†æ‚¨çš„å®¢æœï¼Œè«‹çœ‹ä¿¡ç®± ( Â´ï½¥ãƒ®ï½¥)ï¾‰",url:"https://hearty.me/{{username}}?link=hearty.me/wv?o=go.hearty.me/hj-gmail",tag:"hj-cs"});break;case"faq_penpal":template_prefilling({title:"{{nickname}}",body:"å¦‚ä½•èˆ‡ç­†å‹äº¤æ›æ—¥è¨˜ (FAQ)",url:"https://hearty.me/{{username}}?link=faq.hearty.me/tutorial/penpal_diaries",tag:"hj-cs"});break;case"buyer_survey":template_prefilling({title:"{{nickname}}ï¼Œæº«åº¦ VIP è‡´è¬",body:"1åˆ†é˜å¡«å¯«æ»¿æ„åº¦èª¿æŸ¥",url:"https://hearty.me/{{username}}?link=www.surveycake.com/s/oVkmm?ssn0={{username}}",tag:"hj-survey"});break;case"unpaid_order":template_prefilling({title:"{{nickname}}",body:"å°æé†’ï¼šè³¼è²·çš„ VIP å°šæœªç¹³æ¬¾å”·",url:"https://hearty.me/{{username}}?link=hearty.me/shop/bill?o=HJ_"+(new Date).getFullYear()+(getUrlPara("order_id")||"1").padStart(6,"0"),tag:"hj-order"})}}function template_prefilling(e){var t=$(".push_data");t.find("[data-title]").val(e.title),t.find("[data-body]").val(e.body),t.find("[data-url]").val(e.url),t.find("[data-tag] option").removeAttr("selected").filter("[value='"+e.tag+"']").attr("selected","")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_recipients(e){$(".recipients li[data-device="+e+"]").slideUp("fast",function(){$(this).remove()})}function filter_all(e){var t=$(".user_data [data-uid_interval]");t.filter(":eq(0)").val(1).attr({max:e}),t.filter(":eq(1)").val(e).attr({max:e})}function uid_toggle(e,t){$(".user_data tr").attr("data-off","").filter(".uid_"+e).removeAttr("data-off"),alertify.success("<i class='fas fa-filter'></i> "+t+"æ¨¡å¼")}$(function(){window.onbeforeunload=function(){return!1},$(document).scroll(function(){var e=$(".notify .page_up");$(this).scrollTop()>200?e.stop().fadeIn("slow"):e.stop().fadeOut("slow")}),getUrlPara("order_id")&&$("select[data-template]").val("unpaid_order").change()});