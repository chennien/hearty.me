"use strict";function hj_update__push(a){return $.ajax({url:location.href,type:"post",crossDomain:!0,dataType:"json",data:a,async:!0,xhrFields:{withCredentials:!0}})}function get_recipients(){var b=$(".recipients"),a=parseInt($("input[name='uid_selection']:checked").val()||0),f=["iPhone","iPad","Android","\u624B\u6A5F\u7DB2\u9801","\u96FB\u8166\u7248","Line"],c=$("input[name='device']:checked").map(function(){return parseInt(this.value)}).get().sort(),d=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),e=$("textarea[data-uid_listed]").val().split(",").map(function(a){return parseInt(a.trim())||1}).sort();b.slideUp("fast"),$(".recipient_data .result").empty(),hj_update__push({action:"get_recipients",uid_interval:0==a?JSON.stringify(d):"",uid_listed:1==a?JSON.stringify(e):"",device:JSON.stringify(c)}).then(function(c){switch(c.Status){case 1:for(var h in c=c.Values,b.empty(),c){var a=c[h];for(var d in a.tokens){var i=f[parseInt(a.tokens[d].device)],e=parseInt(a.tokens[d].fcm_id),g=parseInt(a.tokens[d].sent_today);$("<li>",{onclick:g>0?"alertify.error('* \u7565\u904E\u5BC4\u9001 #"+e+"')":"send_push(false, $(this));",title:a.username+" - "+i+" # "+e,"data-username":a.username,"data-nickname":a.nickname,"data-fcm_id":e,"data-fcmtoken":a.tokens[d].fcmtoken,"data-device":a.tokens[d].device,"data-sent_today":g}).appendTo(b)}}b.slideDown("fast",function(){$(window).scrollTop(b.get(0).offsetTop-50)});break;case 2:b.show(),msg("<i class='far fa-exclamation-triangle'></i> \u6709\u8CC7\u6599\u6F0F\u586B\uFF0C\u6216\u672A\u9078\u64C7\u4EFB\u4F55\u88DD\u7F6E")}}).fail(function(a){msg("<i class='far fa-exclamation-triangle'></i> \u767C\u751F\u7570\u5E38\uFF1A<br>"+JSON.stringify(a))})}function send_push(d,b){if(d=d||!1,!(b=null==b?$(".recipients li[data-sent_today='0']:first"):b).length)return!1;var c=b.get(0).dataset,e=$(".push_data"),a={title:(e.find("[data-title]").val()||"").trim(),body:(e.find("[data-body]").val()||"").trim(),url:(e.find("[data-url]").val()||"https://hearty.me").trim(),tag:(e.find("[data-tag]").val()||"hj-default").trim(),device:Number(c.device||0),fcm_id:Number(c.fcm_id||0),fcmtoken:(c.fcmtoken||"").trim(),username:(c.username||"").trim(),nickname:(c.nickname||"").trim()};if(a.title.length<2||a.body.length<4)return msg("<i class='far fa-exclamation-triangle'></i> \u6C92\u6709\u586B\u5BEB\u63A8\u64AD\u8A0A\u606F"),!1;a.title=a.title.replace(/\{{username}}/g,a.username).replace(/\{{nickname}}/g,a.nickname),a.body=a.body.replace(/\{{username}}/g,a.username).replace(/\{{nickname}}/g,a.nickname),a.url=a.url.replace(/\{{username}}/g,a.username),d?send_push_exec(a,d,b):(alertify.set({labels:{ok:"\u53D6\u6D88",cancel:"<i class='fas fa-inbox-out'></i> \u767C\u9001"},buttonReverse:!1}),alertify.confirm("<i class='far fa-comment-lines'></i> \u5373\u5C07\u63A8\u64AD\u4E88\uFF1A"+a.nickname+" ("+a.username+"\uFF0C# "+numberWithCommas(a.fcm_id)+")",function(c){c||send_push_exec(a,d,b)}))}function send_push_exec(a,b,c){hj_update__push({action:"send_push",push:JSON.stringify(a)}).then(function(d){var e=d.Values;switch(d.Status){case 1:console.log(JSON.stringify(d));break;case 3:alertify.error('<i class="fas fa-exclamation-triangle"></i> \u7565\u904E\u91CD\u8907\u5BC4\u767C\uFF1A'+a.username+" (# "+numberWithCommas(a.fcm_id)+")");break;default:"error"in e.results[0]&&"NotRegistered"==e.results[0].error?hj_update__push({action:"revoke_fcmtoken",fcmtoken:a.fcmtoken}).then(function(b){1==b.Status?alertify.success("<i class='far fa-comment-alt-times'></i> \u8A3B\u92B7\u4E86\u7121\u6548 token\uFF1A# "+numberWithCommas(a.fcm_id)):alertify.error("<i class='far fa-exclamation-circle'></i> \u4E0D\u80FD\u8A3B\u92B7\u7121\u6548 token\uFF1A# "+numberWithCommas(a.fcm_id))}):msg("<i class='far fa-exclamation-triangle'></i> \u63A8\u64AD\u5931\u6557<br>\uFF1A"+JSON.stringify(d))}if(b){var f=c.nextAll("[data-bulk='"+c.attr("data-bulk")+"']").eq(0);f.length>0?send_push(b,f):$(".recipients li[data-sent_today='0']").length||msg("<i class='far fa-comments-alt'></i> \u6279\u6B21\u63A8\u64AD\u5B8C\u6210","\u597D\u8036",function(){$(window).scrollTop(0)})}c.remove(),$("<ol>",{title:a.nickname,onclick:"$(this).fadeOut('fast');","data-username":a.username,"data-success":+(1==d.Status),html:$("<li>",{"data-device":a.device,text:a.username+" (#"+numberWithCommas(a.fcm_id)+")"}).add($("<li>",{text:a.title})).add($("<li>",{text:a.body})).add($("<li>",{title:a.url,text:"\u{1F310} "+a.url})).add($("<li>",{title:a.tag,text:"\u{1F516} "+a.tag}))}).prependTo(".result").fadeIn()}).fail(function(a){msg("<i class='far fa-exclamation-triangle'></i> \u767C\u751F\u7570\u5E38\uFF1A<br>"+JSON.stringify(a))})}function send_push_bulk(){var b=$(".recipients li[data-sent_today='0']"),a=b.length;a>0?(alertify.set({labels:{ok:"\u53D6\u6D88",cancel:"<i class='fas fa-inbox-out'></i> \u78BA\u5B9A\u7FA4\u767C"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-comments-alt'></i> \u5373\u5C07\u63A8\u64AD\u81F3 "+a+"\u90E8\u7528\u6236\u88DD\u7F6E",function(a){a||(send_push(!0,b.odd().attr({"data-bulk":"odd"}).eq(0)),send_push(!0,b.even().attr({"data-bulk":"even"}).eq(0)))})):msg("<i class='far fa-exclamation-triangle'></i> \u6C92\u6709\u53EF\u767C\u9001\u7684\u88DD\u7F6E\uFF0C\u8ACB\u5148\u884C\u67E5\u8A62")}function filter_finished(b){var a=$(".recipients");b?a.addClass("unfinished"):a.removeClass("unfinished")}function template_prefill(a){switch(a){case"greeting":hj_update({action:"alice_greeting"}).then(function(a){"greeting_title"in(a=a.Values)&&template_prefilling({title:"{{nickname}}\u665A\u5B89",body:"\u89AA\u611B\u7684\uFF0C"+a.greeting_title.split("\uFF1F").join("\uFF1F\n").trim(),url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/3I8Kc7x",tag:"hj-greeting"})});break;case"vip_7":template_prefilling({title:"\u54C8\u56C9{{nickname}}",body:"\u8B1D\u8B1D\u4F60\u586B\u5BEB\u77E5\u5FC3\u5C0F\u8ABF\u67E5\uFF0C7\u65E5 VIP \u5DF2\u9001\u9054\u4F60\u7684\u6EAB\u5EA6\u65E5\u8A18\u5695~",url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/33GVqRW",tag:"hj-billing"});break;case"response":template_prefilling({title:"\u55E8{{nickname}}",body:"\u5DF2\u900F\u904E Email \u56DE\u8986\u60A8\u7684\u5BA2\u670D\uFF0C\u8ACB\u770B\u4FE1\u7BB1 ( \xb4\uFF65\u30EE\uFF65)\uFF89",url:"https://hearty.me/{{username}}?link=hearty.me/wv?o=go.hearty.me/hj-gmail",tag:"hj-cs"});break;case"faq_penpal":template_prefilling({title:"{{nickname}}",body:"\u5982\u4F55\u8207\u7B46\u53CB\u4EA4\u63DB\u65E5\u8A18 (FAQ)",url:"https://hearty.me/{{username}}?link=faq.hearty.me/tutorial/penpal_diaries",tag:"hj-cs"});break;case"buyer_survey":template_prefilling({title:"{{nickname}}\uFF0C\u6EAB\u5EA6 VIP \u81F4\u8B1D",body:"1\u5206\u9418\u586B\u5BEB\u6EFF\u610F\u5EA6\u8ABF\u67E5",url:"https://hearty.me/{{username}}?link=www.surveycake.com/s/oVkmm?ssn0={{username}}",tag:"hj-survey"});break;case"unpaid_order":template_prefilling({title:"{{nickname}}",body:"\u5C0F\u63D0\u9192\uFF1A\u8CFC\u8CB7\u7684 VIP \u5C1A\u672A\u7E73\u6B3E\u5537",url:"https://hearty.me/{{username}}?link=hearty.me/shop/bill?o=HJ_"+new Date().getFullYear()+(getUrlPara("order_id")||"1").padStart(6,"0"),tag:"hj-order"})}}function template_prefilling(a){var b=$(".push_data");b.find("[data-title]").val(a.title),b.find("[data-body]").val(a.body),b.find("[data-url]").val(a.url),b.find("[data-tag] option").removeAttr("selected").filter("[value='"+a.tag+"']").attr("selected","")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_recipients(a){$(".recipients li[data-device="+a+"]").slideUp("fast",function(){$(this).remove()})}function filter_all(a){var b=$(".user_data [data-uid_interval]");b.filter(":eq(0)").val(1).attr({max:a}),b.filter(":eq(1)").val(a).attr({max:a})}function uid_toggle(a,b){$(".user_data tr").attr("data-off","").filter(".uid_"+a).removeAttr("data-off"),alertify.success("<i class='fas fa-filter'></i> "+b+"\u6A21\u5F0F")}$(function(){window.onbeforeunload=function(){return!1},$(document).scroll(function(){var a=$(".notify .page_up");$(this).scrollTop()>200?a.stop().fadeIn("slow"):a.stop().fadeOut("slow")}),getUrlPara("order_id")&&$("select[data-template]").val("unpaid_order").change()})