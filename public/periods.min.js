"use strict";function period_add(e,d,t,a){e=e||0;var i=(new Date).toJSON().slice(0,10),o=new Date((new Date).getTime()+864e5).toJSON().slice(0,10),n="20[0-2][0-9]-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])",r=(d=d||"",t=t||"",a=a||0,diary_date_format(d||i)),s=t?diary_date_format(t):"",p=$(".periods"),_=$("<div>",{class:"td td1 period_interval"+(e>0&&(a<18||a>=38)?" ng":"")}).text(e>0?a:""),l=$("<div>",{class:"td td1 period_removal",title:_h("e-pd-10"),html:$("<span>",{class:"period_remove",onclick:"period_remove("+e+")"})}),c={td:$("<div>",{class:"td td2 period_start display","data-dayid":e,"data-day":d==i?_h("e-pd-8"):r,title:r,onclick:"period_editing_toggle(true,this.dataset.dayid,0)"}),td_inner:$("<div>",{onclick:"event.stopPropagation()"}),edit:$("<input>",{type:"date",pattern:n,max:o,onchange:"if(!this.value) this.value='"+i+"'; else period_update('start',"+e+",this.value)",required:!0,autofocus:!d}).val(d),ok:$("<div>",{class:"ok",onclick:"period_editing_toggle(false,"+e+")",title:_h("e-ok-0")})},u={td:$("<div>",{class:"td td2 period_end display","data-dayid":e,"data-day":t==i?_h("e-pd-8"):s,title:s,onclick:"period_editing_toggle(true,this.dataset.dayid,1)"}),td_inner:$("<div>",{onclick:"event.stopPropagation()"}),edit:$("<input>",{type:"date",pattern:n,list:"ls_"+e,min:d?period_add_days(d,2):"",max:d?[i,period_add_days(d,14)].reduce(function(e,d){return e<d?e:d}):i,onchange:"if(this.value!=='') period_update('end',"+e+",this.value)",title:s,disabled:!d}).val(t),list:$("<datalist>",{id:"ls_"+e}),ok:$("<div>",{class:"ok",onclick:"period_editing_toggle(false,"+e+")",title:_h("e-ok-0")})};(check_OS("iOS")||check_browser("Safari"))&&c.edit.add(u.edit).each(function(){$(this).attr({type:"text",pattern:n,onclick:"$(this).datepicker('show').select()",readonly:""}).datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,showAnim:"slideDown",minDate:$(this).attr("min")||"",maxDate:$(this).attr("max")||"",showButtonPanel:!0})}),p.find("[data-dayid='0']").parent().remove(),c=c.td.html(c.td_inner.append(c.edit.add(c.ok)));for(let e=6;e<9;e++)u.list.append($("<option>").val(period_add_days(d,e)));u=u.td.html(u.td_inner.append(u.edit.add(u.list).add(u.ok))),$("<div>",{class:"period tr"}).append(c.add(u).add(_).add(l)).prependTo(p.find(".records")),e||period_editing_toggle(!0,0,0),hj_mixpanel("Period Day Added",{day_id:e}),ga_event_push("Period Day Added",{event_category:"Period Day",event_label:"Added"})}function period_add_days(e,d){return(e=new Date(new Date(e).getTime()+864e5*d)).getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)}function period_lookup(){var e=$(".periods");e.find(".records").slideUp("fast",function(){hj_update({action:"period_lookup"}).then(function(d){switch(d.Status){case 1:var t=d.Values,a=t.period_day_next;e.find(".day_cycle").text(t.period_day_cycle),e.find(".day_next").text(new Date(a).toLocaleDateString(navigator.language||"zh-TW",{month:"long",day:"numeric"})),period_days_between(a),e.find(".period").remove(),t.periods.forEach(function(e){period_add(e.day_id,e.day_start,e.day_end,e.day_interval)}),t.periods.length>0?e.find(".prediction").slideDown():e.find(".prediction").slideUp(),period_remove_btn(!1),e.find(".records").slideDown("slow")}})}),hj_mixpanel("Period Day Lookup"),ga_event_push("Period Day Lookup",{event_category:"Period Day",event_label:"Lookup"})}function period_editing_toggle(e,d,t){var a=$(".periods");a.find("[data-dayid]").addClass("display"),e&&(a.find("[data-dayid='"+d+"']").removeClass("display").find("input").eq(null==t?0:t).focus(),period_remove_btn(!1))}function period_update(e,d,t){if(null!=t&&""!=t){var a=$(".periods"),i=a.find(".period_"+e+"[data-dayid='"+d+"']"),o=diary_date_format(t);period_editing_toggle(!1,d),i.attr({"data-day":o,title:o}),hj_update({action:"period_update",type:e,day_id:d||0,day:t}).then(function(t){switch(t.Status){case 1:var i=t.Values.day_id;"start"==e?period_lookup():d||a.find("[data-dayid=0]").attr({"data-dayid":i,onclick:"period_editing_toggle(true,"+i+",1)"}),hj_mixpanel("Period Day Updated",{day_id:d}),ga_event_push("Period Day Updated",{event_category:"Period Day",event_label:"Updated"})}})}}function period_remove_btn(e){var d=$(".periods"),t=d.find(".period_interval").add(d.find(".day_trash")),a=d.find(".period_removal");d.find(".period").length?e?(a.fadeIn(),t.slideUp()):(a.fadeOut(),t.slideDown()):(a.fadeOut(),t.slideUp())}function period_remove(e){var d=$(".periods");e?(alertify.set({labels:{ok:_h("e-no-0"),cancel:'<i class="fas fa-times"></i> '+_h("e-pd-9")},buttonReverse:!0}),alertify.confirm('<i class="fal fa-moon"></i> '+_h("e-pd-10"),function(t){t||hj_update({action:"period_remove",day_id:e}).then(function(t){switch(t.Status){case 1:period_lookup(),d.find(".period_removal").fadeOut(),hj_vibrate(30),hj_mixpanel("Period Day Removed",{day_id:e}),ga_event_push("Period Day Removed",{event_category:"Period Day",event_label:"Removed"});break;default:signin_required()}period_remove_btn(!1)})})):d.find("[data-dayid=0]").parent().fadeOut(300,function(){$(this).remove()})}function period_days_between(e){var d=new Date((new Date).setHours(0,0,0)),t=Math.round((new Date(new Date(e).setHours(0,0,0)).getTime()-d.getTime())/864e5),a=$(".periods .days_left");switch(!0){case t<=0:(t=Math.abs(t))<7?(t++,a.text(_h("e-pd-11",{$d:t,$th:nth(t)}))):a.text(_h("e-pd-1"));break;default:a.text(_h("e-pd-12",{$d:t}))}}period_lookup();