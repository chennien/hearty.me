period_lookup();function period_date_format(d){return new Date(d).toLocaleDateString("zh-TW",{month:"long",day:"numeric"})}
function period_add(day_id,day_start,day_end,day_interval){var day_id=day_id||0,today=new Date().toJSON().slice(0,10),day_start=day_start||"",day_end=day_end||"",day_interval=day_interval||0,day_start_f=period_date_format(day_start||today),day_end_f=!day_end?"":period_date_format(day_end),$pd=$(".periods"),$interval=$("<div>",{class:"td td1 period_interval"+(day_id>0&&(day_interval<18||day_interval>=38)?" ng":"")}).text(day_id>0?day_interval:"");$remove=$("<div>",{class:"td td1 period_removal",title:"刪除"}).html($("<span>",{class:"period_remove",onclick:"period_remove("+day_id+")"})),$start={td:$("<div>",{class:"td td2 period_start display"}).attr({"data-dayid":day_id,"data-day":day_start==today?"今日":day_start_f,title:day_start_f,onclick:"period_editing_toggle(true, this.dataset.dayid)"}),td_inner:$("<div>",{onclick:"event.stopPropagation()"}),edit:$("<input>",{type:"date"}).attr({max:today,onchange:"period_update('start', "+day_id+", this.value)",required:!0,autofocus:!day_start}).val(day_start),ok:$("<div>",{class:"ok"}).attr({onclick:"period_editing_toggle('start', false, "+day_id+")"})},$end={td:$("<div>",{class:"td td2 period_end display"}).attr({"data-dayid":day_id,"data-day":day_end==today?"今日":day_end_f,title:day_end_f,onclick:"period_editing_toggle(true, this.dataset.dayid)",}),td_inner:$("<div>",{onclick:"event.stopPropagation()"}),edit:$("<input>",{type:"date"}).attr({list:"ls_"+day_id,min:!day_start?"":period_add_days(day_start,2),max:!day_start?today:[today,period_add_days(day_start,14)].reduce(function(a,b){return a<b?a:b}),onchange:"period_update('end', "+day_id+", this.value)",title:day_end_f,autofocus:!!day_start,disabled:!day_start}).val(day_end),list:$("<datalist>").attr({id:"ls_"+day_id}),ok:$("<div>",{class:"ok"}).attr({onclick:"period_editing_toggle('end', false, "+day_id+")"})};if(isSafari())
$start.edit.add($end.edit).each(function(){$(this).attr({type:"text",onclick:"$(this).datepicker('show')",readonly:!0}).datepicker({dateFormat:"yy-mm-dd",showAnim:"slideDown",minDate:$(this).attr("min")||"",maxDate:$(this).attr("max")||""})});$pd.find("[data-dayid='0']").parent().remove();$start=$start.td.html($start.td_inner.append($start.edit.add($start.ok)));for(d=6;d<9;d++)
$end.list.append($("<option>").val(period_add_days(day_start,d)));$end=$end.td.html($end.td_inner.append($end.edit.add($end.list).add($end.ok)));$("<div>",{class:"period tr"}).append($start.add($end).add($interval).add($remove)).prependTo($pd.find(".records"));if(!day_id)period_editing_toggle(!0,0);hj_mixpanel("Period Day Added",{day_id:day_id});ga_event_push("Period Day Added",{event_category:"Period Day",event_label:"Added"})}
function period_add_days(d,days){d=new Date(new Date(d).getTime()+days*8.64e7);return d.getFullYear()+"-"+("0"+(d.getMonth()+1)).slice(-2)+"-"+("0"+d.getDate()).slice(-2)}
function period_lookup(){var $pd=$(".periods");$pd.find(".records").slideUp("fast",function(){var raw=update({action:"period_lookup"});switch(raw.Status){case 1:var val=raw.Values,day_next=val.period_day_next;$pd.find(".day_cycle").text(val.period_day_cycle);$pd.find(".day_next").text(new Date(day_next).toLocaleDateString("zh-TW",{month:"long",day:"numeric"}));period_days_between(day_next);$pd.find(".period").remove();val.periods.forEach(function(d){period_add(d.day_id,d.day_start,d.day_end,d.day_interval)});if(val.periods.length>0)$pd.find(".prediction").slideDown();else $pd.find(".prediction").slideUp();period_remove_btn(!1);break}}).slideDown("slow");hj_mixpanel("Period Day Lookup");ga_event_push("Period Day Lookup",{event_category:"Period Day",event_label:"Lookup"})}
function period_editing_toggle(on,day_id){var $pd=$(".periods");$pd.find("[data-dayid]").addClass("display");if(on){$pd.find("[data-dayid='"+day_id+"']").removeClass("display").find("input").focus();period_remove_btn(!1)}}
function period_update(type,day_id,day){var $pd=$(".periods"),$r=$pd.find(".period_"+type+"[data-dayid='"+day_id+"']"),day_f=period_date_format(day);period_editing_toggle(!1,day_id);$r.attr({"data-day":day_f,title:day_f});var raw=update({action:"period_update",type:type,day_id:day_id||0,day:day});switch(raw.Status){case 1:var val=raw.Values,day_id_new=val.day_id;if(type=="start")
period_lookup();else if(!day_id)
$pd.find("[data-dayid=0]").attr({"data-dayid":day_id_new,onclick:"period_editing_toggle(true, "+day_id_new+");"});hj_mixpanel("Period Day Updated",{day_id:day_id});ga_event_push("Period Day Updated",{event_category:"Period Day",event_label:"Updated"});break;default:signin_required();break}}
function period_remove_btn(on){var $pd=$(".periods"),$i=$pd.find(".period_interval").add($pd.find(".day_trash")),$r=$pd.find(".period_removal");if(!$pd.find(".period").length){$r.fadeOut();$i.slideUp()}
else if(on){$r.fadeIn();$i.slideUp()}
else{$r.fadeOut();$i.slideDown()}}
function period_remove(day_id){var $pd=$(".periods");if(!day_id){$pd.find("[data-dayid=0]").parent().fadeOut(300,function(){$(this).remove()});return}
if(confirm("確定要刪除嗎？")){var raw=update({action:"period_remove",day_id:day_id});switch(raw.Status){case 1:period_lookup();$pd.find(".period_removal").fadeOut();hj_mixpanel("Period Day Removed",{day_id:day_id});ga_event_push("Period Day Removed",{event_category:"Period Day",event_label:"Removed"});break;default:signin_required();break}
period_remove_btn(!1)}}
function period_days_between(period_day){var now=new Date(new Date().setHours(0,0,0)),d_left=Math.round((new Date(new Date(period_day).setHours(0,0,0)).getTime()-now.getTime())/8.64e7),$d_left=$(".periods .days_left");switch(!0){case(d_left<=0):d_left=Math.abs(d_left);if(d_left<7)$d_left.text("第 "+(d_left+1)+"天");else $d_left.text("");break;case(d_left<=7):$d_left.text(d_left+"天後");break;default:$d_left.text(d_left+"天後");break}}