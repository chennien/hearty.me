function period_date_format(e){return new Date(e).toLocaleDateString("zh-TW",{month:"long",day:"numeric"})}function period_add(e,t,a,i){e=e||0;var o=(new Date).toJSON().slice(0,10),r=new Date((new Date).getTime()+864e5).toJSON().slice(0,10),n=(a=a||"",i=i||0,period_date_format((t=t||"")||o)),s=a?period_date_format(a):"",p=$(".periods"),_=$("<div>",{class:"td td1 period_interval"+(e>0&&(i<18||i>=38)?" ng":"")}).text(e>0?i:"");for($remove=$("<div>",{class:"td td1 period_removal",title:"刪除"}).html($("<span>",{class:"period_remove",onclick:"period_remove("+e+")"})),$start={td:$("<div>",{class:"td td2 period_start display"}).attr({"data-dayid":e,"data-day":t==o?"今日":n,title:n,onclick:"period_editing_toggle(true, this.dataset.dayid)"}),td_inner:$("<div>",{onclick:"event.stopPropagation()"}),edit:$("<input>",{type:"date"}).attr({max:r,onchange:"period_update('start', "+e+", this.value)",required:!0,autofocus:!t}).val(t),ok:$("<div>",{class:"ok"}).attr({onclick:"period_editing_toggle('start', false, "+e+")"})},$end={td:$("<div>",{class:"td td2 period_end display"}).attr({"data-dayid":e,"data-day":a==o?"今日":s,title:s,onclick:"period_editing_toggle(true, this.dataset.dayid)"}),td_inner:$("<div>",{onclick:"event.stopPropagation()"}),edit:$("<input>",{type:"date"}).attr({list:"ls_"+e,min:t?period_add_days(t,2):"",max:t?[o,period_add_days(t,14)].reduce(function(e,d){return e<d?e:d}):o,onchange:"period_update('end', "+e+", this.value)",title:s,autofocus:!!t,disabled:!t}).val(a),list:$("<datalist>").attr({id:"ls_"+e}),ok:$("<div>",{class:"ok"}).attr({onclick:"period_editing_toggle('end', false, "+e+")"})},isSafari()&&$start.edit.add($end.edit).each(function(){$(this).attr({type:"text",onclick:"$(this).datepicker('show')",readonly:!0}).datepicker({dateFormat:"yy-mm-dd",showAnim:"slideDown",minDate:$(this).attr("min")||"",maxDate:$(this).attr("max")||""})}),p.find("[data-dayid='0']").parent().remove(),$start=$start.td.html($start.td_inner.append($start.edit.add($start.ok))),d=6;d<9;d++)$end.list.append($("<option>").val(period_add_days(t,d)));$end=$end.td.html($end.td_inner.append($end.edit.add($end.list).add($end.ok))),$("<div>",{class:"period tr"}).append($start.add($end).add(_).add($remove)).prependTo(p.find(".records")),e||period_editing_toggle(!0,0),hj_mixpanel("Period Day Added",{day_id:e}),ga_event_push("Period Day Added",{event_category:"Period Day",event_label:"Added"})}function period_add_days(e,d){return(e=new Date(new Date(e).getTime()+864e5*d)).getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)}function period_lookup(){var e=$(".periods");e.find(".records").slideUp("fast",function(){var d=update({action:"period_lookup"});switch(d.Status){case 1:var t=d.Values,a=t.period_day_next;e.find(".day_cycle").text(t.period_day_cycle),e.find(".day_next").text(new Date(a).toLocaleDateString("zh-TW",{month:"long",day:"numeric"})),period_days_between(a),e.find(".period").remove(),t.periods.forEach(function(e){period_add(e.day_id,e.day_start,e.day_end,e.day_interval)}),t.periods.length>0?e.find(".prediction").slideDown():e.find(".prediction").slideUp(),period_remove_btn(!1)}}).slideDown("slow"),hj_mixpanel("Period Day Lookup"),ga_event_push("Period Day Lookup",{event_category:"Period Day",event_label:"Lookup"})}function period_editing_toggle(e,d){var t=$(".periods");t.find("[data-dayid]").addClass("display"),e&&(t.find("[data-dayid='"+d+"']").removeClass("display").find("input").focus(),period_remove_btn(!1))}function period_update(e,d,t){var a=$(".periods"),i=a.find(".period_"+e+"[data-dayid='"+d+"']"),o=period_date_format(t);period_editing_toggle(!1,d),i.attr({"data-day":o,title:o});var r=update({action:"period_update",type:e,day_id:d||0,day:t});switch(r.Status){case 1:var n=r.Values.day_id;"start"==e?period_lookup():d||a.find("[data-dayid=0]").attr({"data-dayid":n,onclick:"period_editing_toggle(true, "+n+");"}),hj_mixpanel("Period Day Updated",{day_id:d}),ga_event_push("Period Day Updated",{event_category:"Period Day",event_label:"Updated"});break;default:signin_required()}}function period_remove_btn(e){var d=$(".periods"),t=d.find(".period_interval").add(d.find(".day_trash")),a=d.find(".period_removal");d.find(".period").length?e?(a.fadeIn(),t.slideUp()):(a.fadeOut(),t.slideDown()):(a.fadeOut(),t.slideUp())}function period_remove(e){var d=$(".periods");if(e){if(confirm("確定要刪除嗎？")){switch(update({action:"period_remove",day_id:e}).Status){case 1:period_lookup(),d.find(".period_removal").fadeOut(),hj_mixpanel("Period Day Removed",{day_id:e}),ga_event_push("Period Day Removed",{event_category:"Period Day",event_label:"Removed"});break;default:signin_required()}period_remove_btn(!1)}}else d.find("[data-dayid=0]").parent().fadeOut(300,function(){$(this).remove()})}function period_days_between(e){var d=new Date((new Date).setHours(0,0,0)),t=Math.round((new Date(new Date(e).setHours(0,0,0)).getTime()-d.getTime())/864e5),a=$(".periods .days_left");switch(!0){case t<=0:(t=Math.abs(t))<7?a.text("第 "+(t+1)+"天"):a.text("");break;case t<=7:default:a.text(t+"天後")}}period_lookup();