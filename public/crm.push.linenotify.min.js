"use strict";function hj_update__push(a){return $.ajax({url:location.href,type:"post",crossDomain:!0,dataType:"json",data:a,async:!0,xhrFields:{withCredentials:!0}})}function get_recipients(){var a=$(".recipients"),e=parseInt($("input[name='uid_selection']:checked").val()||0),t=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),i=$("textarea[data-uid_listed]").val().split(",").map(function(a){return parseInt(a.trim())||1}).sort();a.slideUp("fast"),$(".recipient_data .result").empty(),hj_update__push({action:"get_recipients",uid_interval:0==e?JSON.stringify(t):"",uid_listed:1==e?JSON.stringify(i):""}).then(function(e){switch(e.Status){case 1:for(var t in e=e.Values,a.empty(),e){var i=e[t];for(var n in i.tokens){var s=i.username,r=parseInt(i.tokens[n].sent_today);$("<li>",{onclick:r>0?"alertify.error('* 略過寄送 #"+s+"')":"send_push(false,$(this))",title:s,"data-username":i.username,"data-nickname":i.nickname,"data-access_token":i.tokens[n].access_token,"data-device":5,"data-sent_today":r}).appendTo(a)}}a.slideDown("fast",function(){$("html, body").scrollTop(a.get(0).offsetTop-50)});break;case 2:a.show(),msg("<i class='far fa-exclamation-triangle'></i> 有資料漏填，或未選擇任何裝置")}}).fail(function(a){msg("<i class='far fa-exclamation-triangle'></i> 發生異常：<br>"+JSON.stringify(a))})}function send_push(a,e){if(a=a||!1,!(e=null==e?$(".recipients li[data-sent_today='0']:first"):e).length)return!1;var t=e.get(0).dataset,i=$(".push_data"),n={body:(i.find("[data-body]").val()||"").trim(),image:(i.find("[data-image]").val()||"").trim(),stickerid:parseInt(i.find("[data-stickerid]").val())||"",stickerid2:parseInt(i.find("[data-stickerid2]").val())||"",access_token:(t.access_token||"").trim(),username:(t.username||"").trim(),nickname:(t.nickname||"").trim()};if(n.body.length<4)return msg("<i class='far fa-exclamation-triangle'></i> 沒有填寫推播訊息"),!1;n.body=n.body.replace(/\{{username}}/g,n.username).replace(/\{{nickname}}/g,n.nickname),a?send_push_exec(n,a,e):(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-inbox-out'></i> 發送"},buttonReverse:!1}),alertify.confirm("<i class='far fa-comment-lines'></i> 即將推播予："+n.nickname+" ("+n.username+")",function(t){t||send_push_exec(n,a,e)}))}function send_push_exec(a,e,t){hj_update__push({action:"send_push",push:JSON.stringify(a)}).then(function(i){i.Values;switch(i.Status){case 1:console.log(JSON.stringify(i));break;case 3:alertify.error("<i class='far fa-exclamation-triangle'></i> 略過重複寄發："+a.username);break;case 4:alertify.error("<i class='far fa-comment-alt-times'></i> token 過期廢止");break;default:msg("<i class='far fa-exclamation-triangle'></i> 推播失敗<br>："+JSON.stringify(i))}if(e){var n=t.nextAll("[data-bulk='"+t.attr("data-bulk")+"']").eq(0);n.length>0?send_push(e,n):$(".recipients li[data-sent_today='0']").length||msg("<i class='far fa-comments-alt'></i> 批次推播完成","好耶",function(){$("html, body").scrollTop(0)})}t.remove(),$("<ol>",{title:a.nickname,onclick:"$(this).fadeOut('fast')","data-username":a.username,"data-success":+(1==i.Status),html:$("<li>",{"data-device":5,text:a.username}).add($("<li>",{text:a.body}))}).prependTo($(".result")).fadeIn()}).fail(function(a){msg("<i class='far fa-exclamation-triangle'></i> 發生異常：<br>"+JSON.stringify(a))})}function send_push_bulk(){var a=$(".recipients li[data-sent_today='0']"),e=a.length;e>0?(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-inbox-out'></i> 確定群發"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-comments-alt'></i> 即將推播至 "+e+"部用戶裝置",function(e){e||(send_push(!0,a.odd().attr({"data-bulk":"odd"}).eq(0)),send_push(!0,a.even().attr({"data-bulk":"even"}).eq(0)))})):msg("<i class='far fa-exclamation-triangle'></i> 沒有可發送的裝置，請先行查詢")}function filter_finished(a){var e=$(".recipients li[data-sent_today='1']");a?e.slideUp():e.slideDown()}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_all(a){var e=$(".user_data [data-uid_interval]");e.filter(":eq(0)").val(1).attr({max:a}),e.filter(":eq(1)").val(a).attr({max:a})}function uid_toggle(a,e){$(".user_data tr").attr("data-off","").filter(".uid_"+a).removeAttr("data-off"),alertify.success("<i class='fas fa-filter'></i> "+e+"模式")}$(function(){window.onbeforeunload=function(){return!1},$(document).scroll(function(){var a=$(".notify .page_up");$(this).scrollTop()>200?a.stop().fadeIn("slow"):a.stop().fadeOut("slow")}),getUrlPara("order_id")&&$("select[data-template]").val("unpaid_order").change()});