"use strict";function hj_update__push(t){return $.ajax({url:location.href,type:"post",crossDomain:!0,dataType:"json",data:t,async:!0,xhrFields:{withCredentials:!0}})}function get_sent_stats(){hj_update__push({action:"get_sent_stats"}).then(function(t){t=t.Values,$("[data-sent_stats]").text(t.date+" 午夜起，已寄給 "+numberWithCommas(t.users_sent||0)+"人，共 "+numberWithCommas(t.pushs_sent||0)+"則")})}function get_recipients(){var t=$(".recipients"),e=parseInt($("input[name='uid_selection']:checked").val()||0),a=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),s=$("textarea[data-uid_listed]").val().split(",").map(function(t){return parseInt(t.trim())||1}).sort();t.slideUp("fast"),$(".recipient_data .result").empty(),hj_update__push({action:"get_recipients",uid_interval:0==e?JSON.stringify(a):"",uid_listed:1==e?JSON.stringify(s):""}).then(function(e){switch(e.Status){case 1:for(var a in e=e.Values,t.empty(),e){var s=e[a];for(var n in s.tokens){var i=s.username,r=parseInt(s.tokens[n].sent_today);$("<li>",{onclick:r>0?"alertify.error('* 略過寄送 #"+i+"')":"send_push(false,$(this))",title:i,"data-username":s.username,"data-nickname":s.nickname,"data-access_token":s.tokens[n].access_token,"data-device":5,"data-sent_today":r}).appendTo(t)}}t.slideDown("fast",function(){$("html, body").scrollTop(t.get(0).offsetTop-50)});break;case 2:t.show(),msg("<i class='far fa-exclamation-triangle'></i> 有資料漏填，或未選擇任何裝置")}}).fail(function(t){msg("<i class='far fa-exclamation-triangle'></i> 發生異常：<br>"+JSON.stringify(t))})}function send_push(t,e){if(t=t||!1,!(e=null==e?$(".recipients li[data-sent_today='0']:first"):e).length)return!1;var a=e.get(0).dataset,s=$(".push_data"),n={body:(s.find("[data-body]").val()||"").trim(),image:(s.find("[data-image]").val()||"").trim(),stickerid:parseInt(s.find("[data-stickerid]").val())||"",stickerid2:parseInt(s.find("[data-stickerid2]").val())||"",access_token:(a.access_token||"").trim(),username:(a.username||"").trim(),nickname:(a.nickname||"").trim()};if(n.body.length<4)return msg("<i class='far fa-exclamation-triangle'></i> 沒有填寫推播訊息"),!1;n.body=n.body.replace(/\{{username}}/g,n.username).replace(/\{{nickname}}/g,n.nickname),t?send_push_exec(n,t,e):(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-inbox-out'></i> 發送"},buttonReverse:!1}),alertify.confirm("<i class='far fa-comment-lines'></i> 即將推播予："+n.nickname+" ("+n.username+")",function(a){a||send_push_exec(n,t,e)}))}function send_push_exec(t,e,a){hj_update__push({action:"send_push",push:JSON.stringify(t)}).then(function(s){switch(s.Values,s.Status){case 1:console.log(JSON.stringify(s));break;case 3:alertify.error('<i class="fas fa-exclamation-triangle"></i> 略過重複寄發：'+t.username);break;case 4:alertify.error("<i class='far fa-comment-alt-times'></i> token 過期廢止");break;default:msg("<i class='far fa-exclamation-triangle'></i> 推播失敗<br>："+JSON.stringify(s))}if(e){var n=a.nextAll("[data-bulk='"+a.attr("data-bulk")+"']").eq(0);n.length>0?send_push(e,n):$(".recipients li[data-sent_today='0']").length||(get_sent_stats(),msg("<i class='far fa-comments-alt'></i> 批次推播完成","好耶",function(){$("html, body").scrollTop(0)}))}a.remove(),$("<ol>",{title:t.nickname,onclick:"$(this).fadeOut('fast')","data-username":t.username,"data-success":+(1==s.Status),html:$("<li>",{"data-device":5,text:t.username}).add($("<li>",{text:t.body}))}).prependTo($(".result")).fadeIn()}).fail(function(t){msg("<i class='far fa-exclamation-triangle'></i> 發生異常：<br>"+JSON.stringify(t))})}function send_push_bulk(){var t=$(".recipients li[data-sent_today='0']"),e=t.length;e>0?(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-inbox-out'></i> 確定群發"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-comments-alt'></i> 即將推播至 "+e+"部用戶裝置",function(e){e||(send_push(!0,t.odd().attr({"data-bulk":"odd"}).eq(0)),send_push(!0,t.even().attr({"data-bulk":"even"}).eq(0)))})):msg("<i class='far fa-exclamation-triangle'></i> 沒有可發送的裝置，請先行查詢")}function filter_finished(t){var e=$(".recipients");t?e.addClass("unfinished"):e.removeClass("unfinished")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_all(t){var e=$(".user_data [data-uid_interval]");e.filter(":eq(0)").val(1).attr({max:t}),e.filter(":eq(1)").val(t).attr({max:t})}function uid_toggle(t,e){$(".user_data tr").attr("data-off","").filter(".uid_"+t).removeAttr("data-off"),alertify.success("<i class='fas fa-filter'></i> "+e+"模式")}$(function(){get_sent_stats(),window.onbeforeunload=function(){return!1},$(document).scroll(function(){var t=$(".notify .page_up");$(this).scrollTop()>200?t.stop().fadeIn("slow"):t.stop().fadeOut("slow")}),getUrlPara("order_id")&&$("select[data-template]").val("unpaid_order").change()});