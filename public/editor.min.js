"use strict";if(window.top.location.href!==window.self.location.href)
window.top.location.href=window.self.location.href;(function($){$(document).ready(function(){d1=$.when(d0,hj_getScript("//cdn.jsdelivr.net/gh/godswearhats/jquery-ui-rotatable@1.1.1/jquery.ui.rotatable.min.js"),hj_getScript("//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"),hj_getScript("//cdnjs.cloudflare.com/ajax/libs/interact.js/1.2.9/interact.min.js")).then(function(){stickers__initialize();editor_include_once();editor_enable()});compatibility_handle();catalog_query();editor_versioning(!0,hj_version);$(".popup-underlayer .popup, .popup.feedback, .popup.diary_screenshot a, .prologue .start, .asset .detach").on("click",function(e){e.stopPropagation()});hj_mixpanel("Post Loaded",{post_id:post_id});ga_event_push("Post Loaded",{event_category:"Posts",event_label:"Post Loaded"})})})(jQuery);var l=window.location;if(typeof history.replaceState==="function"&&/(beta|classic)/.test(l.pathname))
window.history.replaceState({},document.title,l.href.replace(/beta\/|classic\//g,""));function hj_idle(){var $t=$(".editor_toolbelt"),$sl=$(".screenlock"),toolbar_enabled=!is_touch_device()&&current_post()["editable"];$(document).mousemove(hj_motion).keypress(hj_motion);$("#editor_editable").keydown(hj_motion);hj_motion();window.setInterval(function(){var t=Number(hj__cache({bucket:"hearty_idle"}));t++;hj__cache({set:!0,bucket:"hearty_idle",data:t});switch(!0){case(t>3&&autosave_the_change()):break;case(t>7&&toolbar_enabled&&$t.is(":visible")):$t.slideUp("slow");break;case(t>119&&screenlock("status")&&$sl.is(":hidden")):screenlock(!0);break}},1000);function hj_motion(){hj__cache({set:!0,bucket:"hearty_idle",data:0});if(toolbar_enabled)$t.slideDown("normal")}}
function editor_versioning(init,ver_current){var bucket="hearty_editor_version",d=new Date();d.setTime(d.getTime()+8.64e7);ver_current=Number(ver_current)||0;if(init){document.cookie=bucket+"="+ver_current+"; expires="+d.toGMTString()+"; path=/"}
else{var ver_recorded=Number(getcookie(bucket))||0,ver_latest=0;if(!ver_recorded){var r=update({action:"versioning_diary"});if(r.Status===1&&"latest" in r.Values)ver_latest=Number(r.Values.latest)||0}
if(ver_current<ver_recorded||ver_current<ver_latest){autosave_the_change();document.cookie=bucket+"="+ver_current+"; expires="+d.toGMTString()+"; path=/";hj_mixpanel("Force Update",{version:ver_latest});ga_event_push("Force Update");window.location.reload(!0)}}}
function editor_enable(on){on=on||current_post()["editable"]||!1;var $e=$(".bk-page #editor_editable"),loaded=$e.data("editor_loaded")||!1,$bn=$(".picture").find(".fa-video-plus, .fa-camera-alt");if(on){if(!loaded){editable__initialize();hj_idle();screenlock("initialize",pincode||"");hj_getScript("//cdn.jsdelivr.net/gh/chennien/hearty.me@a35cd014d5d58ea8feb318c60e7fa0486fbc90cf/public/jquery.uploadfile.min.js",image_uploader_initialize);$e.data("editor_loaded",!0);$bn.slideDown();$(".editor_toolbelt .kit.save").on("mouseover",autosave_the_change)}
sticker__list();mobile_editor_focus()}
else{sticker__list(!1);$bn.slideUp()}
$e.prop("contenteditable",on);toolbelt_toggle(on)}
function editor_include_once(){var post_modified=new MutationObserver(function(m){m.forEach(saved)}).observe($("#editor_editable").get(0),{characterData:!0,subtree:!0});autosaver_30s();document.addEventListener("visibilitychange",function(){if(document.hidden)autosave_the_change();else editor_versioning(!1,hj_version)});if(/iPhone|iPad|iPod/i.test(navigator.userAgent||"")){if(current_post()["editable"])window.addEventListener("pagehide",post_revise,!1)}}
function editor_editable_scroll_to_bottom(e,el){if(is_touch_device()&&e.keyCode==13){var $b=$(".bk-page"),range=window.getSelection().getRangeAt(0),r=document.createRange();r.selectNodeContents(el);r.setStart(range.endContainer,range.endOffset);if(r.cloneContents().textContent.toString().length<2)
$b.scrollTop($b.find("#editor_editable").height()+20)}}
function toolbelt_toggle(on){var $b=$(".btn_stickerbook"),$t=$(".editor_toolbelt");if(on){$b.show();$t.removeClass("off")}
else{$b.hide();$t.addClass("off")}}
function page_gps_trigger(s){var $g=$("#gps_trigger");switch(s){case "granted":$g.removeAttr("onclick").css("background","#00c78c").text("已開啟");break;case "prompt":$g.attr("onclick","page_gps_trigger('loading'); positioning_gps_trigger(!0);").css("background","#ffa500").text("點此開啟定位");break;case "denied":$g.attr("onclick","window.open(positioning_gps_reset_support(), '_blank');").css("background","#c40000").text("需設定瀏覽器");break;case "loading":$g.css("background","#555").text("請稍候");break}}
function sticker__draggable_handle(bundle_id,asset_id){var $a=$(".bundle .asset[data-asset_id='"+asset_id+"']"),$i=$a.children(".sticker_img"),editor_width=$("#editor").width(),editor_scrolled=$(".bk-list .bk-page").scrollTop()||0,editor_topmargin=$("#editor").get(0).offsetTop,top=$a.position().top+editor_scrolled-editor_topmargin,left=$a.get(0).offsetLeft,right=editor_width-(left+$i.width())-30;if(right>0){right=Math.max(0,Math.ceil(right+$i.width()-$i.get(0).getBoundingClientRect().width))}
var pos={top:top,left:left,right:right,align_right:left+$a.width()/2>Math.floor(editor_width/2)?1:0};return{pos:pos,overflow:{top:top>0,left:left>0,right:right>0}}}
function sticker__editor_hotkeys(on,bundle_id,asset_id){$(document).off("keydown");if(on){$(document).on("keydown",function(e){e.preventDefault();var $a=$(".bundle .asset[data-asset_id='"+asset_id+"']"),before={top:parseInt($a.css("top"))||0,left:parseInt($a.css("left"))||0},current=Object.assign({},before);switch(e.keyCode){case 13:case 27:case 32:sticker__paste({bundle_id:bundle_id,asset_id:asset_id});return;break;case 37:current.left-=15;break;case 38:current.top-=15;break;case 39:current.left+=15;break;case 40:current.top+=15;break;case 8:case 46:sticker__remove({bundle_id:bundle_id,asset_id:asset_id});return;break}
var c=sticker__draggable_handle(bundle_id,asset_id);if(!c.overflow.left)current.left=5;else if(!c.overflow.right)current.left=before.left-15;else if(!c.overflow.top)current.top=before.top+15;else sticker__update(bundle_id,asset_id,"position",c.pos);$a.animate(current,25);var view=parseInt($a.get(0).offsetTop-$(".bk-list .bk-page").height()*2/5);if(view<$(".bk-list .bk-page").height()+100)
$(".bk-list .bk-page").animate({scrollTop:view},60)})}}
function network_status(issues,status){var $w=$(".warning-underlayer");if(issues.length>0)
issues.forEach(function(issue){if(status)$w.filter("."+issue).slideDown("fast");else $w.filter("."+issue).fadeOut()})}
function flip_book(){$(".bk-flip").click()}
function book__initialize(open){var Books=(function(){var $books=$(".bk-list .bk-book"),booksCount=$books.length;function init(){$books.each(function(){var $book=$(this),$other=$books.not($book),$parent=$book.parent(),$read=$(".bk-read"),$flip=$(".bk-flip");$read.on("click",function(){var $this=$(this);$other.data("opened",!1).removeClass("bk-viewinside").parent().css("z-index",0).find(".bk-read").removeClass("bk-active");if(!$other.hasClass("bk-filp"))
$other.addClass("bk-default");if($book.data("opened")){$this.removeClass("bk-active");$book.data({opened:!1,flip:!1}).removeClass("bk-viewinside").addClass("bk-default")}
else{$this.addClass("bk-active");$book.data({opened:!0,flip:!1}).removeClass("bk-filp bk-default").addClass("bk-viewinside");$parent.css("z-index",booksCount)}});$flip.on("click",function(){$read.removeClass("bk-active");if($book.data("flip"))
$book.data({opened:!1,flip:!1}).removeClass("bk-filp").addClass("bk-default");else $book.data({opened:!1,flip:!0}).removeClass("bk-viewinside bk-default").addClass("bk-filp")})})}
return{init:init}})();Books.init();$(".mask_loading").delay(300).queue(function(){$(this).fadeOut("fast",function(){if(!$(".bk-viewinside").length){$(".bk-list .bk-book").addClass("bk-rotate").delay(100).queue(function(){if(open)open_book(!0);$(this).removeClass("bk-rotate").dequeue();window.d0.resolve()})}}).dequeue()});$(".bk-list .bk-cover, .bk-left").on("click",function(){open_book(!0);$(".bk-page, .bk-cover-back .catalog").scrollTop(0)});$(".bk-list .bk-back").on("click",flip_book);$(".bk-underlayer").on("click",function(){if($(".bk-page .sticker_editing").length>0)sticker__paste();else if($(".bk-viewinside").length>0)open_book(!1);else flip_book()});$(".stickerbook .stickerlist .stickerdir").scroll(function(){if($(this).scrollTop()>200)$(".stickerbook .fa-chevron-square-up").fadeIn();else $(".stickerbook .fa-chevron-square-up").fadeOut();if($(".item[data-sticker='0']:visible").length>0)
$(this).data("scrolled",$(this).scrollTop())});$(".bk-list .bk-page, .bk-cover-back .catalog").delay(800).queue(function(){$(this).scrollTop(0).dequeue()});var ua=navigator.userAgent||"";if(ua.indexOf("Edge/")>0)$(".bk-cover-back .catalog").scrollTop($(".bk-cover-back .catalog").get(0).scrollHeight)}
function editable__initialize(){if(is_touch_device()){$(".bk-list .bk-page").get(0).addEventListener("touchmove",function(e){if(e.cancelable)return!0},{passive:!0})}
if(!cssFeatureSupported("-webkit-user-modify","read-write-plaintext-only")){$("#editor_editable").keydown(function(e){if(e.keyCode==13){document.execCommand("insertHTML",!1,"<br> ");return!1}})}}
function period__initialize(){var $pd=$(".periods");if(!$pd.data("loaded")){hj_getScript("//cdn.jsdelivr.net/gh/chennien/hearty.me@77a1dea85a903733969853de70bf9b8f7a22024d/public/periods.min.js",function(){$pd.slideDown("slow").data("loaded",!0)})}}
function createCaretPlacer(atStart){var el=$(".bk-page #editor_editable").get(0);el.focus({preventScroll:!1});if(!(window.getSelection==null)&&!(document.createRange==null)){var range=document.createRange();range.selectNodeContents(el);range.collapse(atStart);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range)}
else if(!(document.body.createTextRange==null)){var textRange=document.body.createTextRange();textRange.moveToElementText(el);textRange.collapse(atStart);textRange.select()}}
function compatibility_handle(){var ua=(navigator.userAgent||"").toLowerCase(),isWebView=ua.indexOf("version/")>0&&ua.indexOf("; wv")>0,w=window.innerWidth;if(!cssFeatureSupported("width","calc(100%-1em)")&&w<1024){$(".bk-list, .bk-front, .bk-back, .bk-cover").width(w*0.85);$(".bk-list .bk-page, .bk-cover-back").width(w*0.82)}
if(!cssFeatureSupported("transition","transform")&&!cssFeatureSupported("-webkit-transition","transform")&&!cssFeatureSupported("moz-transition","transform")){if(isWebView){if(confirm("手機裡的系統程式太舊，是否要試著更新？ \nℹ️ 缺少功能：CSS Transitions"))
window.open("market://details?id=com.google.android.webview")}
else{hj_alert("請更新瀏覽器\nℹ️ 缺少功能：CSS Transitions")}}}
function catalog_query(){var $catalog=$(".catalog"),bucket="hearty_diaries_"+hj_writer+"__"+bucket_suffix(),catalog={},diaries=[];var post;if(!Object.keys(catalog).length){var r=update({action:"catalog_page",writer:hj_writer,page:0});switch(r.Status){case 0:case 2:update_failed();break;case 1:r.Values.catalog.forEach(function(post,n){catalog[post.post_id]={title:post.title,post_id:post.post_id,privacy:post.privacy,page:Math.ceil((n+1)/10)}});hj__cache({set:!0,bucket:bucket,data:JSON.stringify(catalog)});break}}
for(var post_id in catalog){post=catalog[post_id];diaries.unshift($("<li>",{title:"📝 "+post.title,onclick:'if(!post_query(this.dataset.post_id)) $(this).remove();',"data-post_id":post_id,"data-page":post.page,"data-privacy":post.privacy,}).text(post.title))}
$catalog.find(".diaries").html(diaries);if($(".bk-cover-back .catalog").get(0).scrollHeight>$(".bk-cover-back > div").height()){$(".bk-cover-back .catalog").scroll(function(){if($(this).scrollTop()>100)$(".bk-cover-back .fa-chevron-square-up").fadeIn();else $(".bk-cover-back .fa-chevron-square-up").fadeOut()})}
$(".catalog-mobile > div > div").scroll(function(){if($(this).scrollTop()>100)$(".catalog-mobile .fa-chevron-square-up").fadeIn();else $(".catalog-mobile .fa-chevron-square-up").fadeOut()})}
function catalog_lookup(post_id){var catalog=catalog_cached();if(catalog==null){catalog_query();return!1}
else{var post_ids=Object.keys(catalog);if(post_ids.length>0){if(post_id>0)return post_id in catalog?catalog[post_id]:null;else if(post_id===0)return catalog[post_ids[post_ids.length-1]];else if(post_id===-1)return catalog[post_ids[0]]}
return null}}
function catalog_page(page,post_id,btn){var page=Number(page)||1,$catalog=$(".catalog"),$diaries=$catalog.find(".diaries"),$pagination=$catalog.find(".pagination");$diaries.children("li[data-active]").removeAttr("data-active");if(post_id!==null&&post_id>0){var post=catalog_lookup(post_id);if(post==null){catalog_page(1,null);return!1}
else if(!post){catalog_page(null,post_id);return!1}
else{page=post.page;$diaries.children("li[data-post_id='"+post_id+"']").attr("data-active","")}}
else if(btn!==null){$(btn).filter(".fal").toggleClass("fal fas").delay(450).queue(function(){$(this).toggleClass("fas fal").dequeue()})}
if(page>1)
$pagination.children(".fa-caret-circle-left").attr("onclick","$(this).removeAttr('onclick'); catalog_page("+(page-1)+", null, this);").removeClass("disabled");else $pagination.children(".fa-caret-circle-left").addClass("disabled");if($diaries.children("li[data-page='"+(page+1)+"']").length>0)
$pagination.children(".fa-caret-circle-right").addClass("disabled").attr("onclick","$(this).removeAttr('onclick'); catalog_page("+(page+1)+", null, this);").removeClass("disabled");else $pagination.children(".fa-caret-circle-right").addClass("disabled");$diaries.children("li").not("[data-page="+page+"]").hide();$diaries.children("li[data-page="+page+"]").fadeIn("slow")}
function catalog_cached(){var bucket="hearty_diaries_"+hj_writer+"__"+bucket_suffix(),r=hj__cache({bucket:bucket});return r==null?null:JSON.parse(r)||{}}
function stickers__initialize(){sticker__uniqID(!0);stickers__detach();var r=update({action:"sticker_query",post_id:current_post()["post_id"]});switch(r.Status){case 1:var bundles=r.Values;sticker__save_local(bundles);bundles.forEach(function(bundle){sticker__createDOM(bundle.id,bundle)});break;case 2:signin_required();break;default:hj_alert("發生錯誤");break}}
function sticker__initialize(bundle_id,asset_id,sticker){var $a=$(".bundle .asset[data-asset_id='"+asset_id+"']"),$i=$a.children(".sticker_img"),blank=sticker__new_blank("asset",bundle_id,sticker);if("angle" in sticker)
$i.css({"transform":"rotate("+sticker.angle.deg+"deg)"});else sticker.angle=blank.angle;if("size" in sticker)
$i.css({width:sticker.size.width,height:sticker.size.height});else sticker.size=blank.size;if("position" in sticker)
$a.css({"top":sticker.position.top,"left":sticker.position.left});else sticker.position=blank.position;if(current_post()["editable"])sticker__editor_initialize(bundle_id,asset_id,sticker);else sticker__paste({bundle_id:bundle_id,asset_id:asset_id})}
function sticker__editor_initialize(bundle_id,asset_id,sticker){var touch_device=is_touch_device(),$a=$(".bundle .asset[data-asset_id='"+asset_id+"']"),$i=$a.children(".sticker_img");$a.draggable({start:function(e,ui){if(touch_device)$i.addClass("dragging");else $i.addClass("grabbing");if($i.hasClass("dragthis"))$i.removeClass("dragthis")},stop:function(e,ui){e.stopPropagation();var c=sticker__draggable_handle(bundle_id,asset_id);sticker__update(bundle_id,asset_id,"position",c.pos);if(touch_device)$i.removeClass("dragging");else $i.removeClass("grabbing")},snap:!0,containment:"#editor",scroll:!1,cursor:"move",grid:[5,5],cancel:".ui-rotatable-handle"});var angle=sticker.angle.deg,angle_rad=angle/57.296,params={angle:angle_rad,rotationCenterOffset:{top:0,left:0},start:function(e){$i.data("rotate-mode",1)},rotate:function(e,ui){if($i.data("rotate-mode")===0){e.preventDefault();angle_rad=ui.angle.current;angle=ui.angle.degrees;sticker__update(bundle_id,asset_id,"angle",{deg:angle,rad:angle_rad});sticker__rotation_margin_fixes(bundle_id,asset_id)}},stop:function(e,ui){angle_rad=ui.angle.current;angle=ui.angle.degrees;sticker__update(bundle_id,asset_id,"angle",{deg:angle,rad:angle_rad});$i.data("rotate-mode",0);sticker__rotation_margin_fixes(bundle_id,asset_id)},rotationCenterOffset:{top:0,left:0},wheelRotate:!0};$i.rotatable(params).data("rotate-mode",0);$i.find(".ui-rotatable-handle").remove();var se=$("<div>",{class:"ui-rotatable-handle",title:"旋轉"});if(!touch_device){var ne=se.clone(),nw=se.clone(),sw=se.clone();ne.addClass("ui-rotatable-handle-ne");nw.addClass("ui-rotatable-handle-nw");sw.addClass("ui-rotatable-handle-sw");$i.append(ne,nw,sw)}
se.addClass("ui-rotatable-handle-se segrip");$i.append(se);$i.find("div[class*='ui-rotatable-handle-']").bind("mousedown",function(e){$i.rotatable("instance").startRotate(e)});if(!touch_device){var aspect_ratio=$i.width()/$i.height(),handles=touch_device?{}:{n:".ngrip",e:".egrip",s:".sgrip"};$i.resizable({resize:function(e,ui){$a.css({"min-width":ui.size.width})},stop:function(e,ui){sticker__update(bundle_id,asset_id,"size",{width:ui.size.width,height:Math.round(ui.size.height)});$(this).height(ui.size.width/aspect_ratio).css({top:0,left:0})},containment:"#editor",aspectRatio:!0,grid:5,minWidth:80,minHeight:80,maxWidth:$("#editor_editable").width()*0.85,maxHeight:640,handles:handles})}
if(touch_device){$(".ui-resizable-n, \
			.ui-resizable-e, \
			.ui-resizable-s").remove();$i.get(0).addEventListener("touchmove",function(e){if("touches" in e){var dist={x:0,y:0,sum:0},sum=hj__cache({bucket:"hearty_sticker_finger_gap"})||null,gap=0,width=$i.width(),height=$i.height(),width_ceil={max:$("#editor_editable").width()*0.85,min:80},zoom_ratio=1;if(!$i.data("aspect_ratio")){var aspect_ratio=width/height;$i.data("aspect_ratio",aspect_ratio)}
else{var aspect_ratio=$i.data("aspect_ratio")}
if(e.touches.length>1){dist.x=Math.abs(e.touches[1].pageX-e.touches[0].pageX);dist.y=Math.abs(e.touches[1].pageY-e.touches[0].pageY);dist.sum=Math.floor(Math.sqrt(Math.floor(dist.x**2+dist.y**2)));if(sum!==null)gap=dist.sum-sum;gap=isNaN(gap)?0:gap;hj__cache({set:!0,bucket:"hearty_sticker_finger_gap",data:dist.sum});zoom_ratio=gap/width*0.4;width+=width*zoom_ratio;height=width/aspect_ratio;if(width<width_ceil.min){height*=width_ceil.min/width;width=width_ceil.min}
else if(width>width_ceil.max){height*=width_ceil.max/width;width=width_ceil.max}
width=Math.round(width*1000)/1000;height=Math.round(height*1000)/1000;var icon_size=Math.floor(Math.min(width,height)*0.45);$i.width(width).height(height).css({"font-size":icon_size>100?100:icon_size});sticker__update(bundle_id,asset_id,"size",{"width":width,"height":height});if(Math.abs(gap)>0&&$i.hasClass("rotating"))$i.removeClass("rotating");$i.addClass("resizing");if($i.hasClass("dragthis"))$i.removeClass("dragthis")}}},{passive:!0});$i.get(0).addEventListener("touchend",function(e){hj__cache({set:!0,bucket:"hearty_sticker_finger_gap"});$i.removeClass("resizing")},{passive:!0});window.interact(".asset[data-asset_id='"+asset_id+"']").on("hold",function(e){if($(".asset[data-asset_id='"+asset_id+"'] .sticker_editing").length===0){sticker__cut({bundle_id:bundle_id,asset_id:asset_id});if("vibrate" in navigator)navigator.vibrate([80])}});var angle=parseFloat(sticker.angle.deg),angle_rad=angle/57.296;window.interact(".asset[data-asset_id='"+asset_id+"'] .sticker_img").gesturable({onmove:function(e){angle+=e.da;$i.css({"-webkit-transform":"rotate("+angle+"deg)","-ms-transform":"rotate("+angle+"deg)","transform":"rotate("+angle+"deg)"});if(angle>360)angle-=360;else if(angle<0)angle+=360;angle_rad=angle/57.296;sticker__update(bundle_id,asset_id,"angle",{deg:angle,rad:angle_rad});sticker__rotation_margin_fixes(bundle_id,asset_id);if(Math.abs(e.da)>0.5)$i.removeClass("resizing").addClass("rotating");sticker__log("* 更新貼紙角度 "+asset_id+"："+parseFloat(angle).toFixed(2)+' °')}}).on({gestureend:function(e){$i.removeClass("rotating")}});$i.css({"-webkit-transform":"rotate("+angle+"deg)","-ms-transform":"rotate("+angle+"deg)","transform":"rotate("+angle+"deg)"})}
sticker__paste({bundle_id:bundle_id,asset_id:asset_id});sticker__log("🏮 初始化貼紙："+bundle_id+"（"+asset_id+"）")}
function stickers__detach(){sticker__save_local([]);$("#editor .bundle").remove()}
function sticker__oncreate(sticker,premium){var post_id=current_post()["post_id"];if(Number(premium)>0){nav_toggle($(".stickerbook"),!1);popup_toggle(!0,"upgrade")}
else{sticker__create(sticker)}
hj_mixpanel("Sticker Created",{post_id:post_id,sticker_set_num:sticker.set_num,sticker_set_alias:sticker.set_alias,sticker_num:sticker.num,sticker_name:sticker.name});ga_event_push("Sticker Create",{event_category:"Posts",event_label:"Sticker Create"})}
function sticker__create(item,bundle_id){if(!current_post()["editable"])return!1;var r=sticker__lookup("page"),page="page" in r[1]?r[1].page:{},bundles="bundles" in r[1]?r[1].bundles:[],new_bundle=bundle_id==null,asset_id=sticker__uniqID(),asset_max={width:160,height:160},asset_ratio=Math.min(asset_max.width/item.width,asset_max.height/item.height);var bundle;item.width=Math.ceil(item.width*asset_ratio);item.height=Math.ceil(item.height*asset_ratio);item.align_right=1;if(new_bundle){bundle_id=sticker__uniqID();bundle=sticker__new_blank("bundle",bundle_id,item);var sum_arr=bundles.map(function(v,i){return bundles[i].position.sum});sum_arr.push(0);var last_sum_in_bundles=Math.max.apply(null,sum_arr);bundle.position.top=last_sum_in_bundles;page[bundle_id]=bundle;var editor_scrolled=$(".bk-list .bk-page").scrollTop()||0,editor_readable={width:$("#editor").width()||0,height:$(".bk-list .bk-page").height()||0},editor_topmargin=$("#editor").get(0).offsetTop;if(editor_scrolled<editor_topmargin){editor_scrolled=editor_topmargin;$(".bk-list .bk-page").animate({scrollTop:editor_scrolled},100)}
var pos={move:{top:editor_scrolled-editor_readable.height*0.5-last_sum_in_bundles},def:{top:editor_scrolled-editor_topmargin+editor_readable.height*0.5-item.height+50,left:!item.align_right?editor_readable.width*0.1||0:editor_readable.width-item.width||0,}},default_position={top:Math.ceil(pos.move.top),left:Math.round(pos.move.left)}}
else{var default_position=null;bundle=page[bundle_id]}
page[bundle_id].assets[asset_id]=bundle.assets[asset_id]=sticker__new_blank("asset",bundle_id,item);bundles=Object.keys(page).map(function(k){return page[k]});sticker__save_local(bundles);sticker__createDOM(bundle_id,bundle,default_position);if(new_bundle){bundle.position=bundle.assets[asset_id].position={top:Math.floor(pos.def.top),left:Math.round(pos.def.left),right:0,align_right:1};page[bundle_id].assets[asset_id]=bundle.assets[asset_id];sticker__update(bundle_id,asset_id,"position",bundle.assets[asset_id].position);var asset=bundle.assets[asset_id],r=update({action:"sticker_create",post_id:current_post()["post_id"],data:{bundle_id:bundle_id,asset_id:asset_id,bundle_top:bundle.position.top,bundle_left:bundle.position.left,bundle_right:bundle.position.right,bundle_align_right:bundle.position.align_right,item_num:asset.item_num,asset_width:asset.size.width,asset_height:asset.size.height}});switch(r.Status){case 0:update_failed();return;break;case 2:signin_required();return;break;case 3:hj_alert("超過貼紙數上限");return;break}}
sticker__cut({bundle_id:bundle_id,asset_id:asset_id});open_book(!0);if("vibrate" in navigator)navigator.vibrate([30]);sticker__log("➕ 新增貼紙："+bundle_id+"（"+asset_id+"）")}
function sticker__createDOM(bundle_id,bundle,default_pos){var $a,$b,$i,asset,item;$b=$("<div>",{class:"bundle","data-bundle_id":bundle_id,onContextMenu:"return false;"}).html($("<div>",{class:"bundle_innerbox"})).data("bundle-id",bundle_id).insertBefore("#editor_editable");for(var asset_id in bundle.assets){asset=bundle.assets[asset_id];$a=$(".hj-sample .asset").clone().attr({title:asset.item_name,"data-editing":!0,"data-bundle_id":bundle_id,"data-asset_id":asset_id}).data("asset-id",asset_id).fadeTo("slow",0.35);$b.children(".bundle_innerbox").append($a);$i=$(".asset[data-asset_id='"+asset_id+"'] .sticker_img");$i.width(asset.size.width).height(asset.size.height).addClass("dragthis").css({"background-image":"url('//"+wpCDN+"/s.hearty.me/images/stickers/"+asset.set_alias+"/"+asset.item_num+".png'), url('//"+wpCDN+"/c.hearty.me/images/stickers/"+asset.set_alias+"/"+asset.item_num+".png'), url('//c.hearty.me/images/stickers/"+asset.set_alias+"/"+asset.item_num+".png')"});if(is_touch_device()){$i.children(".detach").get(0).addEventListener("touchmove",function(e){e.stopPropagation()},{passive:!0})}
if(default_pos==null)
$a.fadeTo("slow",1);else window.setTimeout(function(){$a.animate(default_pos,150).fadeTo("slow",1)},0);sticker__initialize(bundle_id,asset_id,bundle.assets[asset_id])}}
function sticker__rotation_margin_fixes(bundle_id,asset_id){var $a=$(".bundle .asset[data-asset_id='"+asset_id+"']"),$i=$a.children(".sticker_img"),bundle_width=Math.floor($i.get(0).getBoundingClientRect().width*0.9),bundle_height=Math.floor($i.get(0).getBoundingClientRect().height*0.9);sticker__log("貼紙尺寸："+bundle_width+" x "+bundle_height);if(!bundle_width||!bundle_height)return!1;sticker__update(bundle_id,asset_id,"size",{width:bundle_width,height:bundle_height},!0);$a.css({"min-width":bundle_width,"max-height":bundle_height})}
function sticker__new_blank(scope,bundle_id,item){var blank={};blank.position={"top":isNaN(item.top)?0:item.top,"left":isNaN(item.left)?0:item.left,"right":isNaN(item.right)?0:item.right,"topmargin":0,"align_right":isNaN(item.align_right)?0:item.align_right};blank.size={"width":item.width,"height":item.height};if(scope=="asset"){blank.item_num=isNaN(item.num)?0:item.num;blank.item_name=item.name;blank.set_num=isNaN(item.set_num)?0:item.set_num;blank.set_alias=item.set_alias;blank.angle={"deg":0,"rad":0}}
else if(scope=="bundle"){blank.id=bundle_id||sticker__uniqID();blank.assets={};blank.position.sum=0}
return blank}
function sticker__exec(mode,bundle,bundles){var adjusted=!1;if(bundles==null){var r=sticker__lookup("page");if(r[0])var page=r[1].page,bundles=r[1].bundles;else return!1}
switch(mode){case "add":var len=bundles.length;if(!len){bundles.push(bundle)}
else{for(var i=0;i<len;i++){if(adjusted){if(bundles[i].position.sum>bundles[i].position.top){var push=bundles[i].position.sum-bundles[i].position.top;for(var k=i;k<len;k++)
bundles[k].position.top+=push}}
else{if(bundles[i].position.top>bundle.position.top||i+1===len){bundles[i].position.topmargin=i>0?bundles[i].position.top-bundles[i-1].position.sum:bundles[i].position.top;bundles[i].position.sum=bundles[i].position.top+bundles[i].size.height;bundles.splice(i,0,bundle);adjusted=!0}}}}
sticker__save_local(bundles);sticker__createDOM(bundle.id,bundle);return sticker__place(sticker__calc(sticker__order(bundles)));break;case "remove":for(var i=0;i<bundles.length;i++){if(bundles[i].id==bundle.id){bundles.splice(i,1);adjusted=!0}
else if(!!adjusted&&bundles[i].position.align_right==bundles[i-1].position.align_right){bundles[i].position.topmargin+=(bundles[i-1].position.topmargin+bundles[i-1].size.height);adjusted=!1}}
sticker__save_local(bundles);$(".bundle[data-bundle_id='"+bundle.id+"']").fadeOut(200,function(){$(this).remove()});return sticker__place(bundles);break}}
function sticker__order(bundles){if(bundles==null){var r=sticker__lookup("page");if(r[0])var page=r[1].page,bundles=r[1].bundles;else return!1}
if(bundles.length>1)
bundles.sort(function(x,y){return x.position.top-y.position.top});bundles.forEach(function(bundle){$(".bundle[data-bundle_id='"+bundle.id+"']").detach().insertBefore("#editor_editable")});return bundles}
function sticker__calc(bundles,mode,bundle_assigned){if(bundles==null){var r=sticker__lookup("page");if(r[0])
var page=r[1].page,bundles=r[1].bundles;else return!1}
switch(mode){case "add":bundles=sticker__exec("add",bundle_assigned,bundles);break;case "remove":bundles=sticker__exec("remove",bundle_assigned,bundles);break}
var sides=["left","right"],last={alignment:"",top:0,sum:{left:0,right:0}};bundles.forEach(function(bundle,i){var alignment=bundle.position.align_right,alignment_opposite=alignment;alignment=sides[alignment];alignment_opposite=sides[alignment_opposite^=1];bundle.position.top=Math.max(bundle.position.top,0);if(i>0&&alignment!==last.alignment){bundle.position.topmargin=bundle.position.top-last.top}
else{bundle.position.top=Math.max(bundle.position.top,last.sum[alignment]+1);bundle.position.topmargin=bundle.position.top-last.sum[alignment]}
bundle.position.topmargin=Math.max(bundle.position.topmargin,0);last.sum[alignment]=bundle.position.sum=bundle.position.top+bundle.size.height;if(i>0&&alignment==last.alignment)
for(var a in last.sum)last.sum[a]=bundle.position.sum;for(var asset_id in bundle.assets){bundle.assets[asset_id].position.top=bundle.position.top;bundle.assets[asset_id].position.topmargin=bundle.position.topmargin;bundle.assets[asset_id].position.align_right=bundle.position.align_right}
bundles[i]=bundle;last.alignment=alignment;last.top=bundle.position.top;if(i===0)sticker__top_edge(bundle);sticker__log("📄 調整貼紙位置 "+bundle.id+"："+JSON.stringify(bundle.position))});sticker__save_local(bundles);return bundles}
function sticker__top_edge(bundle){return!1;if(bundle==null){var r=sticker__lookup("page");if(r[0]&&r[1].bundles.length>0){bundle=r[1].bundles[0]}
else{$("#editor_editable").css("padding-top","1em");return!1}}
var editor_width=$("#editor").width();if(bundle.position.top<50&&(bundle.position.left>editor_width/4&&bundle.position.left<editor_width*3/5)){var a=$(".bundle:first .asset").get(0);if(!(a==null))
$("#editor_editable").css({"padding-top":Math.ceil(a.getBoundingClientRect().height)+"px"})}
else{$("#editor_editable").css("padding-top","1em")}
return!0}
function sticker__place(bundles){if(bundles==null){var r=sticker__lookup("page");if(r[0])
var page=r[1].page,bundles=r[1].bundles;else return!1}
var $s=$(".hj-styles");bundles.forEach(function(bundle){if(!$s.children("style[data-bundle_id='"+bundle.id+"']").length){$s.append($("<style>",{"data-bundle_id":bundle.id}))}
else{var s=!bundle.position.align_right?'.bundle.bundle_left[data-bundle_id="'+bundle.id+'"]::before{height:'+bundle.position.topmargin+'px}':'.bundle.bundle_right[data-bundle_id="'+bundle.id+'"]::before{height:'+bundle.position.topmargin+'px}';$s.children("style[data-bundle_id='"+bundle.id+"']").text(s)}});$("#editor .complement").remove();$("#editor .bundle").each(function(i){var c1=$(this).attr('class').split(' '),c2=$("#editor .bundle").length>i+1?$(this).nextAll("#editor .bundle").eq(0).attr('class').split(' '):[];if(c1.indexOf("bundle_left")>=0&&c2.indexOf("bundle_left")>=0)
$(this).after($("<div>",{class:"complement complement_right"}));else if(c1.indexOf("bundle_right")>=0&&c2.indexOf("bundle_right")>=0)
$(this).after($("<div>",{class:"complement complement_left"}))});return bundles}
function sticker__lookup(scope,bundle_id,asset_id){var raw=hj__cache({bucket:"hearty_sticker_cache__"+current_post()["post_id"]}),r=[r!==null,JSON.parse(raw)||[]],callback=[!1,{}];if(r[0]){var page={},bundles=r[1];var bundle;bundles.forEach(function(bundle){page[bundle.id]=bundle});callback[1].page=bundles.length>0?page:{};callback[1].bundles=bundles.length>0?bundles:[];if(scope=="page"){callback[0]=!0;callback[1].status=4}
else if(bundle_id in page){bundle=callback[1].bundle=page[bundle_id];if(scope=="asset"&&asset_id in bundle.assets){callback[0]=!0;callback[1].status=3;callback[1].asset=bundle.assets[asset_id]}
else{callback[0]=scope=="bundle";callback[1].status=2}}
else{callback[0]=!1;callback[1].status=1}}
else{callback[0]=!1;callback[1].status=0}
return callback}
function sticker__update(bundle_id,asset_id,label,data,bundle_only){var r=sticker__lookup("asset",bundle_id,asset_id);var page,bundles;if(label=="angle"){data.deg=Math.abs(data.deg)>=360?Math.abs(data.deg).toFixed(0)-360:data.deg.toFixed(0);data.rad=Math.abs(data.rad)>=Math.PI*2?(Math.abs(data.rad)-Math.PI*2).toFixed(5):data.rad.toFixed(5)}
else{for(var k in data)data[k]=Math.max(Math.floor(data[k]),0);}
if(r[0]&&label in r[1].asset){page=r[1].page;if(!bundle_only)page[bundle_id].assets[asset_id][label]=data;if(["position","size"].indexOf(label)>=0)page[bundle_id][label]=data}
else{return!1}
bundles=Object.keys(page).map(function(k){return page[k]});sticker__save_local(bundles);sticker__log("💾 暫存貼紙 "+bundle_id+"（"+asset_id+"）的 "+label+" 為："+JSON.stringify(data))}
function sticker__cut(d){if(!current_post()["editable"]||$(".bk-page .sticker_editing").length>0)
return!1;var bundle_id=d.bundle_id,asset_id=d.asset_id,$b=$(".bundle[data-bundle_id='"+bundle_id+"']"),$a=$b.find(".asset[data-asset_id='"+asset_id+"']"),$i=$a.children(".sticker_img"),$e=$(".editor_toolbelt"),r=sticker__lookup("asset",bundle_id,asset_id),touch_device=is_touch_device();var pos;if(r[0]&&"position" in r[1].asset){pos=r[1].asset.position;$b.children(".bundle_innerbox").css({top:pos.top,left:pos.left});var px=!pos.align_right?pos.left:-1*(pos.right+Math.floor($i.get(0).getBoundingClientRect().width*1.05));$a.animate({left:px},0)}
else{$b.remove();return!1}
$a.draggable("enable");$i.rotatable("enable").children(".ui-resizable-handle, .ui-rotatable-handle").fadeIn();if(touch_device){window.interact(".asset[data-asset_id='"+asset_id+"'] .sticker_img").gesturable({enabled:!0})}
else{$i.resizable("enable");sticker__editor_hotkeys(!0,bundle_id,asset_id)}
$("#editor_editable").addClass("readonly").prop("contenteditable",!1).disableSelection();$b.children(".bundle_innerbox").width(0).css({"margin-left":"-1px","margin-right":"-1px"});$i.addClass("sticker_editing").removeClass("sticker_static");$("#editor .bundle .sticker_static").fadeTo("fast",0.5);$a.attr("data-editing",!0);$(".editor_toolbelt #paste, #editor_editable").attr("onclick","sticker__paste("+JSON.stringify({bundle_id:bundle_id,asset_id:asset_id})+"); saved(false);");$i.children(".detach").fadeIn();$e.find(".kits").hide();$e.find(".sticker span").fadeIn();$(".mh-head .btn_stickerbook, .stickerbook .stickerlist").hide();nav_toggle($(".stickerbook"),!1);if(touch_device){$(".bk-page header, .bk-page .picture").hide();$(".bk-list .bk-page").removeClass("scroll-smoothly").scrollTop(Math.floor(pos.top-$(".bk-list .bk-page").height()*1/4)).css({"border-top":"none"})}
sticker__log("✂️ 剪下貼紙："+bundle_id+"（"+asset_id+"）");return!0}
function sticker__paste(d){var $i=$(".bk-page .sticker_editing");if($i.length===0)return!1;var bundle_id=d.bundle_id||$i.attr("data-bundle-id"),asset_id=d.asset_id||$i.attr("data-asset-id"),$b=$(".bundle[data-bundle_id='"+bundle_id+"']"),$a=$b.find(".asset[data-asset_id='"+asset_id+"']"),$i=$a.children(".sticker_img"),$s=$(".hj-styles"),bundles=sticker__calc(sticker__order()),r=sticker__lookup("asset",bundle_id,asset_id),touch_device=is_touch_device();var pos;if(r[0]&&"position" in r[1].asset){pos=r[1].asset.position;if(!pos.align_right){$b.addClass("bundle_left").removeClass("bundle_right");$b.children(".bundle_innerbox").addClass("alignment_left").removeClass("alignment_right");if(!$s.children("style[data-bundle_id='"+bundle_id+"']").length)
$s.append($("<style>",{"data-bundle_id":bundle_id}));$s.children("style[data-bundle_id='"+bundle_id+"']").text(".bundle[data-bundle_id='"+bundle_id+"'].bundle_left::before{height:"+pos.topmargin+"px}");$b.children(".bundle_innerbox").css({"margin-left":pos.left+"px","margin-right":0})}
else{$b.addClass("bundle_right").removeClass("bundle_left");$b.children(".bundle_innerbox").addClass("alignment_right").removeClass("alignment_left");if(!$s.children("style[data-bundle_id='"+bundle_id+"']").length)
$s.append($("<style>",{"data-bundle_id":bundle_id}));$s.children("style[data-bundle_id='"+bundle_id+"']").text(".bundle[data-bundle_id='"+bundle_id+"'].bundle_right::before{height:"+pos.topmargin+"px}");$b.children(".bundle_innerbox").css({"margin-left":0,"margin-right":pos.right+"px"})}
if(cssFeatureSupported("width","min-content"))$b.children(".bundle_innerbox").width("min-content").height("min-content");else if(cssFeatureSupported("width","min-intrinsic"))$b.children(".bundle_innerbox").width("min-intrinsic").height("min-intrinsic");else $b.children(".bundle_innerbox").width("auto").height("auto")}
sticker__place(bundles);$("#editor .bundle .sticker_static").fadeTo("fast",1);$i.children(".detach").fadeOut();$(".editor_toolbelt .sticker a").hide();$(".editor_toolbelt .kits").fadeIn();if(touch_device){$(".bk-page header, .bk-page .picture").show();var editor_topmargin=$("#editor").get(0).offsetTop,editor_scrolled=$(".bk-list .bk-page").scrollTop()||0;$(".bk-list .bk-page").scrollTop(editor_scrolled+editor_topmargin).addClass("scroll-smoothly").css({"border-top":"1em solid transparent"})}
sticker__rotation_margin_fixes(bundle_id,asset_id);$a.attr("data-editing",!1).css({top:0,left:0});$i.children(".ui-resizable-handle, .ui-rotatable-handle").hide();if(current_post()["editable"]){$a.draggable("disable");$i.rotatable("disable");if(touch_device){window.interact(".bundle .asset[data-asset_id='"+asset_id+"'] .sticker_img").gesturable({enabled:!1})}
else{$i.resizable("disable");sticker__editor_hotkeys(!1,bundle_id,asset_id)}}
$("#editor_editable").removeClass("readonly").prop("contenteditable",!0).enableSelection();$i.addClass("sticker_static").removeClass("sticker_editing");$(".mh-head .btn_stickerbook, .stickerbook .stickerlist").show();sticker__log("📋 黏貼貼紙："+bundle_id+"（"+asset_id+"）");return!0}
function sticker__remove(d){var post_id=current_post()["post_id"],bundle_id=d.bundle_id,asset_id=d.asset_id;if(sticker__paste({bundle_id:bundle_id,asset_id:asset_id})){sticker__exec("remove",{id:bundle_id});sticker__top_edge();if("vibrate" in navigator)navigator.vibrate([80]);if($("#editor .bundle").length<2)nav_toggle($(".stickerbook"),!0);createCaretPlacer(!1);var r=update({action:"sticker_remove",bundle_id:bundle_id,asset_id:asset_id,post_id:post_id});switch(r.Status){case 0:update_failed();return;break;case 2:signin_required();return;break}}
hj_mixpanel("Sticker Removed",{post_id:post_id});ga_event_push("Sticker Remove",{event_category:"Posts",event_label:"Sticker Remove"});sticker__log("🗑️ 刪除貼紙："+bundle_id+"（"+asset_id+"）")}
function sticker__save_remote(){var r=sticker__lookup("bundles"),bundles="bundles" in r[1]?r[1].bundles:[];if(!bundles.length)return!1;r=update({action:"sticker_save",post_id:current_post()["post_id"],bundles:JSON.stringify(bundles)});switch(r.Status){case 0:case 3:update_failed();break;case 1:break;case 2:signin_required();break}}
function sticker__save_local(bundles){var post_id=current_post()["post_id"];hj__cache({set:!0,bucket:"hearty_sticker_cache__"+post_id,data:JSON.stringify(bundles)})}
function sticker__uniqID(e){var bucket="hearty_sticker_uniqIDs",uniqIDs=JSON.parse(hj__cache({bucket:bucket,local:!0}))||[];var uniqID;if(uniqIDs.length>0){uniqID=uniqIDs.shift();hj__cache({set:!0,bucket:bucket,data:JSON.stringify(uniqIDs),local:!0})}
else if(!e){uniqID=sticker__generate_uniqID()}
if(uniqIDs.length<6){window.setTimeout(function(){for(var i=uniqIDs.length;i<6;i++)uniqIDs.push(sticker__generate_uniqID());hj__cache({set:!0,bucket:bucket,data:JSON.stringify(uniqIDs),local:!0})},0)}
return uniqID}
function hj__cache(v){var set="set" in v,s="local" in v?"localStorage":"sessionStorage";if(s in window){if(set){try{window.eval(s).setItem(v.bucket,v.data)}
catch(e){$("body").data(v.bucket,v.data)}}
else{return window.eval(s).getItem(v.bucket)||$("body").data(v.bucket)||null}}
else{if(set)$("body").data(v.bucket,v.data);else return $("body").data(v.bucket)||null}}
function sticker__generate_uniqID(){var r=update({action:"uniqid"}),u=(new Date().getTime()).toString(16)+Math.floor(Math.random()*90+10);return!r?u:(r.Status?r.Values.uniqid:u)}
function sticker__log(info){if("console" in window&&"log" in window.console)window.console.log(info)}
function post_privacy(privacy){autosave_the_change();privacy=Number(privacy);var post_id=current_post()["post_id"],$e=$(".bk-page #editor_editable"),$u=$(".popup.share .sharable_url"),r=update({action:"post_privacy",post_id:post_id,privacy:privacy});switch(r.Status){case 1:var c=$e.data("current_post");c.privacy=privacy;$e.data("current_post",c);post_privacy_toggle(privacy);$(".catalog .diaries li[data-post_id='"+post_id+"']").attr("data-privacy",privacy);if(!privacy)alertify.error("日記已上鎖");else alertify.success("日記已設為公開");hj_mixpanel("Post Privacy",{post_id:post_id,privacy:privacy});ga_event_push("Privacy",{event_category:"Posts",event_label:!privacy?"Private":"Public"});return!0;break;case 2:signin_required();break;default:hj_alert("糟糕，出錯了，請稍候再試");break}}
function post_privacy_toggle(privacy){var $u=$(".popup.share .sharable_url");if(!Number(privacy)){$u.slideUp()}
else{$u.slideDown();post_get_sharable_link()}
var $p=$(".privacy_selector li");$p.removeAttr("data-selected");$p.filter("[data-privacy='"+privacy+"']").attr("data-selected","")}
function post_get_sharable_link(){var privacy=Number(current_post()["privacy"]),$i=$(".popup.share .sharable_url input"),url=$i.val()||"";if(privacy<9)return!1;if(!url.length){var r=update({action:"post_get_sharable_link",post_id:current_post()["post_id"]});if(r.Status){if(!!r.Values&&"token" in r.Values){url="https://hj.rs/"+r.Values.token;$i.val(url)}}
else{return!1}}}
function hj_native_share(){var url=$(".popup.share .sharable_url input").val()||window.location.href.replace(window.location.host,"o.hearty.me");if("share" in window.navigator)
navigator.share({title:document.title,text:$("meta[name='description']").attr("content"),url:url});else if(/Hearty_iOS|Hearty_Android/i.test(navigator.userAgent||""))
window.location.assign("//hearty.me/wv?s="+encodeURIComponent(url.replace(/(^\w+:|^)\/\//,"")));else return!1}
function post_contribute(){var $editable=$(".bk-page #editor_editable"),subject=$(".bk-page #subject").text(),privacy=Number(current_post()["privacy"]),ask=!privacy?"投稿文章需為公開，請問是否將其公開並投稿呢？":"確定投稿「"+subject+"」嗎？",d=new Date();alertify.set({labels:{ok:"投稿",cancel:"取消"},buttonReverse:!1});alertify.confirm("📝 "+ask,function(e){if(e){hj_loading(!0);if(!privacy)post_privacy(9);var post_id=current_post()["post_id"],post=$editable.text().replace(/^\s+|\s+$/g,""),r=update({action:"gform_post",uri:"1FAIpQLSejAwJP2dSgdhGz79S9Q_JzqthM4JrAXhFB3dfKNCCfSJGi_A",data:$.param({"entry.783049182":"[hj_user_id]","entry.866865386":"[hj_username]","entry.1497216280":"[hj_email]","entry.355700800":post_id,"entry.1270264487":post,"entry.1259076046":[d.getFullYear(),("0"+d.getMonth()).slice(-2),("0"+d.getDate()).slice(-2)].join("-"),"entry.124585191":navigator.userAgent||""})});switch(r.Status){case 1:msg("📝「"+subject+"」已傳送給溫度小編");$(".privacy_selector li[data-contribute]").attr("data-selected","");hj_loading(!1);break;default:hj_loading(!1);break}}})}
function hj_feedback_toggle(on){popup_toggle(on,"feedback");if(!/Hearty_iOS|Hearty_Android/i.test(navigator.userAgent||"")&&typeof window.FB!=="undefined"){if($(".fb-customerchat").length>0){if(on)FB.CustomerChat.show();else FB.CustomerChat.hide()}
else{var hi="嗨！ 我是溫度日記"+(Math.random()>=0.5?"創辦人 Nien":"的珈宜");$("<div>",{class:"fb-customerchat",attribution:"setup_tool",page_id:115513719073571,theme_color:"#F16D6E",logged_in_greeting:hi,logged_out_greeting:hi,greeting_dialog_display:"show",}).appendTo($(".popup.feedback"));if("XFBML" in FB)FB.XFBML.parse()}}}
function hj_feedback(){var $f=$(".popup.feedback"),$n=$f.find("input[name='name']"),$e=$f.find("input[name='email']"),$t=$f.find("textarea"),$s=$f.find(".notice"),$b=$f.find(".btns_action li");if($n.val().length<2){$s.text("請填寫姓名");$n.focus();shake($n);return!1}
else if(!/@/.test($e.val())){$s.text("Email 格式不正確");$e.focus();shake($e);return!1}
else if($t.val().length<5){$s.text("意見回饋的字數不足");$t.focus();shake($t);return!1}
hj_loading(!0);$b.slideUp("fast",function(){var r=update({action:"gform_post",uri:"1FAIpQLScPq53DlC8PjlQCJEMqHm-7ykRPEDosDrIsaAbj3YUT32rTgQ",data:$.param({"entry.434422115":"[hj_user_id]","entry.1958440920":$n.val()||"[hj_username]","entry.803572147":$e.val()||"[hj_email]","entry.1027128888":$t.val()||"","entry.858322988":navigator.userAgent||""})});switch(r.Status){case 1:$f.find("form").get(0).reset();hj_feedback_toggle(!1);$s.text("謝謝您的意見");msg("已收到反饋，將儘速以 Email 回覆");$(this).slideDown();hj_loading(!1);break;default:$s.text("出錯了，請稍候再試");msg("對不起，似乎出錯了，請稍候再試");$(this).slideDown();hj_loading(!1);break}})}
function copy($e){$e.select();document.execCommand("Copy",!1,null);alertify.success("已複製到剪貼簿。")}
function sticker__list(set_num,set_alias){var wpCDN="i0.wp.com",$book=$(".stickerbook"),$tabs=$book.find(".stickertabs"),$dir=$book.find(".stickerlist .stickerdir"),dir=[],bucket="hearty_sticker_list__"+bucket_suffix(),sets=hj__cache({bucket:bucket});if(sets===null){var r=update({action:"sticker_list"});if(r.Status>0){sets=r.Values;hj__cache({set:!0,bucket:bucket,data:JSON.stringify(sets)})}
else{sets={}}}
else{sets=JSON.parse(sets)||{}}
if(set_num==null){var set=[];for(var set_num in sets){set=sets[set_num];dir.push($("<div>",{class:"item",onclick:"sticker__list(\'"+set_num+"\', \'"+set.alias+"\');",title:set.name,"data-sticker":0}).html($("<div>",{"data-src":set.alias+"/"+set.cover+".png"})).append($("<h3>").text(set.name)))}
$dir.append(dir).find(".item div").lazy({threshold:100,effect:"fadeIn",effectTime:200,imageBase:"//"+wpCDN+"/s.hearty.me/images/stickers/thumbnails/",appendScroll:$dir,onError:function($e){var fallback="//c.hearty.me/images/stickers/thumbnails/"+$e.attr("data-src");$e.attr({"data-src-backup":fallback}).css({"background-image":"url("+fallback+")"})}});$book.find(".tab_main").fadeIn()}
else if(!set_num){$(".mh-head .btn_stickerbook").hide();return}
else{$book.find(".item").hide();if(isNaN(set_num)){$tabs.find(".tab_category").hide();$book.find(".item[data-sticker='0']").add($tabs.find(".tab_main")).fadeIn();var scrolled=$dir.data("scrolled");if(!!scrolled)$dir.scrollTop(scrolled)}
else{$dir.scrollTop(0);var premium,act;var $item=$book.find(".item[data-sticker='"+set_num+"']");if(!$item.length){sets[set_num].stickers.forEach(function(item){item.set_num=set_num;item.set_alias=set_alias;item.type=0;premium=Number(item.type)>0;dir.push($("<div>",{class:"item",onclick:"sticker__oncreate($(this).data('sticker'), this.dataset.premium);",title:item.name,"data-sticker":set_num,"data-premium":item.type}).html($("<div>",{"data-src":set_alias+"/"+item.num+".png"})).data("sticker",item).append($("<h3>").text(item.name)))});$dir.append(dir);$item=$book.find(".item[data-sticker='"+set_num+"']");$item.find("div").lazy({threshold:100,effect:"fadeIn",effectTime:200,imageBase:"//"+wpCDN+"/s.hearty.me/images/stickers/thumbnails/",appendScroll:$dir,onError:function($e){var fallback="//c.hearty.me/images/stickers/thumbnails/"+$e.attr("data-src");$e.attr({"data-src-backup":fallback}).css({"background-image":"url("+fallback+")"})}})}
$item.css({display:"-webkit-inline-flex",display:"inline-flex"}).fadeIn();$tabs.find(".tab_category span:nth-child(1)").text(sets[set_num].name);$tabs.find(".tab_category span:nth-child(2)").text(sets[set_num].illustrator);$tabs.find(".tab_main").hide();$tabs.find(".tab_category").fadeIn()}}
$(".mh-head .btn_stickerbook").show()}
function mobile_editor_focus(){if(!is_touch_device()||$(window).width()>768)return!1;var editor_topmargin=$("#editor").get(0).offsetTop;$("#editor_editable").focus(function(){$(".mh-head .left, \
			.mh-head .right:first > div, \
			.bk-underlayer, \
			.editor_toolbelt, \
			.bk-page header, \
			.bk-page .picture").hide();$(".mh-head .right:last").fadeIn();$("body").scrollTop(0).css({"overflow-y":"hidden"});$(".hj-main").css({padding:"1.6em 0 0 0"});$(".bk-list .bk-page, .bk-list #editor").css({"border-top":"none"});$("#editor .bundle").css({"pointer-events":"none"}).fadeTo("fast",0.6);if(typeof history.pushState==="function"){history.pushState({},null,null);window.onpopstate=function(){history.pushState({},null,null);$("#editor_editable").blur()}}
createCaretPlacer(!1)}).blur(function(){$(".mh-head .left, \
			.bk-underlayer, \
			.bk-page header, \
			.bk-page .picture, \
			.mh-head .right:first > div").show();$(".editor_toolbelt").slideDown();$(".mh-head .right:last").hide();$("body").css({"overflow-y":"auto"});$(".hj-main").css({padding:"3.6em 0 2em 0"});$(".bk-list .bk-page").css({"border-top":"1em solid transparent"});$(".bk-list #editor").css({"border-top":"1px dashed #ccc"});$("#editor .bundle").css({"pointer-events":"auto"}).fadeTo("fast",1);if($(".bk-list .bk-page").scrollTop()<editor_topmargin)
$(".bk-list .bk-page").removeClass("scroll-smoothly").scrollTop(editor_topmargin).addClass("scroll-smoothly");autosave_the_change();if(typeof history.pushState==="function"){history.pushState({},null,null);window.onpopstate=function(){history.pushState({},null,null);$("#editor_editable").get(0).focus({preventScroll:!1})}}})}
function hj_video(action,yt){var $pic=$(".bk-page .picture");yt=yt||"UnP0ljFhd6c";switch(action){case "init":$pic.children("#youtube").css({background:"url('//img.youtube.com/vi/"+yt+"/0.jpg') no-repeat center","background-size":"cover"}).data("youtube",yt).fadeIn().find("iframe").hide();break;case "play":if(!1){$pic.find("#youtube iframe").attr({src:"//c.hearty.me/videos/sheara.php"}).show()}
else{$pic.find("#youtube iframe").attr({src:"//www.youtube.com/embed/"+yt+"?"+$.param({controls:1,fs:1,modestbranding:1,loop:1,cc_load_policy:1,rel:0,autoplay:1,playsinline:1})}).show();$pic.find(".far").slideUp()}
break;case "update":var post_id=current_post()["post_id"];alertify.set({labels:{ok:"🎥 加入影片",cancel:"取消"},buttonReverse:!1});alertify.prompt("<i class='fab fa-youtube'></i> Youtube 網址",function(e,yt){if(e){yt=YoutubeURLparser(yt);if(!yt){hj_alert("Youtube 網址格式不正確");hj_video("update")}
else{hj_video("init",yt);var r=update({action:"post_update",field:"youtube_video",post_id:post_id,youtube_video:yt});switch(r.Status){case 1:alertify.success("影片已加入");hj_mixpanel("Video Added",{post_id:post_id,youtube:yt});ga_event_push("Video Added",{event_category:"Posts",event_label:"Video_Added"});break;case 2:signin_required();break;default:hj_alert("Error: "+JSON.stringify(r));break}}}},"https://www.youtube.com/watch?v="+yt);break;case "reset":hj_video("clear");update({action:"post_update",field:"youtube_video",post_id:current_post()["post_id"],youtube_video:""});break;case "clear":$pic.children("#youtube").data("youtube",null).fadeOut();break}}
function YoutubeURLparser(url){var match=url.match(/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);return(match&&match[2].length==11)?match[2]:!1}
function post_query(post_id){autosave_the_change();var post_id=Number(post_id),$page=$(".bk-list .bk-page"),$subject=$page.find("#subject"),$editable=$page.find("#editor_editable"),$li=$(".catalog .diaries li");if(post_id<=0){var latest_post=catalog_lookup(post_id);if(latest_post!==null)post_query(latest_post.post_id);return latest_post!==null}
nav_toggle($(".catalog-mobile"),!1);$page.children(".prologue").add($editable).add($subject).hide();$page.children(".diary").show();$subject.slideDown("normal").promise().then(function(){$editable.slideDown("normal")});$(".bk-page .picture").fadeTo("normal",0).fadeTo("slow",1);var post_id=Number(post_id||1),r=update({action:"post_query",writer:hj_writer,post_id:post_id,passcode:""});switch(r.Status){case 0:case 2:update_failed();break;case 1:var post=r.Values,illustration=illustration_random();$editable.data("current_post",{post_id:post_id,privacy:post.privacy,editable:!!post.editable}).html(post.post);$subject.text(post.title).attr("title",post.title);sticker__top_edge();stickers__initialize();post.image=illustration_show(post.gallery_id);if(!post.youtube_video)hj_video("clear");else hj_video("init",post.youtube_video);post_privacy_toggle(post.privacy);var $u=$(".popup.share input");if(!post.shortened_url){$u.val("").attr({placeholder:""})}
else{post.shortened_url="https://hj.rs/"+post.shortened_url;$u.val(post.shortened_url).attr({placeholder:post.shortened_url})}
$li.filter("[data-active]").removeAttr("data-active");$li.filter("[data-post_id='"+post_id+"']").attr("data-active","").text(post.title);post.title+=" ♥ 溫度日記 Hearty Journal";document.title=post.title;$('meta[property="og:title"]').attr("content",post.title);$('meta[name="description"], meta[property="og:description"]').attr("content",post.post.replace(/\n/g,"").substring(0,48)+"…");$('meta[property="og:image"]').attr("content",post.image);$('meta[property="og:url"]').attr("content",window.location.href);$page.find(".bookmark").attr("data-bookmarked",post.bookmarked);$page.find("header").attr("data-post_date",post.date);$page.find(".wi").removeAttr("class").addClass(post.weather);$page.animate({scrollTop:0},"fast");if(typeof history.replaceState==="function")
window.history.replaceState({},post.title+" ♥ 溫度日記 Hearty Journal","/"+hj_writer+"/"+post_id);editor_enable();hj_mixpanel("Post Loaded",{post_id:post_id});ga_event_push("Post Loaded",{event_category:"Posts",event_label:"Post Loaded"});break;case 3:signin_required();break;case 4:signin_required();break}
return r.Status===1}
function post_create(pos){open_book(!0);var gps;if("geolocation" in navigator){if(!!getcookie("hearty_position_gps")){gps=JSON.parse(decodeURIComponent(getcookie("hearty_position_gps")))||{}}
else if(pos&&confirm("⛅ 是否開啟定位，並為日記加入天氣呢？")){$.when(window.positioning_gps_deferred).done(function(){post_create(!1)});positioning_gps_trigger(!0);$(".mask_loading").show().delay(8000).queue(function(){post_create(!1);$(this).fadeOut().dequeue()});msg("⛅ 麻煩「允許」定位權限，並稍待一會兒。。。","好");return}}
var raw=update(gps==null?{action:"post_create"}:{action:"post_create",location_lat:gps.latitude||"",location_lon:gps.longitude||"",place:gps.address||"",weather_id:gps.weather_id||""});switch(raw.Status){case 1:var r=raw.Values,post_id=r.post_id,subject=r.title;$("<li>",{title:"📝 "+subject,onclick:"if(!post_query(this.dataset.post_id)) $(this).remove();","data-active":"","data-post_id":post_id,"data-page":1,"data-privacy":0,}).text(subject).prependTo($(".catalog .diaries"));catalog_page(1);post_query(post_id);$(".alertify-dialog .alertify-button-ok").click();hj_mixpanel("Post Created",{post_id:post_id});ga_event_push("Create",{event_category:"Posts",event_label:"Create"});break;case 2:signin_required();break;default:hj_alert("糟糕，出錯了，請稍候再試");break}}
function post_revise(){var $editable=$(".bk-page #editor_editable"),post_id=current_post()["post_id"],post=$editable.text().replace(/^\s+|\s+$/g,"")+"\n",r=update({action:"post_update",field:"revise",post_id:post_id,post:post});switch(r.Status){case 1:saved(!0);$(".editor_toolbelt .kit.save").removeClass("btn_blink");hj_mixpanel("Post Revised",{post_id:post_id});ga_event_push("Revise",{event_category:"Posts",event_label:"Revise"});break;case 2:signin_required();break;default:hj_alert("糟糕，出錯了，請稍候再試");break}}
function autosave_the_change(){if(window.onbeforeunload!==null&&current_post()["editable"]){post_revise();return!0}
return!1}
function autosaver_30s(){window.hj_autosaver=setInterval(function(){if(window.onbeforeunload!==null&&current_post()["editable"])post_revise()},29900)}
function saved(s){var $b=$(".editor_toolbelt .kit.save");if(s==!0){window.onbeforeunload=null;$b.removeClass("btn_blink").attr("data-saving","").delay(950).queue(function(){$(this).removeAttr("data-saving").dequeue()})}
else{window.onbeforeunload=function(e){if(current_post()["editable"])post_revise();return"已儲存文章，確認要離開嗎？"};$b.addClass("btn_blink")}}
function title_editing(title){var post_id=current_post()["post_id"];alertify.set({labels:{ok:"📝 更新",cancel:"取消"},buttonReverse:!1});alertify.prompt("<i class='far fa-pen'></i> 日記標題",function(e,title){if(e){if(!title.replace(/\s+/g,'').length)return!1;else title=capitalizeFirstLetter(title);var r=update({action:"post_update",field:"title",post_id:post_id,title:title});switch(r.Status){case 1:$(".bk-page #subject, .catalog .diaries li[data-active]").attr("title",title).text(title);alertify.success("標題修改為："+title);hj_mixpanel("Title Edited",{post_id:post_id,post_title:title});ga_event_push("Edit Title",{event_category:"Posts",event_label:"Edit Title"});title+=" ♥ 溫度日記 Hearty Journal";document.title=title;$("meta[property='og\\:title']").attr("content",title);break;case 2:signin_required();break;default:hj_alert("糟糕，出錯了，請稍候再試");break}}},title||$(".bk-page #subject").text())}
function post_archive(){if(!current_post()["editable"])return!1;autosave_the_change();open_book(!0);var post_id=current_post()["post_id"],subject=$("#subject").text(),$page=$(".bk-list .bk-page");alertify.set({labels:{ok:"不要",cancel:"刪除"},buttonReverse:!1});alertify.confirm("⚠️ 確定刪除這篇日記（"+subject+"）嗎？",function(e){if(!e){var r=update({action:"post_update",field:"archive",post_id:post_id});switch(r.Status){case 1:catalog_page(1);$page.find(".diary").hide();$page.find(".prologue").slideDown();$(".catalog .diaries li[data-post_id='"+post_id+"']").remove();alertify.error("刪除了「"+subject+"」");if(typeof history.replaceState==="function")
window.history.replaceState({},subject+" ♥ 溫度日記 Hearty Journal","/"+hj_writer);$page.find("#editor_editable").data("current_post",null);hj_mixpanel("Post Archived",{post_id:post_id});ga_event_push("Archive",{event_category:"Posts",event_label:"Archive"});break;case 2:signin_required();break;default:hj_alert("糟糕，出錯了，請稍候再試");break}}})}
function hj_fullscreen(el){if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreen&&!document.webkitIsFullScreen)){if(el.requestFullscreen)el.requestFullscreen();else if(el.mozRequestFullScreen)el.mozRequestFullScreen();else if(el.msRequestFullscreen)el.msRequestFullscreen();else if(el.webkitRequestFullscreen)el.webkitRequestFullScreen()}
else{if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen()}}
function update_failed(){network_status(["offline"],!0)}
function screenlock(action,para){var $sl=$(".screenlock"),pincode=$sl.data("pincode"),$pin=$sl.find(".pin"),isset=!(pincode==null);switch(action){case true:if($sl.is(":hidden")){$(".menu, .catalog-mobile, .stickerbook").each(function(){nav_toggle($(this),!1)});open_book(!1);$sl.slideDown("fast").find("input:first").focus();$(".hj-main").addClass("blur")}
break;case false:if($sl.is(":visible")){$sl.fadeOut("normal");$(".hj-main").removeClass("blur");open_book(!0)}
$sl.find("input").val("");break;case "status":return isset;break;case "initialize":if(!!para){screenlock("set",para);screenlock(!0)}
else if(!!getcookie("hearty_screenlock")){screenlock("set",getcookie("hearty_screenlock"));screenlock(!0)}
break;case "activate":if(isset){screenlock(!0)}
else if(!isset){alertify.set({labels:{ok:"設置",cancel:"否"},buttonReverse:!1});alertify.confirm("<i class='fal fa-lock'></i> 是否設置「螢幕鎖」？ 防止暫離時旁人窺探",function(e){if(e)screenlock(!0)})}
break;case "set":$sl.data("pincode",para||"0000");break;case "unset":if(isset){alertify.set({labels:{ok:"清除螢幕鎖",cancel:"否"},buttonReverse:!1});alertify.prompt("<i class='fal fa-lock-open'></i> 輸入 Pin 碼 或 溫度密碼",function(e,entered_pincode){if(e){if(entered_pincode==pincode){screenlock("disable")}
else{var r=update({action:"screenlock_unset",password:entered_pincode});switch(r.Status){case 0:msg("密碼似乎不正確","再試試");screenlock("unset");break;case 1:screenlock("disable");break}}}})}
else{screenlock(!1);$sl.removeAttr("pincode");$pin.attr("title","🔒 請輸入 Pin 碼")}
break;case "disable":update({action:"screenlock_setup",pincode:""});screenlock(!1);setcookie("hearty_screenlock","",1);$sl.data("pincode",null);$pin.attr("title","🔒 請輸入 Pin 碼");alertify.success("螢幕鎖已清除");hj_mixpanel("Screenlock Clear");ga_event_push("Screenlock",{event_category:"Screenlock",event_label:"Clear"});break;case "next":var $e=para[0],val=para[1];if(isNaN(val)){$e.val("");hj_alert("Pin 碼僅限數字")}
else if(val.length>0&&$e.next(".screenlock input").length>0){$e.next(".screenlock input").focus()}
break;default:var pin="";$sl.find("input").each(function(){pin+=$(this).val()}).val("");if(isset){if(pin==pincode){screenlock(!1);screenlock("activate");$pin.attr("title","🔒 請輸入 Pin 碼")}
else{$pin.attr("title","🔒 Pin 碼不正確");shake($pin)}}
else{if($sl.attr("pincode")==null){$sl.attr("pincode",pin);$pin.attr("title","🔒 再次確認 Pin 碼")}
else{if(pin==$sl.attr("pincode")){var r=update({action:"screenlock_setup",pincode:pin});setcookie("hearty_screenlock",pin,12);$sl.data("pincode",pin).attr("pincode",null);$pin.attr("title","請輸入 Pin 碼");screenlock(!1);hj_alert("🔒 Pin 碼設定為："+pin);hj_mixpanel("Screenlock Setup");ga_event_push("Screenlock",{event_category:"Screenlock",event_label:"Setup"})}
else{$sl.attr("pincode",null);$pin.attr("title","🔒 兩次輸入不一樣，請重設");shake($pin)}}}
$sl.find("input:first").focus()}}
function feature_notavailable(feature){popup_toggle(!0,"feature_notavailable");$(".popup.feature_notavailable q").text(feature);$(".popup.feature_notavailable").finish().delay(2500).queue(function(){popup_toggle(!1,"feature_notavailable");$(this).dequeue()})}
function pricing(){price_selector(4);popup_toggle(!1,"upgrade");popup_toggle(!0,"purchase")}
function price_selector(pkg_id){var pkg={1:{unit:179,subtotal:179},3:{unit:149,subtotal:894},4:{unit:109,subtotal:1308}};if(pkg_id in pkg){pkg=pkg[pkg_id];$(".purchase .price_unit").text(numberWithCommas(pkg.unit));$(".purchase [data-subtotal]").attr({"data-subtotal":numberWithCommas(pkg.subtotal)});$(".purchase .package[data-col='deposit'] .btns_action[data-pkg]").attr({"data-pkg":pkg_id,});$(".price_selector li").removeAttr("data-active").filter("[data-pkg='"+pkg_id+"']").attr("data-active","")}
$(".purchase .btns_action[data-pkg]").attr({"data-vat":user_country()=="TW"?1:0})}
function numberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}
function hj_picture(){if(/^(?=.*?Android)(?=.*?Hearty\/)/i.test(navigator.userAgent||"")){msg("Android App 即將支援相片上傳，敬請稍待<br>在此之前，建議先行使用網頁版上傳");return!1}
$(".ajax-upload-dragdrop input[type='file']").attr({accept:"image/jpeg",onchange:"hj_uploader_preview(this.files);"}).get(0).click()}
function image_uploader_initialize(){var $e=$(".bk-page #editor_editable"),$u=$(".img_uploader");$u.find("#mulitplefileuploader").uploadFile({url:"//"+window.location.hostname+"/sync",dragDrop:!0,fileName:"myfile",allowedTypes:"jpg,jpeg",returnType:"json",showDone:!1,showDelete:!1,formData:{category:1},dynamicFormData:function(){return{post_id:current_post()["post_id"],privacy:current_post()["privacy"]}},onSubmit:function(files){saved(!1)},onSuccess:function(files,data,xhr){illustration_show(data.gallery_id);alertify.success("相片已上傳");post_revise();hj_mixpanel("Image Added",{post_id:current_post()["post_id"],privacy:current_post()["privacy"]});ga_event_push("Image Added",{event_category:"Posts",event_label:"Image Added"})},onError:function(files,status,errMsg,pd){msg()}})}
function hj_uploader_preview(f){hj_video("reset");var $i=$(".image-zoom img"),[file]=f,p1=hj_uploader_createImageFromFile($i.get(0),file),p2=hj_uploader_getFileBase64Encode(file);Promise.all([p1,p2]).then(result=>{var[img,b64]=result;$(".bk-page .picture #picture").css({background:"url('"+b64+"')","background-size":"cover"}).addClass("uploading");$i.attr("src",b64)})}
function hj_uploader_createImageFromFile(img,file){return new Promise((resolve,rejfect)=>{img.src=URL.createObjectURL(file);img.onload=()=>{URL.revokeObjectURL(img.src);resolve(img)};img.onerror=()=>reject("Failure to load image")})}
function hj_uploader_getFileBase64Encode(blob){return new Promise((resolve,reject)=>{var reader=new FileReader();reader.readAsDataURL(blob);reader.onload=()=>resolve(reader.result);reader.onerror=error=>reject(error)})}
function hj_loading(on){if(on)$("body.hj").addClass("loading");else $("body.hj").removeClass("loading")}
function hj_screenshot(){autosave_the_change();hj_loading(!0);hj_getScript("//cdn.jsdelivr.net/npm/html2canvas@1.0.0-alpha.12/dist/html2canvas.min.js",function(){var post_id=current_post()["post_id"],$pg=$(".bk-list .bk-page"),$e=$pg.find(".diary"),$d=$(".diary_screenshot");$e.addClass("screenshoted");$pg.find("#editor_editable").removeClass("editor_margin_bottom");$pg.find(".picture .far").hide();window.html2canvas($e.get(0),{useCORS:!0,scale:window.devicePixelRatio,width:$e.get(0).offsetWidth+10,height:$e.get(0).offsetHeight}).then((c)=>{var b64=c.toDataURL("image/png"),subject=$pg.find("#subject").text();$d.empty();$("<a>",{target:"_blank",href:b64,download:"溫度日記_"+subject+".png",title:"下載："+subject}).html($("<img>",{src:b64})).appendTo($d).get(0).click();$e.removeClass("screenshoted");$pg.find("#editor_editable").removeClass("editor_margin_bottom");$pg.find(".picture .far").show();popup_toggle(!0,"diary_screenshot");hj_loading(!1);hj_mixpanel("Post Screenshoted",{post_id:post_id});ga_event_push("Screenshot",{event_category:"Posts",event_label:"Screenshot"})})})}
function hj_bookmark(){var post_id=current_post()["post_id"],r=update({action:"bookmark",post_id:post_id});if(!r)return!1;switch(r.Status){case 1:hj_mixpanel("Post Bookmarked",{post_id:post_id});ga_event_push("Bookmark",{event_category:"Posts",event_label:"Bookmark"});break;case 2:signin_required();break}}
function free_trial_activate(){var r=update({action:"free_trial_activate"});switch(r.Status){case 1:alertify.set({labels:{ok:"開始體驗",cancel:"比較版本"},buttonReverse:!1});alertify.confirm("<i class='far fa-gift-card'></i> 您專屬的 VIP 30天試用開啟囉，<br>"+r.Values.expiration+"前可使用所有功能、素材 <i class='far fa-heart'></i>",function(e){if(!e)popup_toggle(!0,"upgrade")});hj_mixpanel("Trial Activated");ga_event_push("Trial Activate",{event_category:"Account",event_label:"Trial Activate"});break}
return r.Status===1}
function signin_required(){alertify.set({labels:{ok:"立即登入",cancel:"否"}});alertify.confirm("登入以使用完整功能",function(e){if(e)window.location.href="https://hearty.me/?r="+window.location.href.replace(window.location.origin,"")+"#signin"});var r=update({action:"account_status"});if(!!r&&r.Status===1)window.location.reload(!0)}
function bucket_suffix(){var d=new Date();return d.getDate()+d.getHours()}
function illustration_show(gallery_id){var $i=$(".image-zoom img");var i;if(gallery_id===null){do{i=illustration_random();i.image=["//"+wpCDN+"/hearty.me/images/illustrations/"+i.image+".jpg","//"+wpCDN+"/ftp.hearty.me/images/illustrations/"+i.image+".jpg","//res.cloudinary.com/nien/image/upload/v1475732434/hearty.me/illustrations/"+i.image+".jpg"]}
while($i.attr("src")==i.image);}
else{i={image:["//hearty.me/i/"+gallery_id],position:"center"}}
$i.attr("src",i.image[0]);$(".bk-page .picture #picture").css({"background-image":i.image.map(function(v){return'url("'+v+'")'}).join(", "),"background-repeat":"no-repeat","background-position":i.position+" center","background-size":"cover"}).removeClass("uploading");return i.image[0]}
function capitalizeFirstLetter(str){return str.charAt(0).toUpperCase()+str.slice(1)}<!--[if!IE]><!-->window.onerror=function(msg,url,lineNo,colNo,err){var err_script=msg.toLowerCase().indexOf("script error")>-1;if("sendBeacon" in navigator)navigator.sendBeacon("//hearty.me/err",JSON.stringify({user:window.hj_user||"",uri:url.replace(window.location.origin,"")||"",msg:msg,err:err,line:lineNo,col:colNo,ua:navigator.userAgent||""}));if(!getUrlPara("refreshed")&&confirm("😵 因網路關係，日記本未能完整載入，是否重試呢？")){var u=new URL(window.location);u.searchParams.set("refreshed",1);window.location.href=u.href}};<!--<![endif]-->