function signin_ask(e){var a=getcookie("hearty_account")||"";a=a?"&account="+a:"";var t="//hearty.me/?r="+window.location.href.split("?")[0].replace(window.location.origin,"")+a+"#signin";e?window.top.location.href=t:(alertify.set({labels:{ok:"否",cancel:"<i class='fas fa-door-open'></i> 立即登入"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-user-lock'></i> 登入以使用完整功能",function(e){e||(window.top.location.href=t)}))}function account_area_calc(){$(".account").height($(document).height()-$(".nav_toggle_account").height()),nav_toggle_account(0)}function hj_upload(){var e=$(".ajax-upload-dragdrop input[type='file']");e.length>0&&e.attr({accept:"image/jpeg",onchange:"uploader_handle(this.files)"}).get(0).click()}function birthday_init(){var e=$("#birthday");(new Date).toJSON().slice(0,10);(check_OS("iOS")||check_browser("Safari"))&&e.attr({type:"text",onclick:"$(this).datepicker('show').select()",readonly:""}).datepicker({changeYear:!0,changeMonth:!0,dateFormat:"yy-mm-dd",showAnim:"slideDown",minDate:e.attr("min")||"",maxDate:e.attr("max")||"",showButtonPanel:!0})}function birthday_editing(e){hj_update({action:"profile_update",field:"birthday",data:e}).then(function(e){switch(e.Status){case 1:alertify.success("<i class='far fa-birthday-cake'></i> 生日已更新"),hj_mixpanel("Profile Update",{action:"Birthday"}),ga_event_push("Birthday",{event_category:"Profile Update",event_label:"Birthday"});break;default:msg()}}).fail(function(){msg()}),$("#age").text((new Date).getFullYear()-Number((e||"2019").substring(0,4)))}function password_editing(e){if(1==$("[data-email-verify='0']").length)return msg("<i class='far fa-envelope-open'></i> 需先認證 Email，才能變更密碼"),!1;alertify.set({labels:{ok:"<i class='fas fa-lock'></i> 更改",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='far fa-key'></i> "+(e||"請輸入新密碼"),function(e,a){if(e){if(a.length<6||a.length>20)return password_editing("密碼格式：6 ~ 20 字元，請重新輸入"),alertify_input_shake(),!1;alertify.set({labels:{ok:"<i class='fas fa-lock'></i> 確認更改",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='far fa-key'></i> 再次輸入，以設置新密碼",function(e,t){e&&(a==t?hj_update({action:"profile_update",field:"password",data:a}).then(function(e){switch(e.Status){case 1:msg("<i class='fas fa-check-circle'></i> 密碼已修改，下次登入請使用新密碼"),$(".account_btn[data-password]").attr({"data-password":1,title:"已變更"}),hj_mixpanel("Profile Update",{action:"Password"}),ga_event_push("Password",{event_category:"Profile Update",event_label:"Password"});break;default:msg()}}).fail(function(){msg()}):(password_editing("兩次輸入不一樣，請重新輸入"),alertify_input_shake()))},""),alertify_input_custom({type:"password",placeholder:"再輸入一次",autocomplete:"new-password",maxlength:20},{"letter-spacing":"2px"})}},""),alertify_input_custom({type:"password",placeholder:"6 ~ 20 字之間",autocomplete:"new-password",maxlength:20},{"letter-spacing":"2px"})}function initialize_uploader(){$("#mulitplefileuploader").uploadFile({url:window.location.origin+"/update",dragDrop:!0,fileName:"myfile",allowedTypes:"jpg,jpeg",returnType:"json",showDelete:!1,formData:{category:0,privacy:9},onSuccess:function(e,a,t){var i="//hearty.me/uploads/images/users/"+a.basenames[0];$("#profile_image img").attr({src:i}),$(".user").css({background:'url("'+i+'") no-repeat'}),alertify.success("<i class='far fa-address-card'></i> 大頭貼已更新")},onError:function(e,a,t,i){msg()}})}function uploader_handle(e){var a=$("#profile_image img"),[t]=e,i=uploader_createImageFromFile(a.get(0),t),n=uploader_getFileBase64Encode(t);Promise.all([i,n]).then(e=>{var[t,i]=e;a.attr("src",i)})}function uploader_createImageFromFile(e,a){return new Promise((t,i)=>{e.src=URL.createObjectURL(a),e.onload=(()=>{URL.revokeObjectURL(e.src),t(e)}),e.onerror=(()=>i("Failure to load image."))})}function uploader_getFileBase64Encode(e){return new Promise((a,t)=>{var i=new FileReader;i.readAsDataURL(e),i.onload=(()=>a(i.result)),i.onerror=(e=>t(e))})}function hj_upload(){var e=$(".ajax-upload-dragdrop input[type='file']");e.length>0&&e.attr({accept:"image/jpeg",onchange:"uploader_handle(this.files)"}).get(0).click()}function nickname_editing(e){var a=$("#nickname"),t=$(".account_btn[data-nickname]");if(e)t.fadeIn();else{var i=a.val().trim();hj_update({action:"profile_update",field:"nickname",data:a.val().trim()}).then(function(e){switch(e.Status){case 1:alertify.success("<i class='far fa-user'></i> 暱稱改為「"+i+"」"),a.attr({placeholder:i}),t.fadeOut(),hj_mixpanel("Profile Update",{action:"Nickname"}),ga_event_push("Nickname",{event_category:"Profile Update",event_label:"Nickname"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})}}function email_editing(e){e=(e||$("[data-email]").attr("data-email")||"").toLowerCase(),alertify.set({labels:{ok:"<i class='fas fa-check-circle'></i> 確認並認證",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='far fa-envelope'></i> 輸入 Email",function(a,t){a&&(t=(t||"").trim().toLowerCase(),e==t?1==$("#email_resend[data-timeout='0']:visible").length&&email_verification(!1):/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,12}$/.test(t)&&!/@(hearty(\.(me|tw|app)|corp.com)|hj\.rs|ht\.mk|(|chen)nien\.(co(m|)|org))/.test(t)?(alertify.set({labels:{ok:"是的",cancel:"取消"},buttonReverse:!1}),alertify.confirm("確認修改 Email 為「"+t+"」？",function(e){e&&hj_update({action:"profile_update",field:"email",data:t}).then(function(e){switch(e.Status){case 1:email_verification(),$("[data-email-verify]").attr("data-email-verify",0).find("[data-email]").attr("data-email",t),hj_mixpanel("Profile Update",{action:"Email"}),ga_event_push("Email",{event_category:"Profile Update",event_label:"Email"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})})):(msg("<i class='fas fa-times'></i> Email 格式不正確"),email_editing(t)))},e),alertify_input_custom({type:"email",placeholder:e||"eg. nien@heartycorp.com",maxlength:64})}function email_verification(e){if(e)alertify.set({labels:{ok:"是的",cancel:"否"},buttonReverse:!1}),alertify.confirm("<i class='far fa-envelope'></i> 確認要重寄認證信嗎？",function(e){e&&email_verification(!1)});else{var a=$("[data-email-verify]");hj_update({action:"email_verification"}).then(function(e){switch(e.Status){case 1:hj_timer(a.find("#email_resend"),!0),a.attr("data-email-verify",0);var t=e.Values.email_login_url;t.length>0?(alertify.set({labels:{ok:"走吧！",cancel:"先不用"},buttonReverse:!1}),alertify.confirm("<i class='far fa-envelope-open-text'></i> 認證信已寄出，要到 "+t[0]+" 收信嗎？<br>(請同時檢查垃圾信匣)",function(e){e&&open_url("//"+t[1])})):msg("<i class='fas fa-mailbox'></i> 麻煩前往收信，同時檢查垃圾信匣","好"),hj_mixpanel("Profile Update",{action:"Email Sent"}),ga_event_push("Email Sent",{event_category:"Profile Update",event_label:"Email Sent"});break;case 2:signin_required();break;case 3:msg("<i class='far fa-mobile'></i> 已認證過囉"),a.attr("data-email-verify",1);break;default:msg()}}).fail(function(){msg()})}}function gender_editing(e){hj_update({action:"profile_update",field:"gender",data:e}).then(function(a){1==a.Status&&(alertify.success("<i class='far fa-"+("1"==e?"mars":"venus")+"'></i> 性別已更新"),hj_mixpanel("Profile Update",{action:"Gender"}),ga_event_push("Gender",{event_category:"Profile Update",event_label:"Gender"}))}).fail(function(){msg()})}function newsletter(e){hj_update({action:"profile_update",field:"newsletter",data:e}).then(function(e){1==e.Status&&(alertify.success("<i class='far fa-mailbox'></i> 電子報訂閱已更新"),hj_mixpanel("Profile Update",{action:"Newsletter"}),ga_event_push("Newsletter",{event_category:"Profile Update",event_label:"Newsletter"}))}).fail(function(){msg()})}function accountkit_init(){var e=(navigator.language||"").replace("-","_");accountkit_ui_languages().indexOf(e)<0&&(e="en_US"),hj_getScript("//sdk.accountkit.com/"+e+"/sdk.js",function(){window.AccountKit&&(window.AccountKit_OnInteractive=function(){AccountKit.init({appId:0x60715e7e0baa,state:"hj_"+timestamping(),version:"v1.0",fbAppEventsEnabled:!0,redirect:"https://hearty.me/account",display:check_hjapp()?"modal":"popup"})},getUrlPara("pv")&&1==$("[data-phone-verify='0']").length&&$.wait(900).then(phone_verification))}).fail(function(){hj_mixpanel("AccountKit_Not_Loaded"),ga_event_push("AccountKit_Not_Loaded",{event_category:"Profile Update",event_label:"AccountKit_Not_Loaded"})})}function accountkit_ui_languages(){return["af_ZA","ar_AR","bn_IN","my_MM","zh_CN","zh_HK","zh_TW","hr_HR","cs_CZ","da_DK","nl_NL","en_GB","en_US","fi_FI","fr_FR","de_DE","el_GR","gu_IN","he_IL","hi_IN","hu_HU","id_ID","it_IT","ja_JP","ko_KR","cb_IQ","ms_MY","ml_IN","mr_IN","nb_NO","pl_PL","pt_BR","pt_PT","pa_IN","ro_RO","ru_RU","sk_SK","es_LA","es_ES","sw_KE","sv_SE","tl_PH","ta_IN","te_IN","th_TH","tr_TR","ur_PK","vi_VN"]}function phone_verification(e,a){window.AccountKit?AccountKit.login("PHONE",{countryCode:"+"+(a||$("[data-phone-cc]").attr("data-phone-cc")||"886"),phoneNumber:e||""},phone_verification_callback):hj_lang_zhcn()&&msg("<i class='far fa-exclamation-circle'></i> 糟了，有一堵牆<br>手機認證功能，無法在中國境內使用"," Σヽ(ﾟД ﾟ; )ﾉ ")}function phone_verification_callback(e){switch(e.status||""){case"PARTIALLY_AUTHENTICATED":hj_update({action:"phone_verification",authcode:e.code}).then(function(e){var a=e.Values;switch(e.Status){case 1:case 3:$("[data-phone-verify]").attr("data-phone-verify",1).children("div").attr({"data-phone-cc":a.cc,"data-phone-no":a.no,title:a.num}),alertify.success("<i class='far fa-mobile'></i> 手機已加入"),3==e.Status?msg("<i class='far fa-mobile'></i>「 "+a.num+"」曾綁於另一個溫度帳號，<br>已為您改綁到現在這組","好"):/8(1|86)|66/.test(a.cc)&&(alertify.set({labels:{ok:"好的",cancel:"否"}}),alertify.confirm("<i class='fab fa-line'></i> 加入溫度日記 Line，可收到生活裡的暖心故事",function(e){e&&open_url("//"+(check_hjapp()?"hearty.me/wv?o=":"")+"hearty.me/line")}));break;case 2:signin_ask();break;case 4:alertify.set({labels:{ok:"更改號碼",cancel:"取消"}}),alertify.confirm("<i class='far fa-mobile'></i>「 "+a.num+"」已設定為另一組溫度帳號的登入方式<br>無法重複綁定",function(e){e&&phone_verification()});break;default:msg()}}).fail(function(e){msg()});break;case"NOT_AUTHENTICATED":alertify.set({labels:{ok:"重試",cancel:"否"}}),alertify.confirm("<i class='far fa-surprise'></i> 手機認證未完成，是否重試",function(e){e&&phone_verification()});break;case"BAD_PARAMS":msg()}}function phone_editing_tw(e){e=e||$("[data-phone-tw]").attr("data-phone-tw")||"",alertify.set({labels:{ok:"<i class='far fa-check-circle'></i> 認證號碼",cancel:"取消"},buttonReverse:!1}),alertify.prompt("輸入"+(null==e?"你的":"新的")+"手機號碼（台灣）",function(a,t){a&&(e==t?1==$("#phone_resend[data-timeout='0']:visible").length&&phone_verification_tw(!0):/[0][9][0-9]{8}/.test(t||"")?hj_update({action:"profile_update",field:"phone",data:t}).then(function(e){switch(e.Status){case 1:phone_verification_tw(!0),$("[data-phone-verify-tw]").attr("data-phone-verify-tw",0).find("[data-phone-tw]").attr("data-phone-tw",t),hj_mixpanel("Profile Update",{action:"Phone"}),ga_event_push("Phone",{event_category:"Profile Update",event_label:"Phone"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()}):(msg("<i class='far fa-grin-beam-sweat'></i> 手機格式不正確，需為 09********","再試試",function(){alertify_input_shake()}),phone_editing_tw(t)))},e),alertify_input_custom({type:"tel",placeholder:e||"eg. 0903904568",maxlength:10},{"letter-spacing":"2px"})}function phone_verification_tw(e,a){var t=$("[data-phone-verify-tw]");e&&a?(alertify.set({labels:{ok:"是的",cancel:"否"},buttonReverse:!1}),alertify.confirm("<i class='far fa-sms'></i> 確認要重新寄送認證簡訊嗎？",function(e){e&&phone_verification_tw(!0)})):e?hj_update({action:"phone_verification_tw"}).then(function(e){switch(e.Status){case 1:phone_verification_tw(!1),hj_timer(t.find("#phone_resend"),!0),t.attr("data-phone-verify-tw",0),hj_mixpanel("Profile Update",{action:"SMS Sent"}),ga_event_push("SMS Sent",{event_category:"Profile Update",event_label:"SMS Sent"});break;case 2:signin_required();break;case 3:msg("<i class='fas fa-check-circle'></i> 已認證過囉"),t.attr("data-phone-verify-tw",1);break;default:msg()}}).fail(function(){msg()}):(alertify.set({labels:{ok:"認證",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='far fa-mobile'></i> 手機驗證碼",function(e,a){e&&((a=a.replace(/[^0-9]/g,"")).length?hj_update({action:"phone_verification_tw_response",code:a}).then(function(e){1==e.Status?(msg("<i class='fas fa-check-circle'></i> 手機完成認證"),t.attr("data-phone-verify-tw",1),hj_mixpanel("Profile Update",{action:"Phone Verify"}),ga_event_push("Phone Verify",{event_category:"Profile Update",event_label:"Phone Verify"})):(msg("<i class='fas fa-times'></i> 驗證碼不符"),phone_verification_tw(!1))}).fail(function(){msg()}):(phone_verification_tw(!1),alertify_input_shake()))},""),alertify_input_custom({type:"tel",placeholder:"eg. 123",maxlength:3,onkeyup:"if(this.value.length==3) $('#alertify-ok').click()"},{"letter-spacing":"3px"}))}function hj_timer(e,a,t){a?(hj_timer(e,!1),$.wait(1e3).then(function(){t=t||60,e.attr("data-timeout",t),function a(){if(Number(e.attr("data-timeout"))>0){var i=--t>0?parseInt(t%60,10).toString().padStart(2,"0"):"";t>0&&$.wait(1e3).then(a),e.attr("data-timeout",t).text(i)}}()})):e.attr("data-timeout",0).text("")}function support_pincode(e){hj_update({action:"support_pincode",reissue:+!(null==e)}).then(function(e){1==e.Status&&msg('<i class="far fa-comment-dots"></i> 客服 PIN 碼：'+e.Values.pincode+"<br>(聯繫時，提供這組數字可加快身份認證)")}).fail(function(){msg()})}function timezone_editing(e,a){hj_update({action:"profile_update",field:"timezone",data:e}).then(function(e){switch(e.Status){case 1:alertify.success("<i class='far fa-clock'></i> 時區設置為「"+a+"」"),hj_mixpanel("Profile Update",{action:"Timezone"}),ga_event_push("Timezone",{event_category:"Profile Update",event_label:"Timezone"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})}function username_editing(e){alertify.set({labels:{ok:"取消",cancel:"<i class='far fa-hashtag'></i> 申請修改"},buttonReverse:!1}),alertify.confirm("<i class='far fa-user-circle'></i> 您的溫度 ID 為："+e,function(e){e||(1==$("#email_resend[data-timeout='0']:visible").length?msg("<i class='fas fa-info-circle'></i> Email 通過驗證後，才能申請 ID 修改"):open_url("//go.hearty.me/JR3J9"))})}function nav_toggle_account(e){var a=$(".account");a.length>0&&($(".nav_toggle_account li").removeAttr("data-active").eq(e).attr("data-active",""),e=a.width()*(e||0),check_browser("Safari")?a.animate({scrollLeft:e},450):a.scrollLeft(e),a.children("div").scrollTop(0))}function export_txt(e){hj_loading(!0),hj_update({action:"account_status"}).then(function(a){1==a.Values.vip?(alertify.set({labels:{ok:"<i class='fas fa-lock'></i> 確認匯出",cancel:"否"},buttonReverse:!1}),alertify.prompt(e||"<i class='far fa-briefcase'></i> 備份前，請輸入溫度密碼：",function(e,a){if(e){if(a.length<6||a.length>20)return export_txt("<i class='far fa-key'></i> 密碼格式：6 ~ 20 字元，請重新輸入"),alertify_input_shake(),!1;var t=document.createElement("form"),i=document.createElement("input"),n=document.createElement("input");t.action="https://hearty.me/update",t.method="post",t.target="_self",i.value="export_txt",i.name="action",n.value=a,n.name="password",t.appendChild(i),t.appendChild(n),document.body.appendChild(t),t.submit(),alertify.success("<i class='far fa-arrow-to-bottom'></i> 開始備份")}hj_loading(!1)},""),alertify_input_custom({type:"password",placeholder:"6 ~ 20 字之間",autocomplete:"new-password",maxlength:20},{"letter-spacing":"2px"})):(alertify.set({labels:{ok:"晚點",cancel:"<i class='fas fa-star'></i> 立即升級"},buttonReverse:!0}),alertify.confirm("<i class='far fa-box-full'></i> 匯出備份，為 VIP 專屬功能",function(e){e||open_url("//hearty.me/d?plans=1")}),hj_loading(!1))}).fail(function(){msg(),hj_loading(!1)})}function account_buy(e){alertify.set({labels:{ok:"否",cancel:"<i class='fad fa-shopping-bag'></i> 立即"+(e?"續訂":"購買")},buttonReverse:!0}),alertify.confirm("<i class='far fa-store'></i> 溫度日記 VIP 方案 (現正優惠中)",function(e){e||open_url("//hearty.me/shop/buy?pkg=3")})}function hj_loading(e){e?$("body.hj").addClass("loading"):$("body.hj").removeClass("loading")}