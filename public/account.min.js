function account_init(){var e=getUrlPara("tab"),t=getUrlPara("msg");e&&nav_toggle_account(Number(e)),t&&msg("<i class='fal fa-info-circle'></i> "+decodeURIComponent(t)),getUrlPara("ev")?1==$("#email_resend[data-timeout='0']:visible").length&&email_editing():getUrlPara("pc")&&password_editing(),birthday_init(),initialize_uploader(),img_cdn_fallback(),account_area_calc(),window.addEventListener("resize",()=>{account_area_calc(),nav_toggle_account(0)},{passive:!0}),$(".mh-head .left").on("click",function(){nav_toggle($(".menu"),!0)}),$(".chat_btn").on("click",function(){hj_href("d?f=1")})}function signin_ask(e){var t=getcookie("hearty_account")||"";t=t?"&account="+t:"";var a="?r="+location.href.split("#")[0].split("?")[0].replace(location.origin,"")+t+"#signin";e?hj_href(a):(alertify.set({labels:{ok:"否",cancel:"<i class='fas fa-door-open'></i> 立即登入"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-user-lock'></i> 登入以使用完整功能",function(e){e||hj_href(a)}))}function account_area_calc(){$(".account").height($(document).height()-$(".nav_toggle_account").height())}function birthday_init(){var e=$("#birthday"),t=(new Date).getFullYear();(check_OS("iOS")||check_browser("Safari"))&&e.attr({type:"text",onclick:"$(this).datepicker('show').select()",readonly:""}).datepicker({changeYear:!0,changeMonth:!0,yearRange:t-70+":"+(t-7),yearSuffix:"年",dateFormat:"yy-mm-dd",showAnim:"slideDown",minDate:e.attr("min")||"",maxDate:e.attr("max")||"",showButtonPanel:!0}),birthday_age(),e.filter("[disabled]").parent().on("click",function(){msg("<i class='fal fa-birthday-cake'></i> 生日設置後無法更改<br>如不慎填錯，請聯繫客服")})}function birthday_editing(e){hj_update({action:"profile_update",field:"birthday",data:e}).then(function(e){switch(e.Status){case 1:alertify.success("<i class='far fa-birthday-cake'></i> 生日已更新"),hj_mixpanel("Profile Update",{action:"Birthday"}),ga_event_push("Birthday",{event_category:"Profile Update",event_label:"Birthday"});break;default:msg()}}).fail(function(){msg()}),birthday_age()}function birthday_age(){var e=parseInt((Date.now()-new Date($("#birthday").val()))/315576e5)||0,t=e>0&&e<16,a=$(".menu [data-btn='home'], .menu [data-btn='feed']");return $("#age").text(e),t?a.hide():a.show(),setcookie("hearty_children",t?1:0,7),e}function password_editing(e){if(1==$("[data-email-verify='0']").length)return msg("<i class='far fa-envelope-open'></i> 為保障帳號安全，需先認證 Email，才能變更密碼"),!1;alertify.set({labels:{ok:"<i class='fas fa-lock'></i> 更改",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='far fa-key'></i> "+(e||"請輸入主帳號的新密碼"),function(e,t){if(e){if(t.length<6||t.length>20)return password_editing("密碼格式：6 ~ 20 字元，請重新輸入"),alertify_input_shake(),!1;alertify.set({labels:{ok:"<i class='fas fa-lock'></i> 確認更改",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='far fa-key'></i> 再次輸入，以設置新密碼",function(e,a){e&&(t==a?hj_update({action:"profile_update",field:"password",data:t}).then(function(e){switch(e.Status){case 1:msg("<i class='fas fa-check-circle'></i> 密碼已修改，下次登入請使用新密碼"),$(".account_btn[data-password]").attr({"data-password":1,title:"已變更"}),hj_mixpanel("Profile Update",{action:"Password"}),ga_event_push("Password",{event_category:"Profile Update",event_label:"Password"});break;default:msg()}}).fail(function(){msg()}):(password_editing("兩次輸入不一樣，請重新輸入"),alertify_input_shake()))},""),alertify_input_custom({type:"password",placeholder:"再輸入一次",autocomplete:"new-password",minlength:6,maxlength:20},{"letter-spacing":"2px"})}},""),alertify_input_custom({type:"password",placeholder:"6 ~ 20 字之間",autocomplete:"new-password",minlength:6,maxlength:20},{"letter-spacing":"2px"})}function initialize_uploader(){$("#mulitplefileuploader").uploadFile({url:location.origin+"/update",dragDrop:!0,fileName:"myfile",allowedTypes:"jpg,jpeg",returnType:"json",showDelete:!1,formData:{category:0,privacy:9},onSuccess:function(e,t,a){var i="hearty.me/uploads/images/users/"+t.basenames[0];$("#profile_image img").attr({src:"//"+i}),$(".user").css({background:'url("//'+i+'") no-repeat'}),alertify.success("<i class='far fa-address-card'></i> 大頭貼已更新"),"sendBeacon"in navigator&&(navigator.sendBeacon("//i0.wp.com/"+i),navigator.sendBeacon("//cdn.statically.io/img/"+i))},onError:function(e,t,a,i){msg()}})}function uploader_handle(e){var t=$("#profile_image img"),[a]=e,i=uploader_createImageFromFile(t.get(0),a),n=uploader_getFileBase64Encode(a);Promise.all([i,n]).then(e=>{var[a,i]=e;t.attr("src",i)})}function uploader_createImageFromFile(e,t){return new Promise((a,i)=>{e.src=URL.createObjectURL(t),e.onload=(()=>{URL.revokeObjectURL(e.src),a(e)}),e.onerror=(()=>i("Failure to load image."))})}function uploader_getFileBase64Encode(e){return new Promise((t,a)=>{var i=new FileReader;i.readAsDataURL(e),i.onload=(()=>t(i.result)),i.onerror=(e=>a(e))})}function hj_picture(e){if(e)return alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-arrow-circle-up'></i> 上傳"},buttonReverse:!0}),void alertify.confirm("<i class='fal fa-image'></i> 請選擇一張 JPG 相片",function(e){e||hj_picture()});var t=$(".ajax-upload-dragdrop input[type='file']");t.length>0&&t.attr({accept:"image/jpeg",onchange:"hj_picture_onselect(this.files)"}).get(0).click()}function hj_picture_onselect(e){var t=e[0].name.toLowerCase().split(".").slice(-1).toString()||"";["jpg","jpeg"].indexOf(t)>=0?uploader_handle(e):(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-chevron-square-up'></i> 重新選擇"},buttonReverse:!0}),alertify.confirm("<i class='fal fa-image-polaroid'></i> 選的檔案為 "+t.toUpperCase()+"，只能上傳 JPG 圖片",function(e){e||hj_picture()}))}function nickname_editing(e){var t=$("#nickname"),a=$(".account_btn[data-nickname]");if(e)a.fadeIn();else{var i=t.val().trim();hj_update({action:"profile_update",field:"nickname",data:t.val().trim()}).then(function(e){switch(e.Status){case 1:alertify.success("<i class='far fa-user'></i> 暱稱改為「"+i+"」"),t.attr({placeholder:i}),a.fadeOut(),hj_mixpanel("Profile Update",{action:"Nickname"}),ga_event_push("Nickname",{event_category:"Profile Update",event_label:"Nickname"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})}}function email_editing(e){e=(e||$("[data-email]").attr("data-email")||"").toLowerCase(),alertify.set({labels:{ok:"<i class='fas fa-check-circle'></i> 確認並認證",cancel:"否"},buttonReverse:!1}),alertify.prompt("<i class='far fa-envelope'></i> 輸入 Email",function(t,a){t&&(a=(a||"").trim().toLowerCase(),e==a?1==$("#email_resend[data-timeout='0']:visible").length&&email_verification(!1):/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,12}$/.test(a)&&!/@(hearty(\.(me|tw|app)|corp.com)|hj\.rs|ht\.mk|(|chen)nien\.(co(m|)|org))/.test(a)?(alertify.set({labels:{ok:"是的",cancel:"取消"},buttonReverse:!1}),alertify.confirm("確認修改 Email 為「"+a+"」？",function(e){e&&hj_update({action:"profile_update",field:"email",data:a}).then(function(e){switch(e.Status){case 1:email_verification(),$("[data-email-verify]").attr("data-email-verify",0).find("[data-email]").attr("data-email",a),hj_mixpanel("Profile Update",{action:"Email"}),ga_event_push("Email",{event_category:"Profile Update",event_label:"Email"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})})):(msg("<i class='fas fa-times'></i> Email 格式不正確"),email_editing(a)))},e),alertify_input_custom({type:"email",placeholder:e||"eg. nien@heartycorp.com",maxlength:64})}function email_verification(e){if(e)alertify.set({labels:{ok:"是的",cancel:"否"},buttonReverse:!1}),alertify.confirm("<i class='far fa-envelope'></i> 確認要重寄認證信嗎？",function(e){e&&email_verification(!1)});else{var t=$("[data-email-verify]");hj_update({action:"email_verification"}).then(function(e){switch(e.Status){case 1:hj_timer(t.find("#email_resend"),!0),t.attr("data-email-verify",0);var a=e.Values.email_login_url;a.length>0?(alertify.set({labels:{ok:"走吧！",cancel:"先不用"},buttonReverse:!1}),alertify.confirm("<i class='far fa-envelope-open-text'></i> 認證信已寄出，要到 "+a[0]+" 收信嗎？<br>(請同時檢查垃圾信匣)",function(e){e&&(check_hjapp()?hj_href("wv?o="+a[1]):open_url("//"+a[1]))})):msg("<i class='fas fa-mailbox'></i> 麻煩前往收信，同時檢查垃圾信匣","好"),hj_mixpanel("Profile Update",{action:"Email Sent"}),ga_event_push("Email Sent",{event_category:"Profile Update",event_label:"Email Sent"});break;case 2:signin_required();break;case 3:msg("<i class='far fa-mobile'></i> 已認證過囉"),t.attr("data-email-verify",1);break;default:msg()}}).fail(function(){msg()})}}function gender_editing(e){hj_update({action:"profile_update",field:"gender",data:e}).then(function(t){1==t.Status&&(alertify.success("<i class='far fa-"+("1"==e?"mars":"venus")+"'></i> 性別已更新"),hj_mixpanel("Profile Update",{action:"Gender"}),ga_event_push("Gender",{event_category:"Profile Update",event_label:"Gender"}))}).fail(function(){msg()})}function newsletter(e){hj_update({action:"profile_update",field:"newsletter",data:e}).then(function(e){1==e.Status&&(alertify.success("<i class='fal fa-mailbox'></i> 電子報訂閱已更新"),hj_mixpanel("Profile Update",{action:"Newsletter"}),ga_event_push("Newsletter",{event_category:"Profile Update",event_label:"Newsletter"}))}).fail(function(){msg()})}function phone_verification(e,t){hj_href("p/phone.php?cc="+(t||"")+"&no="+(e||""))}function phone_editing_tw(e){e=e||$("[data-phone-tw]").attr("data-phone-tw")||"",alertify.set({labels:{ok:"<i class='far fa-check-circle'></i> 認證號碼",cancel:"取消"},buttonReverse:!1}),alertify.prompt("輸入"+(null==e?"你的":"新的")+"手機號碼（台灣）",function(t,a){t&&(e==a?1==$("#phone_resend[data-timeout='0']:visible").length&&phone_verification_tw(!0):/[0][9][0-9]{8}/.test(a||"")?hj_update({action:"profile_update",field:"phone",data:a}).then(function(e){switch(e.Status){case 1:phone_verification_tw(!0),$("[data-phone-verify-tw]").attr("data-phone-verify-tw",0).find("[data-phone-tw]").attr("data-phone-tw",a),hj_mixpanel("Profile Update",{action:"Phone"}),ga_event_push("Phone",{event_category:"Profile Update",event_label:"Phone"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()}):(msg("<i class='far fa-grin-beam-sweat'></i> 手機格式不正確，需為 09********","再試試",function(){alertify_input_shake()}),phone_editing_tw(a)))},e),alertify_input_custom({type:"tel",placeholder:e||"eg. 0903904568",maxlength:10},{"letter-spacing":"2px"})}function phone_verification_tw(e,t){var a=$("[data-phone-verify-tw]");e&&t?(alertify.set({labels:{ok:"是的",cancel:"否"},buttonReverse:!1}),alertify.confirm("<i class='far fa-sms'></i> 確認要重新寄送認證簡訊嗎？",function(e){e&&phone_verification_tw(!0)})):e?hj_update({action:"phone_verification_tw"}).then(function(e){switch(e.Status){case 1:phone_verification_tw(!1),hj_timer(a.find("#phone_resend"),!0),a.attr("data-phone-verify-tw",0),hj_mixpanel("Profile Update",{action:"SMS Sent"}),ga_event_push("SMS Sent",{event_category:"Profile Update",event_label:"SMS Sent"});break;case 2:signin_required();break;case 3:msg("<i class='fas fa-check-circle'></i> 已認證過囉"),a.attr("data-phone-verify-tw",1);break;default:msg()}}).fail(function(){msg()}):(alertify.set({labels:{ok:"認證",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='far fa-mobile'></i> 手機驗證碼",function(e,t){e&&((t=t.replace(/[^0-9]/g,"")).length?hj_update({action:"phone_verification_tw_response",code:t}).then(function(e){1==e.Status?(msg("<i class='fas fa-check-circle'></i> 手機完成認證"),a.attr("data-phone-verify-tw",1),hj_mixpanel("Profile Update",{action:"Phone Verify"}),ga_event_push("Phone Verify",{event_category:"Profile Update",event_label:"Phone Verify"})):(msg("<i class='fas fa-times'></i> 驗證碼不符"),phone_verification_tw(!1))}).fail(function(){msg()}):(phone_verification_tw(!1),alertify_input_shake()))},""),alertify_input_custom({type:"tel",placeholder:"eg. 123",maxlength:3,onkeyup:"if(this.value.length==3) $('#alertify-ok').click()"},{"letter-spacing":"3px"}))}function hj_timer(e,t,a){t?(hj_timer(e,!1),$.wait(1e3).then(function(){a=a||60,e.attr("data-timeout",a),function t(){if(Number(e.attr("data-timeout"))>0){var i=--a>0?parseInt(a%60,10).toString().padStart(2,"0"):"";a>0&&$.wait(1e3).then(t),e.attr("data-timeout",a).text(i)}}()})):e.attr("data-timeout",0).text("")}function support_pincode(e){hj_update({action:"support_pincode",reissue:+!(null==e)}).then(function(e){1==e.Status&&msg('<i class="far fa-comment-dots"></i> 客服 PIN 碼：'+e.Values.pincode+"<br><small>(聯繫時，提供這組數字，以加速身份認證)</small>","<i class='fas fa-hand-peace'></i> 好的",function(){var e=$("#Smallchat iframe");e.length>0&&!is_touch_device()&&e.contents().find(".Launcher").click()})}).fail(function(){msg()})}function post_font_change(e,t){post_font(e),hj_update({action:"profile_update",field:"post_font",data:e}).then(function(e){switch(e.Status){case 1:alertify.success("字體改成「<i class='far fa-font-case'></i> "+t+"」"),hj_mixpanel("Profile Update",{action:"Post_Font"}),ga_event_push("Post_Font",{event_category:"Profile Update",event_label:"Post_Font"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})}function timezone_editing(e,t){hj_update({action:"profile_update",field:"timezone",data:e}).then(function(e){switch(e.Status){case 1:alertify.success("<i class='far fa-clock'></i> 時區設置為「"+t+"」"),hj_mixpanel("Profile Update",{action:"Timezone"}),ga_event_push("Timezone",{event_category:"Profile Update",event_label:"Timezone"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})}function username_editing(e){alertify.set({labels:{ok:"<i class='fas fa-comment-dots'> 客服 PIN</i>",cancel:" <i class='fas fa-hand-peace'></i> 好的"},buttonReverse:!0}),alertify.confirm("<i class='fal fa-user-circle'></i> 溫度 ID："+e+"<br><small>(聯繫客服時，記得提供這組 ID)</small>",function(e){e&&support_pincode()})}function booktitle_editing(e){account_status().then(function(t){1==t.Values.vip?(alertify.set({labels:{ok:"<i class='fas fa-check-circle'></i> 取名",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='fal fa-book'></i> 我的日記本本叫作：",function(e,t){e&&(t=(t||"").trim()).length>0&&hj_update({action:"profile_update",field:"booktitle",data:t}).then(function(e){switch(e.Status){case 1:$("#hj_booktitle").text(t).attr({title:t}),alertify.success("<i class='fal fa-book'></i> 新書名「"+t+"」"),hj_mixpanel("Profile Update",{action:"BookTitle"}),ga_event_push("BookTitle",{event_category:"Profile Update",event_label:"BookTitle"});break;case 2:signin_required();break;default:msg()}}).fail(function(){msg()})},(e||"溫度日記").toString()),alertify_input_custom({placeholder:"eg. Alice 的日記小本本",maxlength:20},{"letter-spacing":"2px"})):vip_only("「自訂書名」")})}function nav_toggle_account(e){var t=$(".account");t.length>0&&($(".nav_toggle_account li").removeAttr("data-active").eq(e).attr("data-active",""),e=t.width()*(e||0),check_browser("Safari")?t.animate({scrollLeft:e},450):t.scrollLeft(e),t.children("div").scrollTop(0))}function export_txt(e){hj_loading(!0),account_status().then(function(t){if(1==t.Values.vip){if(is_touch_device())return msg("<i class='far fa-desktop'></i> 要下載日記備份檔，需使用電腦版<br>請在電腦上打開「www.hearty.me」"),hj_loading(!1),export_txt_stats("use_pc_instead"),!1;alertify.set({labels:{ok:"<i class='fas fa-lock'></i> 解密並匯出",cancel:"否"},buttonReverse:!1}),alertify.prompt(e||"<i class='far fa-briefcase'></i> 備份日記，請輸入溫度密碼以解密：",function(e,t){if(e){if(t.length<6||t.length>20)return export_txt("<i class='far fa-info-circle'></i> 密碼格式：6 ~ 20 字元，請重新輸入"),alertify_input_shake(),export_txt_stats("password_malformatted"),!1;var a=document.createElement("form"),i=document.createElement("input");a.action=location.origin+"/update",a.method="post",a.target="_self",i.value="export_txt",i.name="action",i.enctype="application/x-www-form-urlencoded",a.appendChild(i),(i=document.createElement("input")).value=t,i.name="password",a.appendChild(i),document.body.appendChild(a),a.submit(),alertify.success("<i class='far fa-arrow-to-bottom'></i> 開始備份"),$.wait(1500).then(function(){export_txt_stats("txt_exported"),hj_mixpanel("Posts Exported"),ga_event_push("Posts Exported",{event_category:"Posts",event_label:"Posts Exported"}),msg("<i class='fab fa-wpforms'></i> 已將日記解密並轉存文字檔，<br>敬請妥善保管","知道了，我會收好")})}$.wait(1e3).then(function(){hj_loading(!1)})},""),alertify_input_custom({type:"password",placeholder:"6 ~ 20 字之間",autocomplete:"new-password",minlength:6,maxlength:20},{"letter-spacing":"2px"})}else vip_only("「匯出備份」"),hj_loading(!1),export_txt_stats("notice_upgrade")}).fail(function(){msg(),hj_loading(!1)})}function export_txt_stats(e){return hj_update({action:"gform_post",uri:"1FAIpQLSfvmnOWgvwQfBjQIoJeH6EzxLUq62mwcRB7RQeODoWF1oC7Pg",data:$.param({emailAddress:"[hj_email]","entry.1537657449":"[hj_user_id]","entry.1470526977":"[hj_username]","entry.1332414907":e||"","entry.164417788":check_browser()+", "+check_OS(),"entry.657077146":(new Date).toISOString().split("T")[0]})})}function vip_only(e){alertify.set({labels:{ok:"稍後",cancel:"<i class='fas fa-star'></i> 升級享優惠"},buttonReverse:!0}),alertify.confirm("<i class='fal fa-box-full'></i> "+(e||"這")+"是 VIP 專屬功能",function(e){e||hj_href("d?plans=1")})}function account_suspend(){alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-ban'></i> 申請永久刪除"},buttonReverse:!1}),alertify.confirm("<i class='far fa-exclamation-triangle'></i> 不再使用溫度日記帳號",function(e){e||open_url("//docs.google.com/forms/d/e/1FAIpQLSfVJkAOUtBdmwXo6Hc7GBoCRnXBk41PRdcutHnHfgkrBBL3oA/viewform?embedded=true&emailAddress="+$("[data-email]").attr("data-email")+"&entry.537131775="+$("#hj_username").attr("title")+"&entry.1511837812="+check_browser()+", "+check_OS())})}function hj_loading(e){var t=$("body");e?t.addClass("loading"):t.removeClass("loading")}