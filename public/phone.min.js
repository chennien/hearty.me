"use strict";function phone_firebase_init(){window.firebase.auth().onAuthStateChanged(function(e){if(e){var a=$("#country-code").val()||886,i=e.phoneNumber.replace("+"+a,"");hj_update({action:"phone_verification_firebase",cc:a,no:i,token:e.uid}).then(function(t){switch(t.Status){case 1:case 3:hj_update({action:"gform_post",uri:"1FAIpQLSfW2spId3fWb_h31S4jXhv33Vjal-bHGGIAqtXETGhiqjFB0w",data:$.param({"entry.1182370364":"[hj_user_id]","entry.847068538":"[hj_username]",emailAddress:"[hj_email]","entry.1353731030":a,"entry.352107652":i,"entry.1205631750":e.uid,"entry.1460125899":(new Date).toISOString().split("T")[0],"entry.1757674378":navigator.userAgent||""})}),window.phone_firebase_result=null,firebase.auth().signOut().then(phone_firebase_verified).catch(function(e){msg(),location.reload(!0)});break;case 2:msg("<i class='far fa-exclamation-triangle'></i> 閒置時間長，您已經登出","<i class='fas fa-door-open'></i> 重新登入",function(){hj_href("?r="+location.href.split("#")[0].split("?")[0].replace(location.origin,"")+"#signin")});break;default:msg()}}).fail(msg),$("#phone-verify-firebase").hide()}}),window.recaptchaVerifier=new firebase.auth.RecaptchaVerifier("phone-firebase",{size:"invisible",callback:phone_firebase}),window.recaptchaVerifier.render().then(function(e){window.recaptchaWidgetId=e}).catch(phone_not_loaded)}function phone_firebase(){var e=$("#country-code").val()||886,a=$("#phone-no"),i=a.val()||"",t=window.recaptchaVerifier;if(i.length<3)return msg("<i class='far fa-exclamation-triangle'></i> 電話號碼太短了","好的",function(){shake(a.parent()),a.focus()}),resetReCaptcha(),!1;firebase.auth().signInWithPhoneNumber("+"+e+i,t).then(function(e){window.phone_firebase_result=e,phone_firebase_verify("",!0)}).catch(function(e){switch(e.code){case"auth/invalid-phone-number":msg("<i class='far fa-times'></i> 電話號碼格式不正確","好的",function(){shake(a),a.focus()});break;case"auth/too-many-requests":msg("<i class='far fa-exclamation-circle'></i> 申請認證太頻繁，請晚點再試<br>"+e.message);break;default:msg("<i class='far fa-exclamation-circle'></i> "+e.code+"<br>"+e.message)}resetReCaptcha()})}function phone_firebase_verify(e,a){var i=$("#phone-verify-firebase");if(!window.phone_firebase_result)return i.prop("disabled",!0).show(),!1;alertify.set({labels:{ok:"<i class='fas fa-check-circle'></i> 認證",cancel:"取消"},buttonReverse:!1}),alertify.prompt("<i class='far fa-mobile'></i> "+(a?"簡訊已寄送，請稍待 45秒<br>":"")+"手機驗證碼：",function(e,a){if(e){if((a=a||"").length<6)return msg("<i class='far fa-exclamation-circle'></i> 驗證碼須為 6位數字","重新輸入",phone_firebase_verify),!1;phone_firebase_result.confirm(a).then(function(e){e.user;msg("<i class='fas fa-check-circle'></i> 手機 "+$("#phone-no").val()+" 認證完成","太好了")}).catch(function(e){switch(e.code){case"auth/invalid-verification-code":msg("<i class='far fa-times'></i> 驗證碼不符合","重試",phone_firebase_verify);break;case"auth/code-expired":msg("<i class='far fa-times'></i> 驗證碼過期，請重新驗證<br>"+e.message),window.phone_firebase_result=null,i.hide();break;default:msg("<i class='far fa-exclamation-circle'></i> "+e.code+"<br>"+e.message)}})}},(e||"").toString()),alertify_input_custom({type:"tel",placeholder:"簡訊驗證碼",minlength:1,maxlength:6,onkeyup:"if(this.value.length==6) $('.alertify-button-ok').click();"},{"letter-spacing":"3px"}),i.removeAttr("disabled").show();var t=$("#phone-firebase");t.finish().prop("disabled",!0).text(t.attr("data-wait")).delay(3e4).queue(function(){$(this).removeAttr("disabled").text($(this).attr("data-text")).dequeue()}),is_touch_device()&&$("[data-unreceived]").delay(3e4).queue(function(){$(this).show().dequeue()})}function phone_not_loaded(){msg(hj_lang_zhcn()?"<i class='fal fa-signal-slash'></i> 在中国，谷歌国际简讯验证功能被牆了":"<i class='fal fa-exclamation-triangle'></i> 簡訊認證功能載入失敗<br>請嘗試刷新"," Σヽ(ﾟД ﾟ; )ﾉ ")}function resetReCaptcha(){"undefined"!=typeof grecaptcha&&void 0!==window.recaptchaWidgetId&&grecaptcha.reset(window.recaptchaWidgetId)}function phone_firebase_verified(){/8(1|86)|66/.test($("#country-code").val())?(alertify.set({labels:{ok:"否",cancel:"<i class='fas fa-hand-point-right'></i> 好的"},buttonReverse:!0}),alertify.confirm("<i class='fab fa-line'></i> 加入溫度 Line，可收到生活暖心故事",function(e){e||window.open("//"+(check_hjapp()?"hearty.me/wv?o=":"")+"hearty.me/line","_blank"),hj_href("account")})):hj_href("account")}function phone_manual_verify(e){alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-comment-alt-dots'></i> 傳簡訊"},buttonReverse:!0}),alertify.confirm("<i class='fal fa-question-circle'></i> 未能收到認證簡訊<br>傳送一封簡訊到溫度團隊的手機，將為您人工驗證",function(a){a||(location.href="sms:+886903904568"+(check_OS("iOS")?"&":"?")+"body=[手機認證] 溫度 ID："+(e||"")+" ",setTimeout(function(){msg("<i class='fal fa-info-circle'></i> 我們將於收到簡訊的 48小時內協助驗證","OK",function(){hj_href("account")})},7e3))})}Sentry.init({dsn:"https://a6cb9b2263814097b85a2170900e6d62@sentry.io/183684"}),Bugsnag.start({apiKey:"5c55b919bc2a4ed35ffa675c9341251c",appType:"client"}),$(function(){window.firebase?phone_firebase_init():phone_not_loaded(),$("[data-unreceived]").on("click",function(){phone_manual_verify(this.dataset.username)}),$("[data-goback]").on("click",function(){hj_href("account")})});