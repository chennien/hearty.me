var positioning_gps_deferred=$.Deferred();function positioning_gps_trigger(i,o){(i||"granted"==o)&&navigator.geolocation.getCurrentPosition(positioning_gps,positioning_gps_error_handling,{enableHighAccuracy:!0,maximumAge:1/0,timeout:1e4})}function positioning_gps(i){getcookie("hearty_position_gps").length||$.post(location.origin+"/positioning.php",{action:"positioning_gps",latitude:i.coords.latitude,longitude:i.coords.longitude,accuracy:i.coords.accuracy},function(i){window.positioning_gps_deferred.resolve(),"undefined"!=typeof gtag&&gtag("event","Positioning","Query GPS Data","Queued")})}function positioning_agps(){getcookie("hearty_position_agps").length||$.get(location.origin+"/ip",function(i){var o=i.trim();$.post(location.origin+"/positioning.php",{action:"positioning_agps",ip_addr:o},function(i){"undefined"!=typeof gtag&&gtag("event","Positioning","Query AGPS Data","Queued")})})}function positioning_agps_cloudflare(){getcookie("hearty_position_agps").length||$.get(location.origin+"/cdn-cgi/trace",function(i){var o=i.replace(/\n/gm," ").trim().split("ip=")[1].split(" ts=")[0];$.post(location.origin+"/positioning.php",{action:"positioning_agps",ip_addr:o},function(i){"undefined"!=typeof gtag&&gtag("event","Positioning","Query AGPS Data","Queued")})})}function positioning_agps_ipify(){if(!getcookie("hearty_position_agps").length){var i=$.ajax({url:"//api.ipify.org",type:"GET",crossDomain:!0,dataType:"text",async:!1,success:function(i){return $(i).selector}}).responseText;$.post("//"+location.hostname+"/positioning.php",{action:"positioning_agps",ip_addr:i},function(i){"undefined"!=typeof gtag&&gtag("event","Positioning","Query AGPS Data","Queued")})}}function positioning_gps_error_handling(i){window.positioning_gps_deferred.reject();var o="";switch(i.code){case i.PERMISSION_DENIED:o="Denied",alertify.error("<i class='fal fa-ban'></i> 您的裝置拒絕提供位置資訊");break;case i.POSITION_UNAVAILABLE:if(o="Unavailable",!getcookie("hearty_position_gps_unavailable").length){msg("<i class='fal fa-map-marker-alt-slash'></i> 您的裝置目前無法定位，請試著重新整理頁面");var e=new Date;e.setTime(e.getTime()+36e5),document.cookie="hearty_position_gps_unavailable=1;expires="+e+";domain=."+document.domain+";path=/"}break;case i.TIMEOUT:o="Timeout";break;default:o="Unknown Error"}"undefined"!=typeof gtag&&gtag("event","Positioning","Query GPS Data",o),$("body").removeClass("loading")}function positioning_gps_reset_support(){var i=(navigator.userAgent||"").toLowerCase(),o="support.google.com/chrome/answer/142065";switch(!0){case/chrome/.test(i):break;case/safari/.test(i):o="support.apple.com/HT20"+(/ip(ad|hone|od)/.test(i)?"7092":"4690");break;case/firefox/.test(i):o="support.mozilla.org/kb/does-firefox-share-my-location-websites";break;case/op(r|era)/.test(i):o="help.opera.com/geolocation";break;case/edg(e|)/.test(i):o="support.microsoft.com/help/4536154";break;case/trident/.test(i):o="support.microsoft.com/help/17479"}return"//"+o}navigator.geolocation&&"permissions"in navigator&&"query"in navigator.permissions&&navigator.permissions.query({name:"geolocation"}).then(function(i){positioning_gps_trigger(!1,i.state),i.onchange=function(){positioning_gps_trigger(!1,this.state)}}),positioning_agps();