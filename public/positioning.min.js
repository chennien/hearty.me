window.positioning_gps_deferred=$.Deferred();if(navigator.geolocation){if("permissions" in navigator&&"query" in navigator.permissions)
navigator.permissions.query({name:'geolocation'}).then(function(permissionStatus){positioning_gps_trigger(!1,permissionStatus.state);permissionStatus.onchange=function(){positioning_gps_trigger(!1,this.state)}})}positioning_agps();function positioning_gps_trigger(on,state){if(on||state=="granted"){navigator.geolocation.getCurrentPosition(positioning_gps,positioning_gps_error_handling,{enableHighAccuracy:!0,maximumAge:Infinity,timeout:10000})}}
function positioning_gps(position){if(!getcookie('hearty_position_gps').length){$.post("//"+window.location.hostname+"/positioning.php",{action:"positioning_gps",latitude:position.coords.latitude,longitude:position.coords.longitude,accuracy:position.coords.accuracy},function(callback){window.positioning_gps_deferred.resolve();if(typeof ga!=="undefined")ga('send','event','Positioning','Query GPS Data','Queued')})}}
function positioning_agps(){if(!getcookie("hearty_position_agps").length){$.get("//hearty.me/ip",function(raw){var ip_addr=raw.trim();$.post("//"+window.location.hostname+"/positioning.php",{action:"positioning_agps",ip_addr:ip_addr},function(callback){if(typeof ga!=="undefined")ga('send','event','Positioning','Query AGPS Data','Queued')})})}}
function positioning_agps_cloudflare(){if(!getcookie("hearty_position_agps").length){$.get("//hearty.me/cdn-cgi/trace",function(raw){var ip_addr=raw.replace(/\n/gm,' ').trim().split("ip=")[1].split(" ts=")[0];$.post("//"+window.location.hostname+"/positioning.php",{action:"positioning_agps",ip_addr:ip_addr},function(callback){if(typeof ga!=="undefined")ga('send','event','Positioning','Query AGPS Data','Queued')})})}}
function positioning_gps_error_handling(error){window.positioning_gps_deferred.reject();$('.loading_logo').fadeOut();switch(error.code){case error.PERMISSION_DENIED:console.warn("Denied");if(typeof ga!=="undefined")ga('send','event','Positioning','Query GPS Data','Denied');alertify.error("🚫 您的裝置拒絕提供位置資訊");break;case error.POSITION_UNAVAILABLE:console.warn("Unavailable");if(typeof ga!=="undefined")ga('send','event','Positioning','Query GPS Data','Unavailable');if(!getcookie("hearty_position_gps_unavailable").length){msg("📍 您的裝置目前無法定位，請試著重新整理頁面");var exp=new Date();exp.setTime(exp.getTime()+(60*60*1000));document.cookie="hearty_position_gps_unavailable=1;expires="+exp+';domain=.'+document.domain+';path=/'}
break;case error.TIMEOUT:console.warn("Timeout");if(typeof ga!=="undefined")ga('send','event','Positioning','Query GPS Data','Timeout');break;case error.UNKNOWN_ERROR:console.warn("Unknown Error");if(typeof ga!=="undefined")ga('send','event','Positioning','Query GPS Data','Unknown Error');break}}
function positioning_gps_reset_support(){var ua=navigator.userAgent.toLowerCase(),url='//support.google.com/chrome/answer/142065';switch(!0){case ua.indexOf('chrome')>-1:url='//support.google.com/chrome/answer/142065';break;case ua.indexOf('safari')>-1:url=/ipad|iphone|ipod/.test(ua)&&!window.MSStream?'//support.apple.com/HT207092':'//support.apple.com/HT204690';break;case ua.indexOf('firefox')>-1:url='//www.mozilla.org/firefox/geolocation';break;case ua.indexOf('opr')>-1||ua.indexOf('opera')>-1:url='//help.opera.com/geolocation';break;case ua.indexOf('Edge')>-1:url='//privacy.microsoft.com/windows-10-location-and-privacy';break;case ua.indexOf('Trident')>-1:url='//support.microsoft.com/help/17479/windows-internet-explorer-11-change-security-privacy-settings';break}
return url}